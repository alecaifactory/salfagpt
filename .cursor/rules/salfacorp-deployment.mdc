# SalfaCorp Deployment Rules - Flow Platform

## üéØ Purpose

This rule documents the deployment configuration and process for the SalfaCorp production environment, ensuring correct service, region, and project settings for all deployments.

---

## üö® CRITICAL: Production Deployment Configuration

### Service Information

**Production Service Name:** `cr-salfagpt-ai-ft-prod`  
**Region:** `us-east4` (NOT us-central1, NOT us-east1)  
**Project:** `salfagpt`  
**URL:** https://cr-salfagpt-ai-ft-prod-3snj65wckq-uk.a.run.app

### Development/Testing Services

**Development Service:** `salfagpt`  
**Region:** `us-central1`  
**URL:** https://salfagpt-3snj65wckq-uc.a.run.app

**Other Services (for reference):**
- `flow-chat` - us-central1
- `flow-production` - us-central1
- `flow-salfacorp` - us-central1
- `salfagpt-chat` - us-central1
- `salfagpt-production` - us-central1

---

## üìã Deployment Commands

### ‚úÖ CORRECT Production Deployment

```bash
# ALWAYS use this command for SalfaCorp production
gcloud run deploy cr-salfagpt-ai-ft-prod \
  --source . \
  --platform managed \
  --region us-east4 \
  --project salfagpt \
  --allow-unauthenticated
```

### ‚ùå WRONG - Common Mistakes

```bash
# ‚ùå Wrong service name
gcloud run deploy salfagpt --region us-east4

# ‚ùå Wrong region (us-central1 is for dev/test)
gcloud run deploy cr-salfagpt-ai-ft-prod --region us-central1

# ‚ùå Wrong region (us-east1 doesn't have the service)
gcloud run deploy cr-salfagpt-ai-ft-prod --region us-east1

# ‚ùå Wrong project
gcloud run deploy cr-salfagpt-ai-ft-prod --region us-east4 --project gen-lang-client-0986191192
```

---

## üîç Pre-Deployment Checklist

### BEFORE Deploying to Production

**1. Verify Git Status**
```bash
# Check branch
git branch --show-current  # Should be: main

# Check for uncommitted changes
git status --short  # Should be clean

# Verify latest commit
git log --oneline -1
```

**2. Verify Project Configuration**
```bash
# Check .env file
cat .env | grep GOOGLE_CLOUD_PROJECT
# Should show: GOOGLE_CLOUD_PROJECT=salfagpt

# Check gcloud configuration
gcloud config get-value project
# Should show: salfagpt
```

**3. Verify Service Existence**
```bash
# Confirm service exists in correct region
gcloud run services describe cr-salfagpt-ai-ft-prod \
  --project=salfagpt \
  --region=us-east4 \
  --format="value(status.url)"
  
# Should return: https://cr-salfagpt-ai-ft-prod-3snj65wckq-uk.a.run.app
```

**4. Run Local Tests**
```bash
# Type check
npm run type-check

# Lint (optional, may have pre-existing warnings)
# npm run lint

# Build locally to catch errors
npm run build

# Test locally
npm run dev
# Visit http://localhost:3000/chat and verify changes
```

---

## üöÄ Deployment Process

### Step-by-Step Deployment

```bash
# 1. Ensure you're in the project directory
cd /Users/alec/salfagpt

# 2. Commit all changes (if not already done)
git add -A
git commit -m "feat: Your feature description"

# 3. Push to remote
git push origin main

# 4. Deploy to production service in us-east4
gcloud run deploy cr-salfagpt-ai-ft-prod \
  --source . \
  --platform managed \
  --region us-east4 \
  --project salfagpt \
  --allow-unauthenticated

# 5. Verify deployment
curl -I https://cr-salfagpt-ai-ft-prod-3snj65wckq-uk.a.run.app/

# 6. Test in browser
# Navigate to: https://cr-salfagpt-ai-ft-prod-3snj65wckq-uk.a.run.app/chat
```

---

## üìä Service Configuration

### Environment Variables

**Required for Production:**
```bash
GOOGLE_CLOUD_PROJECT=salfagpt
GOOGLE_AI_API_KEY=<from-secret-manager>
JWT_SECRET=<from-secret-manager>
GOOGLE_CLIENT_ID=<oauth-client-id>
GOOGLE_CLIENT_SECRET=<oauth-client-secret>
PUBLIC_BASE_URL=https://cr-salfagpt-ai-ft-prod-3snj65wckq-uk.a.run.app
NODE_ENV=production
```

**Set Environment Variables:**
```bash
gcloud run services update cr-salfagpt-ai-ft-prod \
  --region us-east4 \
  --project salfagpt \
  --update-env-vars="PUBLIC_BASE_URL=https://cr-salfagpt-ai-ft-prod-3snj65wckq-uk.a.run.app,NODE_ENV=production"
```

### Service Settings

**Platform:** Google Cloud Run  
**Build Method:** Source-based (Dockerfile)  
**Traffic:** 100% to latest revision  
**Authentication:** Allow unauthenticated (OAuth handled internally)

---

## üîê OAuth Configuration

### Authorized Redirect URIs

**Production:**
```
https://cr-salfagpt-ai-ft-prod-3snj65wckq-uk.a.run.app/auth/callback
```

**Development:**
```
http://localhost:3000/auth/callback
https://salfagpt-3snj65wckq-uc.a.run.app/auth/callback
```

**Configure in Google Cloud Console:**
1. Navigate to: https://console.cloud.google.com/apis/credentials
2. Select project: `salfagpt`
3. Edit OAuth 2.0 Client ID
4. Add production URL to Authorized redirect URIs
5. Save

---

## üß™ Post-Deployment Verification

### Quick Health Check

```bash
# 1. Check HTTP status
curl -I https://cr-salfagpt-ai-ft-prod-3snj65wckq-uk.a.run.app/

# 2. Check if service is running
gcloud run services describe cr-salfagpt-ai-ft-prod \
  --region us-east4 \
  --project salfagpt \
  --format="value(status.conditions[0].status)"
# Should return: True

# 3. Check latest revision
gcloud run services describe cr-salfagpt-ai-ft-prod \
  --region us-east4 \
  --project salfagpt \
  --format="value(status.latestReadyRevisionName)"
```

### Full Verification Checklist

- [ ] Service URL returns HTTP 200/302 (not 404/500)
- [ ] Login page loads correctly
- [ ] OAuth flow works
- [ ] Admin menu displays with 4 sections
- [ ] All icons render correctly
- [ ] Section colors match specification
- [ ] All modals/panels open correctly
- [ ] No console errors in browser

---

## üîÑ Rollback Procedure

### If Deployment Has Issues

```bash
# 1. List recent revisions
gcloud run revisions list \
  --service cr-salfagpt-ai-ft-prod \
  --region us-east4 \
  --project salfagpt \
  --limit 5

# 2. Rollback to previous revision
gcloud run services update-traffic cr-salfagpt-ai-ft-prod \
  --to-revisions=PREVIOUS_REVISION=100 \
  --region us-east4 \
  --project salfagpt

# Example:
# gcloud run services update-traffic cr-salfagpt-ai-ft-prod \
#   --to-revisions=cr-salfagpt-ai-ft-prod-00040-abc=100 \
#   --region us-east4 \
#   --project salfagpt
```

---

## üìù Deployment Tracking

### Current Production State

**Service:** cr-salfagpt-ai-ft-prod  
**Region:** us-east4  
**Latest Revision:** cr-salfagpt-ai-ft-prod-00041-xgc (as of 2025-11-04)  
**Previous Revision:** cr-salfagpt-ai-ft-prod-00040-* (rollback available)

### Deployment Log

**2025-11-04:**
- Revision: cr-salfagpt-ai-ft-prod-00041-xgc
- Changes: Admin menu reorganization (4 sections, improved icons)
- Commit: 7b87d96
- Build Time: ~4 minutes
- Status: ‚úÖ Success

---

## üö® Common Issues & Solutions

### Issue 1: 404 on Root Path

**Symptom:** `curl https://cr-salfagpt-ai-ft-prod-3snj65wckq-uk.a.run.app/` returns 404

**Cause:** Astro routing - root path may not be configured

**Solution:** Use proper routes:
- Chat: `/chat`
- Admin: `/admin`
- Analytics: `/analytics`

### Issue 2: Wrong Region Error

**Symptom:** `Cannot find service [cr-salfagpt-ai-ft-prod]` when deploying

**Cause:** Using wrong region (us-east1 or us-central1)

**Solution:** Always use `--region us-east4`

### Issue 3: OAuth Redirect Mismatch

**Symptom:** OAuth error: `redirect_uri_mismatch`

**Cause:** Production URL not in authorized redirect URIs

**Solution:** Add `https://cr-salfagpt-ai-ft-prod-3snj65wckq-uk.a.run.app/auth/callback` to OAuth settings

---

## üéØ Quick Reference

### Service Map

| Environment | Service Name | Region | URL |
|-------------|--------------|--------|-----|
| **Production** | cr-salfagpt-ai-ft-prod | us-east4 | https://cr-salfagpt-ai-ft-prod-3snj65wckq-uk.a.run.app |
| Development | salfagpt | us-central1 | https://salfagpt-3snj65wckq-uc.a.run.app |
| Local | - | - | http://localhost:3000 |

### One-Line Deploy Commands

```bash
# Production (SalfaCorp)
gcloud run deploy cr-salfagpt-ai-ft-prod --source . --region us-east4 --project salfagpt

# Development
gcloud run deploy salfagpt --source . --region us-central1 --project salfagpt
```

---

## üìö Related Documentation

### Internal Rules
- `.cursor/rules/deployment.mdc` - General deployment rules
- `.cursor/rules/gcp-project-consistency.mdc` - GCP project configuration
- `.cursor/rules/env.mdc` - Environment variables

### Deployment Guides
- `docs/LocalToProduction.md` - Complete deployment guide
- `DEPLOYMENT_SUCCESS_MENU_REORGANIZATION_2025-11-04.md` - Latest deployment

---

## ‚ö†Ô∏è Important Reminders

### ALWAYS Remember

1. ‚úÖ **Production service:** cr-salfagpt-ai-ft-prod
2. ‚úÖ **Production region:** us-east4 (NOT us-east1, NOT us-central1)
3. ‚úÖ **Project:** salfagpt
4. ‚úÖ **Commit first, then deploy**
5. ‚úÖ **Verify service URL after deployment**

### NEVER

1. ‚ùå Deploy to wrong service (salfagpt is dev, not prod)
2. ‚ùå Deploy to wrong region (us-central1 is dev)
3. ‚ùå Deploy without committing changes first
4. ‚ùå Deploy without testing locally
5. ‚ùå Deploy with uncommitted sensitive data (.env files)

---

## üîß Troubleshooting

### Service Not Found

```bash
# If you get "Cannot find service" error:

# 1. List all services
gcloud run services list --project=salfagpt

# 2. Check specific regions
for region in us-east1 us-east4 us-central1 europe-west2; do
  echo "Region: $region"
  gcloud run services list --project=salfagpt --region=$region
done

# 3. Verify you're using correct service name
# Production: cr-salfagpt-ai-ft-prod
# Development: salfagpt
```

### Build Failures

```bash
# Check build logs
gcloud builds list --project=salfagpt --limit=5

# View specific build
gcloud builds log BUILD_ID --project=salfagpt
```

### Deployment Timeout

```bash
# Increase timeout (if needed)
gcloud run deploy cr-salfagpt-ai-ft-prod \
  --source . \
  --region us-east4 \
  --project salfagpt \
  --timeout=300s \
  --memory=2Gi
```

---

## üìä Service Comparison

### Production vs Development

| Aspect | Production (cr-salfagpt-ai-ft-prod) | Development (salfagpt) |
|--------|-------------------------------------|------------------------|
| Region | us-east4 | us-central1 |
| Purpose | Live user traffic | Testing/staging |
| URL | cr-salfagpt-ai-ft-prod-3snj65wckq-uk.a.run.app | salfagpt-3snj65wckq-uc.a.run.app |
| Deploy Before | Production release | Testing features |
| Rollback | Required for issues | Optional |

---

## ‚úÖ Deployment Checklist Template

Use this checklist for every production deployment:

```markdown
## Deployment Checklist - [Date]

### Pre-Deployment
- [ ] All changes committed to git
- [ ] Changes pushed to origin/main
- [ ] Local testing complete
- [ ] No sensitive data in code
- [ ] Environment variables documented

### Deployment
- [ ] Service: cr-salfagpt-ai-ft-prod
- [ ] Region: us-east4
- [ ] Project: salfagpt
- [ ] Build: Successful
- [ ] Revision: Created

### Post-Deployment
- [ ] Service URL responding
- [ ] HTTP status acceptable (200/302)
- [ ] Login flow works
- [ ] Core features verified
- [ ] No console errors
- [ ] Performance acceptable

### Rollback Plan
- [ ] Previous revision ID noted
- [ ] Rollback command ready
- [ ] Monitoring active
```

---

## üéì Lessons Learned

### 2025-11-04: Menu Reorganization Deployment

**Issue:** Initially deployed to wrong service (salfagpt) and wrong region (us-central1)

**Root Cause:** 
- Service name confusion (multiple services exist)
- Region assumption (thought us-east1, actually us-east4)

**Solution:**
- Always verify service name: `cr-salfagpt-ai-ft-prod`
- Always verify region: `us-east4`
- Created this rule to document correct configuration

**Prevention:**
- This rule now documents correct service and region
- Pre-deployment checklist includes verification steps
- AI assistant will reference this rule for future deployments

---

## üîó Service URLs Quick Reference

```bash
# Production
https://cr-salfagpt-ai-ft-prod-3snj65wckq-uk.a.run.app

# Development  
https://salfagpt-3snj65wckq-uc.a.run.app

# Local
http://localhost:3000
```

---

## üìã AI Assistant Guidelines

### When User Requests Production Deployment

**ALWAYS:**
1. ‚úÖ Verify current git status
2. ‚úÖ Commit changes first
3. ‚úÖ Push to origin/main
4. ‚úÖ Use service: `cr-salfagpt-ai-ft-prod`
5. ‚úÖ Use region: `us-east4`
6. ‚úÖ Use project: `salfagpt`
7. ‚úÖ Verify deployment success
8. ‚úÖ Document deployment

**NEVER:**
1. ‚ùå Deploy to dev service (salfagpt)
2. ‚ùå Deploy to us-central1
3. ‚ùå Deploy without committing
4. ‚ùå Deploy with uncommitted .env changes
5. ‚ùå Skip verification step

---

## üéØ Summary

**Production Deployment Command:**
```bash
gcloud run deploy cr-salfagpt-ai-ft-prod \
  --source . \
  --region us-east4 \
  --project salfagpt
```

**Remember:**
- Service: `cr-salfagpt-ai-ft-prod` (NOT salfagpt)
- Region: `us-east4` (NOT us-east1, NOT us-central1)
- Always commit before deploying
- Always verify after deploying

---

**Last Updated:** 2025-11-04  
**Version:** 1.0.0  
**Status:** ‚úÖ Active  
**Priority:** CRITICAL  
**Always Apply:** Yes

---

**Remember:** Production deployments affect live users. Always verify service name and region before deploying!
