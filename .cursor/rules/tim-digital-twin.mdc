# Tim - Digital Twin Testing Agent - Flow Platform

## üéØ Purpose

This rule documents Tim (Together Imagine More), the digital twin testing agent that automatically reproduces user issues, diagnoses problems, and routes insights to appropriate agents and administrators.

**Created:** 2025-11-16  
**Status:** ‚úÖ Production-Ready  
**Version:** 1.0.0

---

## ü§ñ **What is Tim?**

**Tim** is an automated testing agent that creates privacy-safe digital twins of users to:
1. Reproduce reported issues automatically
2. Capture comprehensive diagnostics
3. Analyze root causes with AI
4. Route insights to Ally, Stella, Rudy, and admins

**Name Meaning:**
- **Tim:** User's Digital Twin
- **T.I.M.:** Together Imagine More (encourages collaboration)

---

## üèóÔ∏è **Architecture**

```
USER TICKET ‚Üí TIM DIGITAL TWIN ‚Üí COMPLIANCE CHECK (‚â•98%) ‚Üí BROWSER TEST ‚Üí AI ANALYSIS ‚Üí ROUTING
     ‚Üì              ‚Üì                    ‚Üì                      ‚Üì              ‚Üì            ‚Üì
  Support     Anonymize +         PII Detection         MCP Browser      Gemini Pro   Multi-Agent
  System      Encrypt Data        Encryption             Tools           Diagnosis    Distribution
```

---

## üîê **Privacy Guarantees**

### **Compliance Threshold: ‚â•98%**

**Scoring Algorithm:**
```
Score = (PII Detection √ó 35%) + 
        (Encryption √ó 30%) + 
        (Access Control √ó 25%) + 
        (Audit Trail √ó 10%)
```

**Anonymization:**
- Email: `alec@getaifactory.com` ‚Üí `a***@g***.com`
- Name: `Alec Johnson` ‚Üí `A*** J***`
- PII: Auto-redacted (emails, phones, SSN, credit cards)

**Encryption:**
- Algorithm: AES-256-GCM
- Fields: System prompts, context IDs, sensitive config
- Key: Environment variable (Cloud KMS in production)

---

## üìä **Data Model**

### **Collections**

**1. digital_twins**
```typescript
{
  id: string;
  userId: string;                // Original user
  userEmail: string;             // Anonymized
  ticketId: string;
  userConfig: {                  // User's settings
    model: string;
    systemPrompt: string;        // Encrypted
    language: string;
    activeContextSourceIds: string[]; // Encrypted
  };
  complianceScore: number;       // Must be ‚â•98
  status: 'created' | 'testing' | 'completed';
}
```

**2. tim_test_sessions**
```typescript
{
  id: string;
  digitalTwinId: string;
  userId: string;
  ticketId: string;
  testScenario: {
    userAction: string;
    expectedBehavior: string;
    actualBehavior: string;
    reproductionSteps: string[];
  };
  capturedData: {
    consoleLogs: ConsoleLog[];
    networkRequests: NetworkRequest[];
    screenshots: Screenshot[];
    performanceMetrics: PerformanceMetrics;
    accessibilityIssues: AccessibilityIssue[];
  };
  aiAnalysis: AIAnalysis;
  routedTo: InsightRouting;
}
```

**3. tim_compliance_logs** - Audit trail
**4. tim_insights** - Analyzed findings

---

## üîß **Core Functions**

### **Creating Digital Twins**

```typescript
import { createDigitalTwin } from '../lib/tim';

const result = await createDigitalTwin({
  userId: 'user-123',
  ticketId: 'ticket-456',
  ticketDetails: {
    userAction: 'Clicked Send button',
    expectedBehavior: 'Message should send',
    actualBehavior: 'Error message shown',
    reproductionSteps: [
      'Login to platform',
      'Open agent',
      'Type message',
      'Click Send'
    ]
  }
});

// Result: { digitalTwinId, complianceScore, status, sessionId }
```

---

## üß™ **Browser Automation**

### **Using MCP Browser Tools**

**AI assistants use these tools to execute Tim tests:**

```typescript
// 1. Navigate
await browser_navigate({ url: 'http://localhost:3000/chat' });

// 2. Snapshot (accessibility tree)
const snapshot = await browser_snapshot();

// 3. Capture console
const consoleLogs = await browser_console_messages();

// 4. Monitor network
const networkRequests = await browser_network_requests();

// 5. Screenshot
await browser_take_screenshot({ 
  filename: 'tim-step-1.png',
  fullPage: true 
});

// 6. Interact
await browser_click({ element: 'Send button', ref: '[ref]' });
await browser_type({ element: 'input', ref: '[ref]', text: 'Hello' });

// 7. Measure performance
const metrics = await browser_evaluate({
  function: `() => ({
    loadTime: performance.timing.loadEventEnd - performance.timing.navigationStart,
    memoryUsage: performance.memory?.usedJSHeapSize
  })`
});
```

---

## üß† **AI Analysis**

### **Gemini Pro Analysis**

```typescript
import { analyzeTestResults } from '../lib/tim-analysis';

const analysis = await analyzeTestResults(
  sessionId,
  capturedData,
  testScenario
);

// Returns:
{
  rootCause: "Precise technical explanation",
  reproducible: true/false,
  severity: "critical" | "high" | "medium" | "low",
  affectedUsers: "Who is impacted",
  recommendedFix: "Specific fix steps",
  estimatedEffort: "Time estimate",
  confidence: 0-100
}
```

---

## üéØ **Insight Routing**

### **Distribution Logic**

```typescript
import { routeInsights } from '../lib/tim-routing';

await routeInsights(sessionId, analysis, twin);

// Routes to:
User       ‚Üí Always (transparency)
Ally       ‚Üí Always (personal context)
Stella     ‚Üí UX/Bug/Feature insights
Rudy       ‚Üí High/Critical severity
Admin      ‚Üí Domain-specific patterns
SuperAdmin ‚Üí Platform-wide critical issues
```

---

## üìã **API Endpoints**

### **POST /api/tim/create**
Create digital twin and initialize test

**Auth:** Required (user, admin, superadmin)  
**Body:** `CreateTimRequest`  
**Response:** `{ digitalTwinId, complianceScore, sessionId }`

---

### **GET /api/tim/sessions/:id**
Get test session results

**Auth:** Required (owner, admin, superadmin)  
**Response:** `TimTestSession` with complete diagnostics

---

### **GET /api/tim/my-sessions**
User privacy ledger - complete transparency

**Auth:** Required (owner only)  
**Query:** `?userId={userId}`  
**Response:** `{ ledger: TimLedgerEntry[] }`

---

## üö® **Critical Rules**

### **1. ‚úÖ ALWAYS Check Compliance Before Testing**

```typescript
const { score, passed, issues } = await checkCompliance(twinId, twinData);

if (!passed) {
  throw new Error(`Compliance failed: ${score}% (need ‚â•98%)`);
}
```

**Why:** Privacy is non-negotiable. Never proceed with <98% compliance.

---

### **2. ‚úÖ ALWAYS Anonymize User Data**

```typescript
// ‚úÖ CORRECT
const anonymizedEmail = anonymizeEmail(user.email);
const redactedContent = redactPII(message.content);
const encryptedPrompt = encryptSensitiveData(systemPrompt);

// ‚ùå WRONG
const email = user.email; // Raw PII
const content = message.content; // May contain PII
```

---

### **3. ‚úÖ ALWAYS Use MCP Browser Tools (Not Puppeteer)**

```typescript
// ‚úÖ CORRECT - Use MCP browser tools
await browser_navigate({ url });
await browser_snapshot();
await browser_console_messages();

// ‚ùå WRONG - Don't use Puppeteer
const browser = await puppeteer.launch();
```

**Why:** MCP tools already integrated, maintained by Cursor, AI-native.

---

### **4. ‚úÖ ALWAYS Route Insights to User**

```typescript
// User ALWAYS gets notified of test results
routing.user = true;
await sendReportToUser(userId, insightId, ticketId);
```

**Why:** Transparency builds trust. Users own their data and testing.

---

### **5. ‚úÖ ALWAYS Provide Privacy Ledger Access**

```typescript
// Users can ALWAYS see what Tim did with their data
GET /api/tim/my-sessions?userId={userId}

// Returns complete transparency:
// - What data was shared
// - Who accessed it
// - Compliance scores
// - Download links
```

---

## üé¨ **Usage Patterns**

### **Pattern 1: User Reports Issue**

```typescript
// 1. User creates support ticket
const ticket = {
  userId: 'user-123',
  issue: 'Cannot send messages',
  steps: ['Login', 'Type message', 'Click Send', 'See error']
};

// 2. Create Tim digital twin
const twin = await createDigitalTwin({
  userId: ticket.userId,
  ticketId: ticket.id,
  ticketDetails: {
    userAction: ticket.issue,
    expectedBehavior: 'Message sends and AI responds',
    actualBehavior: 'Error message appears',
    reproductionSteps: ticket.steps
  }
});

// 3. Tim automatically executes test (AI assistant via MCP tools)
// 4. User receives diagnosis in 25-45 seconds
```

---

### **Pattern 2: Scheduled Testing**

```typescript
// Run Tim tests daily to catch regressions
const criticalFlows = [
  { name: 'User Login', steps: [...] },
  { name: 'Send Message', steps: [...] },
  { name: 'Upload Document', steps: [...] }
];

for (const flow of criticalFlows) {
  const twin = await createDigitalTwin({
    userId: 'test-user',
    ticketId: `automated-${flow.name}-${Date.now()}`,
    ticketDetails: { ...flow }
  });
  
  // Tim tests each flow
  // Reports any regressions to SuperAdmin
}
```

---

### **Pattern 3: Performance Monitoring**

```typescript
// Use Tim to track performance over time
const performanceTest = await createDigitalTwin({
  userId: 'benchmark-user',
  ticketId: `perf-${Date.now()}`,
  ticketDetails: {
    userAction: 'Load dashboard',
    expectedBehavior: 'Loads in <2s',
    actualBehavior: 'Measuring actual performance',
    reproductionSteps: ['Navigate to /dashboard', 'Wait for load']
  }
});

// Tim captures metrics
// Compares to historical baseline
// Alerts if >20% degradation
```

---

## üìà **Success Metrics**

```
Time to Diagnose:      2-8 hours ‚Üí 45 seconds
User Satisfaction:     +30-50 NPS points
Developer Productivity: 10-50x improvement
Issue Reproduction:    Manual ‚Üí 100% automated
Privacy Compliance:    ‚â•98% guaranteed
```

---

## üîó **Integration Points**

### **With Feedback System**
```typescript
// When user reports feedback, Tim can test it
onFeedbackSubmit(feedback) {
  if (feedback.type === 'bug') {
    createDigitalTwin({
      userId: feedback.userId,
      ticketId: feedback.id,
      ticketDetails: {
        userAction: feedback.context,
        expectedBehavior: feedback.expected,
        actualBehavior: feedback.actual
      }
    });
  }
}
```

### **With Ally (Personal Agent)**
```typescript
// Tim updates Ally's context with findings
ally.context.timInsights.push({
  issue: analysis.rootCause,
  fix: analysis.recommendedFix,
  timestamp: new Date()
});

// Ally can reference in conversations:
"I noticed you had an issue with X recently. 
 Tim found it was caused by Y. 
 The fix is being implemented."
```

### **With Stella (Product Agent)**
```typescript
// Stella receives product insights from Tim
stella.insights.fromTim.push({
  type: 'ux_issue',
  description: analysis.rootCause,
  frequency: calculateFrequency(issue),
  impact: analysis.affectedUsers
});

// Stella prioritizes improvements based on Tim data
```

---

## üöÄ **Deployment**

### **Prerequisites**
```bash
# 1. Deploy Firestore indexes
firebase deploy --only firestore:indexes --project salfagpt

# 2. Set encryption key (production)
export TIM_ENCRYPTION_KEY="your-secure-key"

# 3. Ensure GOOGLE_AI_API_KEY set (for Gemini Pro)
```

### **Usage**
```typescript
// Tim is ready to use immediately after deployment
// Just call the API or ask AI assistant to run tests
```

---

## ‚ö†Ô∏è **Important Notes**

### **Browser Automation**
- Uses MCP browser tools (not Puppeteer)
- AI assistant executes steps
- No additional infrastructure needed

### **Privacy**
- Compliance check MUST pass (‚â•98%)
- Users ALWAYS have access to ledger
- Anonymization is automatic
- Encryption is default

### **AI Analysis**
- Uses Gemini Pro (not Flash)
- High accuracy required
- Cost: ~$0.01-0.03 per analysis
- Worth it for diagnostics quality

---

## üìö **Related Documentation**

### **Technical**
- `docs/TIM_ARCHITECTURE.md` - Complete architecture
- `docs/TIM_USAGE_GUIDE.md` - How to use
- `src/types/tim.ts` - Type definitions
- `src/lib/tim*.ts` - Implementation

### **Rules**
- `.cursor/rules/alignment.mdc` - Privacy principles
- `.cursor/rules/privacy.mdc` - User data protection
- `.cursor/rules/agents.mdc` - Agentic architecture
- `.cursor/rules/data.mdc` - Data schema

### **Integration**
- Ally Agent: Personal context updates
- Stella Agent: Product insights
- Rudy Agent: Roadmap prioritization
- Feedback System: Auto-testing reported issues

---

## ‚úÖ **Quick Reference**

**Create Twin:**
```bash
POST /api/tim/create
{ userId, ticketId, ticketDetails }
```

**Get Results:**
```bash
GET /api/tim/sessions/{sessionId}
```

**Privacy Ledger:**
```bash
GET /api/tim/my-sessions?userId={userId}
```

**Compliance Check:**
```typescript
const { score, passed } = await checkCompliance(twinId, data);
// Must be ‚â•98%
```

**AI Analysis:**
```typescript
const analysis = await analyzeTestResults(sessionId, capturedData, testScenario);
// Returns: root cause, severity, fix, effort
```

**Routing:**
```typescript
await routeInsights(sessionId, analysis, twin);
// Distributes to: User, Ally, Stella, Rudy, Admins
```

---

## üéØ **Success Criteria**

A properly functioning Tim system should:

1. **Privacy** ‚úÖ
   - Compliance score ‚â•98%
   - Users can view all Tim sessions
   - Complete data transparency
   - Encryption working

2. **Accuracy** ‚úÖ
   - Issue reproduction successful
   - Root cause identified correctly
   - Fix recommendations actionable
   - Effort estimates accurate

3. **Speed** ‚úÖ
   - Total execution <60 seconds
   - User receives results immediately
   - Insights routed within seconds

4. **Integration** ‚úÖ
   - Ally receives context updates
   - Stella receives product insights
   - Rudy receives roadmap data
   - Admins receive alerts

---

## üîÆ **Future Enhancements**

### **v2.0** (Planned)
- Visual regression testing
- Performance benchmarking
- Automated scheduling
- Tim learning system

### **v3.0** (Future)
- Predictive issue detection
- Automated fix generation
- Self-healing capabilities
- Continuous integration testing

---

**Last Updated:** 2025-11-16  
**Version:** 1.0.0  
**Status:** ‚úÖ Production-Ready  
**Aligned With:** alignment.mdc, privacy.mdc, agents.mdc, data.mdc

---

**Remember:** Tim is Together Imagine More - a collaborative testing agent that respects user privacy while delivering exceptional diagnostic capabilities. ü§ñ‚ú®
