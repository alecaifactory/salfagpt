---
alwaysApply: true
---

# Multi-Organization System - Flow Platform

## ğŸ¯ Purpose

This rule documents the multi-organization system enabling enterprise multi-tenancy with complete data isolation, per-org branding, staging-production workflow, and organization-scoped evaluation.

**Created:** 2025-11-10  
**Status:** âœ… Implemented (Steps 1-9)  
**Backward Compatible:** âœ… YES - All existing functionality preserved

---

## ğŸ—ï¸ **Architecture Overview**

### **Organization Hierarchy**

```
SuperAdmin (alec@getaifactory.com)
  â”‚
  â”œâ”€ Organization: Salfa Corp
  â”‚   â”œâ”€ Domains: [salfagestion.cl, salfa.cl, ...]
  â”‚   â”œâ”€ Admins: [sorellanac@salfagestion.cl, ...]
  â”‚   â”œâ”€ Users: 150+ (filtered by email domain)
  â”‚   â”œâ”€ Agents: 200+ (org-scoped)
  â”‚   â”œâ”€ Branding: Salfa-specific
  â”‚   â”œâ”€ Encryption: KMS key per org
  â”‚   â””â”€ Evaluation: Per-domain configs
  â”‚
  â”œâ”€ Organization: Future Client A
  â”‚   â”œâ”€ Domains: [clienta.com]
  â”‚   â”œâ”€ Complete data isolation
  â”‚   â””â”€ Custom branding
  â”‚
  â””â”€ Organization: Future Client B
      â””â”€ Self-hosted or SaaS shared
```

---

## ğŸ” **Security & Isolation**

### **Three-Layer Access Control**

**Layer 1: User Isolation** (existing - preserved)
```typescript
// Users see only their own data
.where('userId', '==', userId)
```

**Layer 2: Organization Isolation** (NEW)
```typescript
// Org admins see only their org data
.where('organizationId', '==', orgId)

// Admin in Org A CANNOT see Org B data
```

**Layer 3: SuperAdmin Access** (NEW)
```typescript
// SuperAdmin can see ALL organizations
// Can manage all orgs, create orgs, execute promotions
```

### **Database-Level Enforcement**

See `firestore.rules` for complete security implementation.

**Key Functions:**
- `isSuperAdmin()` - System-wide access
- `isOrgAdmin(orgId)` - Organization-scoped admin
- `belongsToOrg(orgId)` - Organization membership
- `canAccessOrgResource(resource)` - Backward compatible access

---

## ğŸ“Š **Data Model**

### **Organization Schema**

See `src/types/organizations.ts` for complete interface.

**Key Fields:**
```typescript
{
  id: string;                     // Org ID (e.g., 'salfa-corp')
  name: string;                   // Display name
  domains: string[];              // Multi-domain support
  primaryDomain: string;          // Main domain
  admins: string[];               // User IDs who can manage org
  
  tenant: {
    type: 'dedicated' | 'saas' | 'self-hosted';
    gcpProjectId?: string;
  };
  
  branding: {
    logo?: string;
    primaryColor: string;
    brandName: string;
  };
  
  evaluationConfig: {
    enabled: boolean;
    domainConfigs: Record<string, DomainEvalConfig>;
  };
  
  privacy: {
    encryptionEnabled: boolean;
    encryptionKeyId?: string;
  };
  
  version: number;                // Conflict detection
  organizationId?: string;        // On all org-scoped docs
}
```

### **Collections**

**Existing Collections Enhanced:**
- `users` - Added `organizationId?`, `assignedOrganizations?`, `domainId?`
- `conversations` - Added `organizationId?`, `version?`, promotion fields
- `context_sources` - Added `organizationId?`, `version?`

**New Collections:**
- `organizations` - Organization configurations
- `promotion_requests` - Staging â†’ production workflow
- `promotion_snapshots` - Rollback capability
- `data_lineage` - Complete audit trail
- `conflict_resolutions` - Conflict handling
- `org_memberships` - User-org relationships

---

## ğŸ”„ **Staging-Production Workflow**

### **Promotion Flow**

```
1. Modify in Staging
   â†“
2. Create Promotion Request
   â†“
3. Org Admin Approves
   â†“
4. SuperAdmin Approves
   â†“
5. Conflict Check
   â†“
6. Snapshot Created (rollback)
   â†“
7. Execute to Production
   â†“
8. Verify & Monitor
```

### **Best Practices Implemented**

1. âœ… **Document versioning** - Conflict detection
2. âœ… **Bidirectional sync** - Prod â†” staging refresh
3. âœ… **Multi-tenant RLS** - Organization-level security
4. âœ… **Read-only prod access** - Staging reads production safely
5. âœ… **Cascading source tags** - Parent â†’ child tracking
6. âœ… **Hierarchy validation** - User â†’ org â†’ domain checks
7. âœ… **Promotion approval** - Dual approval workflow
8. âœ… **KMS encryption** - Per-org encryption keys
9. âœ… **Data lineage** - Complete audit trail
10. âœ… **Promotion rollback** - 90-day snapshots

---

## ğŸ”§ **Usage**

### **Create Organization (SuperAdmin)**

```typescript
POST /api/organizations
{
  "name": "Salfa Corp",
  "domains": ["salfagestion.cl", "salfa.cl"],
  "primaryDomain": "salfagestion.cl"
}
```

### **Migrate Existing Data**

```bash
# Preview (safe)
npm run migrate:multi-org:dry-run -- --org=salfa-corp --domains=salfagestion.cl,salfa.cl

# Execute in staging
npm run migrate:multi-org -- --org=salfa-corp --domains=salfagestion.cl,salfa.cl --env=staging

# Execute in production (after UAT)
npm run migrate:multi-org -- --org=salfa-corp --domains=salfagestion.cl,salfa.cl --env=production
```

### **Setup Staging Environment**

```bash
npm run staging:setup
# Creates salfagpt-staging project
# ~30-45 minutes
```

### **Setup Encryption**

```bash
./scripts/setup-org-encryption.sh --org=salfa-corp --project=salfagpt
```

---

## ğŸ“š **Key Files**

### **Types**
- `src/types/organizations.ts` - Organization, Promotion, Lineage types

### **Libraries**
- `src/lib/organizations.ts` - Org management (25+ functions)
- `src/lib/promotion.ts` - Promotion workflow (15+ functions)
- `src/lib/staging-sync.ts` - Staging sync (8+ functions)
- `src/lib/encryption.ts` - KMS encryption (10+ functions)

### **APIs**
- `src/pages/api/organizations/` - 8 endpoints
- `src/pages/api/promotions/` - 5 endpoints
- `src/pages/api/lineage/` - 1 endpoint

### **Scripts**
- `scripts/create-staging-mirror.sh` - Staging setup
- `scripts/migrate-to-multi-org.ts` - Data migration
- `scripts/setup-org-encryption.sh` - KMS setup

### **Components**
- `src/components/OrganizationManagementDashboard.tsx`
- `src/components/OrganizationConfigModal.tsx`
- `src/components/PromotionApprovalDashboard.tsx`

---

## âœ… **Backward Compatibility**

### **CRITICAL: All Changes Are Additive**

**Safe Changes:**
- âœ… All new fields optional (`field?: type`)
- âœ… All existing fields preserved
- âœ… All existing queries work unchanged
- âœ… All existing APIs unchanged

**No Breaking Changes:**
- âŒ No fields removed
- âŒ No field types changed
- âŒ No required fields added
- âŒ No existing behavior modified

**Migration is Optional:**
- System works with mixed data (some with orgId, some without)
- Un-migrated users/data continue functioning normally
- Migration can be done progressively

---

## ğŸ¯ **Integration with Existing Systems**

### **Evaluation System**

The existing evaluation system (supervisor/especialista) is **enhanced, not replaced**:

```typescript
// Organization contains evaluation config
evaluationConfig: {
  enabled: boolean;
  domainConfigs: {
    'salfagestion.cl': {
      supervisors: [...],
      especialistas: [...],
      settings: {...}
    }
  }
}

// Existing domain_review_configs collection still used
// Organization provides grouping and defaults
```

---

## ğŸ“‹ **Deployment Checklist**

### **Before Production:**

- [ ] Deploy indexes: `firebase deploy --only firestore:indexes`
- [ ] Test rules in emulator
- [ ] Deploy rules: `firebase deploy --only firestore:rules`
- [ ] Setup staging: `npm run staging:setup`
- [ ] Test migration (dry-run)
- [ ] Run migration in staging
- [ ] UAT with admin (sorellanac@)
- [ ] Admin approval obtained
- [ ] Run migration in production
- [ ] Monitor 48 hours

---

## ğŸ”— **Related Rules**

- `.cursor/rules/alignment.mdc` - Core principles (data persistence, security)
- `.cursor/rules/data.mdc` - Complete data schema
- `.cursor/rules/privacy.mdc` - User data isolation
- `.cursor/rules/firestore.mdc` - Database operations

---

**Last Updated:** 2025-11-10  
**Version:** 1.0.0  
**Status:** âœ… Backend Complete, Frontend Partial  
**Backward Compatible:** âœ… Guaranteed
