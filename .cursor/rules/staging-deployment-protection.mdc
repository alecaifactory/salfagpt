# Staging Deployment Protection

**alwaysApply**: false
**requiresConfirmation**: true
**appliesTo**: Staging environment deployments (staging-internal, staging-client)

## ğŸ¯ Purpose

Protects staging environments from accidental deployments by requiring explicit user confirmation before ANY staging deployment operation.

**This rule is NOT always applied** - it's loaded when AI detects staging deployment operations.

---

## ğŸŸ¡ Protected Operations

This rule triggers confirmation for:

### Staging-Internal Operations
- `./deployment/deploy-to-environment.sh staging-internal`
- `gcloud run deploy flow-staging-internal`
- Modifying staging Firestore data via scripts
- Creating/deleting staging resources

### Staging-Client Operations  
- `./deployment/deploy-to-environment.sh staging-client`
- `gcloud run deploy flow-staging`
- Any operation on client's staging GCP project
- Modifying client staging Firestore

---

## ğŸ“‹ Required Confirmation Format

### For Staging-Internal

```
ğŸŸ¡ STAGING-INTERNAL DEPLOYMENT
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Environment: staging-internal
Project: gen-lang-client-0986191192
Service: flow-staging-internal
Purpose: Internal QA testing

Pre-deployment checks:
âœ… Type check passed: npm run type-check
âœ… Build successful: npm run build
âœ… Local testing: Completed

Changes to deploy:
â€¢ [List files changed]
â€¢ [Summary of changes]

Impact: Internal team only
Risk: LOW

Do you want to proceed with deployment? (yes/no):
```

### For Staging-Client

```
ğŸŸ  STAGING-CLIENT DEPLOYMENT
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Environment: staging-client
Project: [CLIENT-STAGING-PROJECT-ID]
Service: flow-staging
URL: https://staging.client-domain.com
Purpose: Client UAT testing

Pre-deployment checks:
âœ… Type check passed: npm run type-check
âœ… Build successful: npm run build
âœ… Staging-internal: Validated
â–¡ Client notified: [REQUIRED]

Changes to deploy:
â€¢ [List files changed]
â€¢ [Summary of changes]

Impact: Client UAT environment
Risk: MEDIUM

Has client been notified? (yes/no):
[Wait for yes]

Do you want to proceed with deployment? (yes/no):
```

---

## ğŸš« Forbidden Without Confirmation

**NEVER do these without asking**:

1. âŒ Execute deployment scripts
2. âŒ Run `gcloud run deploy` to staging
3. âŒ Modify Firestore via admin SDK
4. âŒ Delete staging resources
5. âŒ Change environment variables
6. âŒ Update secrets in Secret Manager
7. âŒ Modify OAuth configuration

**ALWAYS do these first**:

1. âœ… Display environment info
2. âœ… List what will change
3. âœ… Assess risk level
4. âœ… Ask for explicit confirmation
5. âœ… Wait for user's "yes"

---

## ğŸ“Š Deployment Checklist

### Before ANY Staging Deployment

AI must verify and display:

**Code Quality**:
- [ ] `npm run type-check` â†’ 0 errors
- [ ] `npm run build` â†’ successful
- [ ] No TypeScript errors
- [ ] No console.logs in production code

**Testing**:
- [ ] Local testing completed
- [ ] Features working as expected
- [ ] No breaking changes
- [ ] Backward compatible

**Configuration**:
- [ ] Correct .env file loaded
- [ ] Correct GCP project set
- [ ] Secrets configured
- [ ] OAuth redirect URIs match

**Communication** (for staging-client):
- [ ] Client notified of deployment
- [ ] Changes documented
- [ ] Testing instructions provided

---

## ğŸ’¬ Example Interaction

**User**: "Deploy to staging-client"

**AI Response**:
```
ğŸŸ  STAGING-CLIENT DEPLOYMENT REQUEST
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Target: staging-client
Project: acme-corp-staging-12345
Service: flow-staging
URL: https://staging.acme.com

Pre-deployment checks:
âœ… Type check: PASSED
âœ… Build: SUCCESSFUL
âš ï¸  Have you tested in staging-internal first?

Changes:
â€¢ src/components/Feature.tsx (modified)
â€¢ src/lib/service.ts (new function)

Impact: Client UAT environment
Risk: MEDIUM

Client notification:
Has the client team been notified? (yes/no):
```

**User**: "yes"

**AI**:
```
âœ… Client notified

Ready to deploy to staging-client.

Command that will execute:
  ./deployment/deploy-to-environment.sh staging-client

This will:
1. Load .env.staging-client
2. Set project to acme-corp-staging-12345
3. Build Docker image
4. Deploy to flow-staging service
5. Update PUBLIC_BASE_URL
6. Run health check

Estimated time: 3-5 minutes

Proceed with deployment? (yes/no):
```

**User**: "yes"

**AI**:
```
âœ… Deploying to staging-client...

[Executes deployment]
[Shows progress]
[Shows results]
```

---

## ğŸ”„ Rollback Information

After every staging deployment, AI should remind:

```
âœ… Deployment complete

Current revision: flow-staging-00123-abc

If issues occur, rollback with:
  ./deployment/rollback-deployment.sh staging-client flow-staging-00122-xyz

Previous revision: flow-staging-00122-xyz
```

---

## ğŸ¯ Success Criteria

This rule works correctly if:

- âœ… AI NEVER deploys to staging without confirmation
- âœ… User must explicitly type "yes"
- âœ… Environment clearly identified
- âœ… Risk level communicated
- âœ… Pre-checks displayed

---

**Last Updated**: 2025-10-17  
**Version**: 1.0.0  
**Status**: âœ… Active (requires confirmation)  
**alwaysApply**: false âš ï¸  
**Backward Compatible**: Yes
