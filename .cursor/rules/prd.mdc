---
alwaysApply: true
---
### 2. ğŸ“ GestiÃ³n de Contexto Documental

**DescripciÃ³n:**
Sistema robusto para subir, procesar, validar y gestionar fuentes de contexto que se inyectan en las conversaciones con el AI.

**Tipos de Fuentes Soportadas:**
- ğŸ“„ **PDF** - ExtracciÃ³n automÃ¡tica con Gemini AI (texto + tablas + imÃ¡genes descritas)
- ğŸ“ˆ **CSV** - Parsing con papaparse
- ğŸ“Š **Excel** - Lectura con xlsx
- ğŸ“ **Word** - ExtracciÃ³n con mammoth
- ğŸŒ **URLs** - Scraping de contenido web
- ğŸ”Œ **APIs** - IntegraciÃ³n con endpoints externos
- ğŸ“ **Carpetas** - Procesamiento batch

**Workflow de Procesamiento:**
1. Usuario sube archivo o proporciona URL
2. Sistema detecta tipo y aplica extractor apropiado
3. **Gemini AI** procesa el contenido (para PDFs)
4. ExtracciÃ³n se almacena como `extractedData: string`
5. Metadata incluye: modelo usado, tiempo de extracciÃ³n, tokens, pÃ¡ginas
6. Usuario puede validar la extracciÃ³n (SignOff)
7. Fuentes validadas reciben badge "âœ“ Validado"

**Funcionalidades:**
- âœ… Upload y procesamiento automÃ¡tico
- âœ… SelecciÃ³n de modelo (Flash vs Pro)
- âœ… Tooltip con comparaciÃ³n de costos
- âœ… Progress tracking visual
- âœ… Error handling detallado
- âœ… Re-extracciÃ³n con nueva configuraciÃ³n
- âœ… Toggle on/off por fuente
- âœ… ValidaciÃ³n por expertos autorizados
- âœ… Badges de validaciÃ³n
- âœ… Clickable en desglose de contexto
- âœ… Modal con detalles completos

**Colecciones Firestore:**
```typescript
contextSources: {
  id: string
  userId: string
  name: string
  type: 'pdf' | 'csv' | 'excel' | 'word' | 'web-url' | 'api' | 'folder'
  enabled: boolean
  status: 'active' | 'processing' | 'error' | 'disabled'
  addedAt: timestamp
  extractedData?: string
  metadata?: {
    originalFileName: string
    originalFileSize: number
    workflowId: string
    extractionDate: timestamp
    extractionTime: number // ms
    model: string // e.g., 'gemini-2.5-flash'
    charactersExtracted: number
    tokensEstimate: number
    pageCount?: number
    validated?: boolean
    validatedBy?: string
    validatedAt?: timestamp
    validationNotes?: string
  }
  progress?: {
    stage: 'uploading' | 'processing' | 'complete' | 'error'
    percentage: number
    message: string
  }
  error?: {
    message: string
    details?: string
    timestamp: timestamp
  }
}
```

**API Endpoints:**
- `POST /api/extract-document` - Procesar documento
- `GET /api/context-sources` - Listar fuentes del usuario
- `DELETE /api/context-sources/:id` - Eliminar fuente

---

### 3. âš™ï¸ ConfiguraciÃ³n de Usuario

**DescripciÃ³n:**
Cada usuario puede personalizar su experiencia con el AI, eligiendo modelo y definiendo instrucciones de sistema.

**Funcionalidades:**
- âœ… SelecciÃ³n de modelo preferido (Flash vs Pro)
- âœ… System prompt personalizable
- âœ… Persistencia por usuario
- âœ… Modal de configuraciÃ³n accesible desde menÃº usuario
- âœ… AplicaciÃ³n inmediata a nuevas conversaciones
- âœ… **FIX CRÃTICO**: Config ahora se pasa correctamente al API

**ConfiguraciÃ³n por Usuario:**
```typescript
userSettings: {
  preferredModel: 'gemini-2.5-flash' | 'gemini-2.5-pro'
  systemPrompt: string // Default: "Eres un asistente..."
}
```

**Ejemplo de Uso:**
- Usuario escribe: "Utiliza emojis en todas tus respuestas ğŸ‰"
- Todas las respuestas del AI incluyen emojis

---

### 4. ğŸ“Š Log de Contexto por InteracciÃ³n

**DescripciÃ³n:**
Sistema de auditorÃ­a completo que registra todos los detalles de cada interacciÃ³n usuario-AI para:
- OptimizaciÃ³n de prompts
- Control de costos
- Debug de respuestas
- Trazabilidad completa

**InformaciÃ³n Registrada:**
```typescript
ContextLog {
  id: string
  timestamp: Date
  userMessage: string
  aiResponse: string
  model: string // 'gemini-2.5-flash' | 'gemini-2.5-pro'
  systemPrompt: string
  contextSources: Array<{
    name: string
    tokens: number
  }>
  totalInputTokens: number // system + history + context + user message
  totalOutputTokens: number // AI response
  contextWindowUsed: number
  contextWindowAvailable: number
  contextWindowCapacity: number // 1M (Flash) | 2M (Pro)
}
```

**UI del Log:**
- Tabla compacta con columnas: Hora, Pregunta, Modelo, Input, Output, Total, Disponible, Uso%
- Colores por modelo: Verde (Flash), Morado (Pro)
- Colores por uso: Verde <50%, Amarillo 50-80%, Rojo >80%
- Filas expandibles con detalles completos
- Scroll horizontal para tabla larga

**Beneficios:**
- âœ… Ver exactamente quÃ© se enviÃ³ al modelo
- âœ… Auditar tokens usados por interacciÃ³n
- âœ… Optimizar prompts viendo impacto real
- âœ… Detectar fugas de contexto
- âœ… Entender costos por mensaje

---

### 5. ğŸ¨ Renderizado Markdown Enriquecido

**DescripciÃ³n:**
Las respuestas del AI ahora se renderizan con formato rico usando Markdown, mejorando significativamente la legibilidad y profesionalismo.

**Componente:**
```typescript
<MessageRenderer 
  content={markdownString}
  contextSources={Array<{id, name, validated}>}
  onSourceClick={(sourceId) => handleClick(sourceId)}
/>
```

**Capacidades:**

#### ğŸ’» CÃ³digo con Syntax Highlighting
```python
def fibonacci(n):
    return n if n <= 1 else fibonacci(n-1) + fibonacci(n-2)
```
- Syntax highlighting automÃ¡tico (VSCode Dark theme)
- BotÃ³n "Copiar" al hover
- CÃ³digo inline: `variable = value`

#### ğŸ“Š Tablas Formateadas
| Columna 1 | Columna 2 | Columna 3 |
|-----------|-----------|-----------|
| Dato A    | Dato B    | Dato C    |

- Headers con background gris
- Borders y espaciado profesional
- Scroll horizontal responsive

#### ğŸ”— Enlaces
- **Externos**: [Google](https://google.com) - Ãcono automÃ¡tico, abre en nueva pestaÃ±a
- **Referencias a fuentes**: `[Ver documento](#source-abc123)` - Clickable, abre modal

#### ğŸ–¼ï¸ ImÃ¡genes
```markdown
![DescripciÃ³n](https://ejemplo.com/imagen.png)
```
- Tarjeta con border y shadow
- Alt text en footer
- Lazy loading

#### ğŸ“ Otros Elementos
- **Blockquotes**: Border azul, background claro, itÃ¡lica
- **Listas**: Ordenadas y sin orden con espaciado optimizado
- **Headings**: H1-H6 con jerarquÃ­a visual
- **PÃ¡rrafos**: Leading relajado, colores apropiados

**LibrerÃ­as Usadas:**
- `react-markdown` - Parsing y renderizado
- `remark-gfm` - GitHub Flavored Markdown (tablas, etc.)
- `rehype-raw` - HTML en Markdown
- `react-syntax-highlighter` - Highlighting de cÃ³digo

---

### 6. ğŸ“ Referencias a Fuentes de Contexto

**DescripciÃ³n:**
El AI puede referenciar fuentes de contexto en sus respuestas, permitiendo trazabilidad y verificaciÃ³n.

**Formato:**
```markdown
SegÃºn el [Documento Demo](#source-{sourceId}), la polÃ­tica indica...
```

**Comportamiento:**
- Link es clickable
- Incluye Ã­cono de documento
- Badge "âœ“ Validado" si la fuente fue aprobada
- Click abre modal con:
  - Fuente original
  - Metadata de extracciÃ³n
  - Extracto del contenido
  - Estado de validaciÃ³n
  - OpciÃ³n de re-extraer

**Fuentes en Desglose de Contexto:**
- Tarjetas verdes clickables
- Badge de validaciÃ³n visible
- Hover effect
- Click abre mismo modal de detalles

---

### 7. ğŸ” AutenticaciÃ³n y Usuarios

**DescripciÃ³n:**
Sistema de autenticaciÃ³n con JWT y Google OAuth2.

**Roles de Usuario:**
- **Admin** (`admin@demo.com`) - Acceso total
- **Expert** (`expert@demo.com`) - Puede validar fuentes
- **User** (`user@demo.com`) - Uso bÃ¡sico
- **Roles Especializados**:
  - `context_signoff@demo.com` - Aprobar fuentes
  - `context_reviewer@demo.com` - Revisar fuentes
  - `context_creator@demo.com` - Crear fuentes
  - `agent_signoff@demo.com` - Aprobar agentes
  - `agent_reviewer@demo.com` - Revisar agentes

**Colecciones Firestore:**
```typescript
users: {
  id: string
  email: string
  name: string
  role: string
  createdAt: timestamp
  lastLogin?: timestamp
}
```

**Flujo:**
1. Usuario hace login con Google OAuth2
2. Backend genera JWT con user data
3. JWT almacenado en cookie `flow_session`
4. Cada request verifica JWT
5. Modo desarrollo permite test user sin auth

---

### 8. ğŸ¯ Contexto por Agente

**DescripciÃ³n:**
Cada agente mantiene su propio conjunto de fuentes de contexto activas, persistiendo en Firestore.

**ImplementaciÃ³n:**
```typescript
// Al activar/desactivar fuente en agente activo
await saveConversationContext(conversationId, activeSourceIds)

// Al cargar agente
const activeIds = await loadConversationContext(conversationId)
// Aplicar enables a contextSources
```

**Flujo:**
1. Usuario selecciona agente
2. Sistema carga `activeContextSourceIds` de Firestore
3. Fuentes se activan/desactivan segÃºn IDs
4. Usuario modifica contexto (toggles)
5. Sistema guarda nueva configuraciÃ³n en Firestore
6. Al cambiar de agente, contexto anterior se preserva

**API Endpoint:**
```typescript
PUT /api/conversations/:id/context-sources
Body: { activeSourceIds: string[] }
```

---

### 9. ğŸ”„ Workflows y Procesamiento

**DescripciÃ³n:**
Sistema de workflows para procesamiento de diferentes tipos de contenido.

**Workflows Disponibles:**
1. **Procesar PDF** - ExtracciÃ³n automÃ¡tica con Gemini
2. **Importar CSV** - Parsing de datos tabulares
3. **Leer Excel** - Hojas de cÃ¡lculo
4. **Extraer Word** - Documentos de texto
5. **Scrape URL** - Contenido web
6. **Conectar API** - Integraciones externas

**ConfiguraciÃ³n de Workflow:**
```typescript
WorkflowConfig {
  maxFileSize?: number // MB
  maxOutputLength?: number // tokens
  language?: string
  model?: 'gemini-2.5-flash' | 'gemini-2.5-pro'
}
```

**UI:**
- Panel derecho con workflows disponibles
- Estado visual: available, running, completed, failed
- Click en "Ejecutar" abre modal de configuraciÃ³n
- Guardar como template local

---

### 10. ğŸ“± UI/UX Principal

**Layout:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             â”‚                             â”‚              â”‚
â”‚   Sidebar   â”‚       Chat Messages         â”‚  Workflows   â”‚
â”‚   Izquierdo â”‚                             â”‚   Panel      â”‚
â”‚             â”‚                             â”‚  (Derecho)   â”‚
â”‚  â€¢ Agentes  â”‚  â€¢ User messages (blue)     â”‚              â”‚
â”‚  â€¢ Context  â”‚  â€¢ AI messages (white)      â”‚  â€¢ Execute   â”‚
â”‚  â€¢ Sources  â”‚  â€¢ Markdown rendering       â”‚  â€¢ Config    â”‚
â”‚  â€¢ User     â”‚                             â”‚  â€¢ Status    â”‚
â”‚             â”‚                             â”‚              â”‚
â”‚             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
â”‚             â”‚   Context Button            â”‚              â”‚
â”‚             â”‚   Input Area                â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Componentes Principales:**
- `ChatInterfaceWorking.tsx` - Componente principal
- `MessageRenderer.tsx` - Renderizado Markdown
- `ContextManager.tsx` - GestiÃ³n de fuentes
- `AddSourceModal.tsx` - Subir nuevas fuentes
- `WorkflowConfigModal.tsx` - Configurar workflows
- `UserSettingsModal.tsx` - Config de usuario
- `ContextSourceSettingsModal.tsx` - Detalles de fuente

---

## ğŸ¨ Design System

### Colores
- **Primary**: Azul (`blue-600`, `blue-50`)
- **Success**: Verde (`green-600`, `green-50`)
- **Warning**: Amarillo (`yellow-600`, `yellow-50`)
- **Error**: Rojo (`red-600`, `red-50`)
- **Neutral**: Slate (`slate-50` to `slate-900`)

### Modelos AI
- **Flash**: Verde (`green-600`) - RÃ¡pido, econÃ³mico
- **Pro**: Morado (`purple-600`) - Preciso, costoso

### Iconos (Lucide React)
- `MessageSquare` - Conversaciones
- `FileText` - Documentos
- `Sparkles` - AI/Modelo
- `Settings` - ConfiguraciÃ³n
- `CheckCircle` - Validado
- `XCircle` - Error
- `Loader2` - Procesando

---

## ğŸš€ TecnologÃ­as

### Frontend
- **Framework**: Astro 5.1.x + React 18.3.x
- **Lenguaje**: TypeScript 5.7.x
- **Estilos**: Tailwind CSS 3.4.x (NO v4)
- **Iconos**: Lucide React
- **Markdown**: react-markdown, remark-gfm, rehype-raw
- **Code Highlighting**: react-syntax-highlighter

### Backend
- **API**: Astro API Routes
- **Database**: Google Firestore
- **Analytics**: Google BigQuery
- **AI**: Google Gemini AI 2.5 (Flash, Pro)
- **Auth**: JWT + Google OAuth2
- **Deployment**: Google Cloud Run

### DevOps
- **Build**: `npm run build`
- **Dev**: `npm run dev`
- **Deploy**: `npx pame-core-cli deploy www --production`
- **Project**: `salfagpt-a98b5` (GCP)

---

## ğŸ“Š MÃ©tricas y KPIs

### Por Usuario
- Conversaciones creadas
- Mensajes enviados
- Tokens usados (input/output)
- Fuentes de contexto subidas
- Fuentes validadas

### Por Sistema
- Tiempo de respuesta promedio
- Tasa de error
- Uso de modelos (Flash vs Pro)
- Costo por conversaciÃ³n
- Uptime

---

## ğŸ”® Roadmap Futuro

### Corto Plazo (1-2 meses)
- [ ] Exportar conversaciones como PDF
- [ ] Compartir fuentes entre usuarios/grupos
- [ ] Email templates para compartir contexto
- [ ] A/B testing de modelos
- [ ] EvaluaciÃ³n de calidad de extracciÃ³n

### Mediano Plazo (3-6 meses)
- [ ] Soporte para videos embebidos
- [ ] Mermaid diagrams en respuestas
- [ ] RAG avanzado con embeddings
- [ ] Fine-tuning de modelos especÃ­ficos
- [ ] Dashboard de analytics avanzado

### Largo Plazo (6-12 meses)
- [ ] Multi-tenant con aislamiento completo
- [ ] Marketplace de agentes
- [ ] API pÃºblica para integraciones
- [ ] Mobile apps (iOS/Android)
- [ ] WhatsApp/Slack integrations

---

## ğŸ”’ Seguridad y Compliance

### Datos
- Todos los datos en reposo encriptados (Firestore)
- Conexiones HTTPS obligatorias
- JWT con expiraciÃ³n configurable
- No se almacenan archivos originales (solo extractos)

### AutenticaciÃ³n
- OAuth2 con Google
- JWT tokens con refresh
- Session cookies httpOnly
- CORS configurado apropiadamente

### Permisos
- Usuarios solo ven sus propios datos
- Admins tienen acceso completo
- Roles granulares para operaciones especÃ­ficas
- AuditorÃ­a de acciones crÃ­ticas

---

## ğŸ“ Notas de ImplementaciÃ³n

### Convenciones de CÃ³digo
- TypeScript estricto
- ESLint + Prettier
- Componentes funcionales con hooks
- Props con interfaces explÃ­citas
- Comentarios en espaÃ±ol para lÃ³gica de negocio

### Testing
- Unit tests para funciones crÃ­ticas
- Integration tests para API endpoints
- E2E tests para flujos principales
- Manual QA antes de cada deploy

### Deployment
1. `npm run build` - Verificar build limpio
2. `npm run type-check` - Sin errores TypeScript
3. Test en local: `npm run dev`
4. Deploy: `npx pame-core-cli deploy www --production`
5. Verificar en producciÃ³n

---

## ğŸ› Issues Conocidos y Soluciones

### 1. ConfiguraciÃ³n no se aplicaba
**Problema**: User settings no se pasaban al API
**SoluciÃ³n**: `sendMessage()` ahora envÃ­a `model` y `systemPrompt`

### 2. Conversaciones temporales sin contexto
**Problema**: Temp conversations no mostraban contexto completo
**SoluciÃ³n**: `calculateLocalContext()` construye contexto desde mensajes locales

### 3. Firestore connection errors
**Problema**: Local dev no conectaba a Firestore
**SoluciÃ³n**: ADC con `gcloud auth application-default login`

### 4. CSS no compilaba
**Problema**: Tailwind v4 incompatible con Next.js 15
**SoluciÃ³n**: Downgrade a Tailwind v3.4.x

---

## ğŸ“š DocumentaciÃ³n Relacionada

- `docs/CHAT_INTEGRATION_LESSONS.md` - Lecciones aprendidas
- `docs/GEMINI_API_MIGRATION.md` - GuÃ­a de Gemini AI
- `.cursor/rules/gemini-api-usage.mdc` - Reglas de API
- `.cursor/rules/gcp-project-consistency.mdc` - Consistencia GCP
- `MARKDOWN_FEATURES_GUIDE.md` - GuÃ­a de Markdown

---

**Ãšltima ActualizaciÃ³n**: 2025-10-12
**VersiÃ³n**: 2.0.0
**Estado**: âœ… En ProducciÃ³n
