# S1-v2 RAG Fix - November 19, 2025

## Problem Summary
S1-v2 agent was giving generic responses without using RAG (no document references shown).

## Root Causes Identified

### 1. **No Documents Assigned** ✅ FIXED
- **Issue**: S1-v2 had 0 documents assigned to it initially
- **Fix**: Assigned the exact 75 documents from the CLI upload
- **Script**: `scripts/assign-exact-75-to-s1v2.mjs`

### 2. **API Not Querying agent_sources Collection** ✅ FIXED
- **Issue**: `context-sources-metadata.ts` API was only checking `assignedToAgents` field in documents
- **Problem**: We use `agent_sources` collection for assignments, not an array field
- **Fix**: Added query to `agent_sources` collection to find assigned documents
- **File**: `src/pages/api/conversations/[id]/context-sources-metadata.ts`

## The 75 Documents Assigned to S1-v2

Documents covering warehouse management, SAP procedures, and logistics:

### Categories:
- **MAQ-LOG-CBO** (29 docs): Warehouse/Bodega procedures
  - Inventory management (Toma de Inventario, Cierre de Bodegas)
  - Transfers (Traspaso de Bodega)
  - Fuel management (Combustible/Petróleo Diésel)
  - Material requests and delivery
  
- **MAQ-LOG-CT** (7 docs): Transport coordination
  - Transport requests (ST SAMEX, ST SUBCARGO)
  - Transport cost approvals
  - Transport reports

- **MAQ-ADM** (8 docs): Administration
  - Bodega Fácil system procedures
  - PDA and printer configuration
  - Audits and inventory controls

- **MAQ-ABA** (3 docs): Purchasing
  - Convention purchases (Compras por Convenio)
  - Technical purchases
  - Excess sales and recovery

- **MAQ-GG-CAL** (3 docs): Quality control
  - Supplier creation in SAP
  - Supplier evaluation

- **Paso a Paso** (24 docs): Step-by-step SAP guides
  - HES creation, approval, cancellation
  - Material updates
  - Invoice handling
  - Delivery notes (Guías de Despacho)
  - Various SAP transactions

- **Other** (1 doc): Training materials

## Technical Changes

### Modified Files:
1. `src/pages/api/conversations/[id]/context-sources-metadata.ts`
   - Added query to `agent_sources` collection
   - Merges results from both `assignedToAgents` field and `agent_sources` collection
   - Now properly loads all assigned documents

### Git Commit:
```
commit dc6e2bd
Fix: Query agent_sources collection to load assigned documents for RAG
```

### Deployment:
- Deployed to: `cr-salfagpt-ai-ft-prod`
- Service URL: https://cr-salfagpt-ai-ft-prod-3snj65wckq-uc.a.run.app
- Region: us-central1
- Deployment time: ~15 minutes

## Verification Steps

1. ✅ Documents assigned: 75 documents
2. ✅ Documents enabled: All 75 active in `activeContextSourceIds`
3. ✅ API fixed: Now queries `agent_sources` collection
4. ✅ Deployed: Production deployment complete

## Testing Instructions

1. Refresh SalfaGPT browser page
2. Select S1-v2 agent
3. Ask questions like:
   - "¿Cómo hago un pedido de convenio?"
   - "¿Cuál es el procedimiento para cerrar una bodega?"
   - "¿Cómo genero una guía de despacho en SAP?"
   - "¿Cómo creo una HES?"
   - "¿Cómo gestiono el combustible en la bodega?"

4. **Expected Result**:
   - RAG should retrieve relevant chunks
   - References should appear at the end of responses
   - Similarity scores should show (50-100%)
   - Document names should be listed

## Scripts Created

### Utility Scripts:
- `scripts/find-ssoma-documents.mjs` - Categorizes documents by type
- `scripts/check-user-sources.mjs` - Checks user's uploaded documents
- `scripts/assign-exact-75-to-s1v2.mjs` - **Main script** - Assigns the 75 CLI documents

### Not Used (for reference):
- `scripts/assign-all-sources-to-s1v2.mjs` - Would assign ALL 1,179 documents (not used)
- `scripts/assign-ssoma-to-s1v2.mjs` - Would assign only SSOMA documents (not used)
- `scripts/fix-s1v2-sources.mjs` - Initial attempt (superseded)

## Notes

- The 75 documents were uploaded via CLI (as shown in the upload summary)
- All 75 documents have RAG indexing enabled with embeddings
- One document (SSOMA-GS-009) had 0 chars extracted (empty)
- Total embeddings across all documents: ~310 chunks
- Agent created: Nov 19, 2025 at 09:59:48 GMT-0300

## If RAG Still Doesn't Work

Check these:

1. **BigQuery Dataset**: Verify chunks exist in `flow_rag_optimized.document_chunks_vectorized`
2. **User Context**: Ensure correct `googleUserId` mapping
3. **Browser Cache**: Hard refresh (Cmd+Shift+R)
4. **Console Logs**: Check for "RAG search" logs in Cloud Run
5. **Active Sources**: Verify `activeContextSourceIds` is set on agent

## Success Criteria

- ✅ S1-v2 returns responses with document references
- ✅ References show document names and similarity scores
- ✅ Answers are contextually relevant to the 75 assigned documents
- ✅ No more generic responses about "bodegas in general"

