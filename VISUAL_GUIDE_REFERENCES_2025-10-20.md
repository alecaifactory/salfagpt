# Visual Guide: References & Timing - 2025-10-20

## ğŸ“º What You Should See

### 1. Thinking Steps Progress (9-12 seconds)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SalfaGPT:                           â”‚
â”‚                                     â”‚
â”‚ ğŸ”„ Pensando...                      â”‚  â† 3 segundos
â”‚ â­• Buscando Contexto Relevante...   â”‚
â”‚ â­• Seleccionando Chunks...          â”‚
â”‚ â­• Generando Respuesta...           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

         â†“ (despuÃ©s de 3s)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SalfaGPT:                           â”‚
â”‚                                     â”‚
â”‚ âœ“ Pensando...                       â”‚
â”‚ ğŸ”„ Buscando Contexto Relevante...   â”‚  â† 3 segundos
â”‚ â­• Seleccionando Chunks...          â”‚
â”‚ â­• Generando Respuesta...           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

         â†“ (despuÃ©s de 3s mÃ¡s)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SalfaGPT:                           â”‚
â”‚                                     â”‚
â”‚ âœ“ Pensando...                       â”‚
â”‚ âœ“ Buscando Contexto Relevante...    â”‚
â”‚ ğŸ”„ Seleccionando Chunks...          â”‚  â† 3 segundos
â”‚ â­• Generando Respuesta...           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

         â†“ (despuÃ©s de 3s mÃ¡s)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SalfaGPT:                           â”‚
â”‚                                     â”‚
â”‚ âœ“ Pensando...                       â”‚
â”‚ âœ“ Buscando Contexto Relevante...    â”‚
â”‚ âœ“ Seleccionando Chunks...           â”‚
â”‚ ğŸ”„ Generando Respuesta...           â”‚  â† streaming
â”‚                                     â”‚
â”‚ La frase "Lo expuesto hasta ahora   â”‚
â”‚ lleva a una primera conclusiÃ³n..."  â”‚
â”‚ [texto aparece en tiempo real]      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Detalles importantes:**
- Cada paso muestra **spinner azul** (ğŸ”„) cuando estÃ¡ activo
- **Checkmark verde** (âœ“) cuando completa
- **CÃ­rculo gris** (â­•) cuando estÃ¡ pendiente
- Los puntos ... se animan (1, 2, 3 puntos rotan cada 500ms)

---

### 2. Respuesta con Referencias Inline

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SalfaGPT:                                            â”‚
â”‚                                                      â”‚
â”‚ La frase "Lo expuesto hasta ahora lleva a una        â”‚
â”‚ primera conclusiÃ³n cual es que el caso en consulta   â”‚
â”‚ debe resolverse teniendo presente la Ley NÂ°19.537"  â”‚
â”‚ significa lo siguiente, segÃºn el contexto del        â”‚
â”‚ documento:                                           â”‚
â”‚                                                      â”‚
â”‚ 1. **Antecedentes Legales:** El documento estÃ¡      â”‚
â”‚    analizando una consulta sobre inmuebles que      â”‚
â”‚    originalmente estaban bajo la Ley NÂ°6.071 sobre  â”‚
â”‚    Propiedad Horizontal [1] .                        â”‚
â”‚                           ^^^                        â”‚
â”‚                      (badge azul clickeable)         â”‚
â”‚                                                      â”‚
â”‚ 2. **DerogaciÃ³n de la Ley Antigua:** Se establece   â”‚
â”‚    en el punto 3 que la Ley NÂ°19.537 sobre          â”‚
â”‚    Copropiedad Inmobiliaria derogÃ³ expresamente la   â”‚
â”‚    Ley NÂ°6.071 [2] . Esto significa que la ley      â”‚
â”‚               ^^^                                    â”‚
â”‚          (badge azul clickeable)                     â”‚
â”‚    antigua ya no estÃ¡ vigente.                       â”‚
â”‚                                                      â”‚
â”‚ 3. **AplicaciÃ³n de la Nueva Ley:** El punto 4       â”‚
â”‚    indica que la Ley NÂ°19.537 se aplica a las       â”‚
â”‚    comunidades de copropietarios que antes estaban   â”‚
â”‚    acogidas a la Ley NÂ°6.071 [3] , excepto en       â”‚
â”‚                               ^^^                    â”‚
â”‚                          (badge azul clickeable)     â”‚
â”‚    algunas materias muy especÃ­ficas...               â”‚
â”‚                                                      â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                      â”‚
â”‚ ğŸ“š Referencias utilizadas (3)                        â”‚
â”‚                                                      â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚ â”‚ [1] Cir32.pdf                    85.0% âœ“    â”‚â†Clickâ”‚
â”‚ â”‚     "El documento estÃ¡ analizando una..."    â”‚    â”‚
â”‚ â”‚     Chunk #6 â€¢ 450 tokens                    â”‚    â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                      â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚ â”‚ [2] Cir32.pdf                    73.0% âœ“    â”‚â†Clickâ”‚
â”‚ â”‚     "Se establece en el punto 3 que la..."   â”‚    â”‚
â”‚ â”‚     Chunk #9 â€¢ 380 tokens                    â”‚    â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                      â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚ â”‚ [3] Cir32.pdf                    68.0% âœ“    â”‚â†Clickâ”‚
â”‚ â”‚     "El punto 4 indica que la Ley NÂ°19..."  â”‚    â”‚
â”‚ â”‚     Chunk #12 â€¢ 290 tokens                   â”‚    â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Elementos a verificar:**
- [ ] Badges **[1]**, **[2]**, **[3]** son **azules** con border
- [ ] Badges tienen **hover effect** (mÃ¡s claro al pasar mouse)
- [ ] Cursor cambia a **pointer** (manita)
- [ ] Footer muestra **lista de referencias**
- [ ] Cada referencia muestra:
  - Badge [X]
  - Nombre de fuente
  - Similitud % (color-coded)
  - Snippet del texto
  - Chunk number y tokens
- [ ] Click en badge o en referencia del footer abre panel

---

### 3. Panel Derecho al Click en Referencia

```
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚ ğŸ“„ Referencia [1]              âœ• â”‚
                      â”‚ Cir32.pdf                         â”‚
                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                      â”‚                                   â”‚
                      â”‚ Similitud                         â”‚
                      â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ 85.0%                 â”‚
                      â”‚ (barra verde)                     â”‚
                      â”‚                                   â”‚
                      â”‚ Chunk #6 â€¢ 450 tokens            â”‚
                      â”‚ ğŸ“„ PÃ¡ginas 3-4                   â”‚
                      â”‚                                   â”‚
                      â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
                      â”‚                                   â”‚
                      â”‚ Texto del chunk utilizado:        â”‚
                      â”‚                                   â”‚
                      â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                      â”‚ â”‚ El documento estÃ¡ analizando  â”‚ â”‚
                      â”‚ â”‚ una consulta (un "caso en     â”‚ â”‚
                      â”‚ â”‚ consulta") sobre inmuebles    â”‚ â”‚
                      â”‚ â”‚ que originalmente estaban     â”‚ â”‚
                      â”‚ â”‚ bajo la Ley NÂ°6.071 sobre     â”‚ â”‚
                      â”‚ â”‚ Propiedad Horizontal. Se      â”‚ â”‚
                      â”‚ â”‚ estableciÃ³ en el punto 3...   â”‚ â”‚
                      â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                      â”‚ (fondo amarillo, scroll si largo) â”‚
                      â”‚                                   â”‚
                      â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                      â”‚ â”‚ ğŸ’¡ Este extracto fue usado... â”‚ â”‚
                      â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                      â”‚                                   â”‚
                      â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                      â”‚ â”‚ ğŸ”— Ver documento completo     â”‚ â”‚
                      â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                      â”‚                                   â”‚
                      â”‚ Presiona ESC o click afuera       â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Elementos a verificar:**
- [ ] Panel aparece desde la **derecha**
- [ ] **Backdrop** semitransparente detrÃ¡s
- [ ] Header con **tÃ­tulo "Referencia [X]"**
- [ ] **Nombre de fuente** visible (Cir32.pdf)
- [ ] **Barra de similitud** con color (verde >80%, amarillo >60%, naranja <60%)
- [ ] **Chunk number** visible (ej: Chunk #6)
- [ ] **Token count** visible (ej: 450 tokens)
- [ ] **PÃ¡ginas** si hay metadata
- [ ] **Texto completo** con fondo amarillo destacado
- [ ] **BotÃ³n** "Ver documento completo" presente
- [ ] **Click en X** cierra panel
- [ ] **Click en backdrop** cierra panel
- [ ] **Presionar ESC** cierra panel

---

### 4. Context Log con Referencias

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Contexto: 0.05% â€¢ âœ¨ Gemini 2.5 Flash â€¢ 1 fuentes    â”‚ â† Click aquÃ­
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“ (se expande)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Desglose del Contexto                       0.05% usadoâ”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Total Tokens: 493 | Disponible: 999,507 | Cap: 1000K  â”‚
â”‚                                                        â”‚
â”‚ ğŸ“Š Desglose Detallado                                 â”‚
â”‚   System Prompt: 15 tokens                            â”‚
â”‚   Historial (1 mensajes): 10 tokens                   â”‚
â”‚   Contexto de Fuentes: ğŸ” 1 RAG â€¢ 468 tokens         â”‚
â”‚                        ^^^^^^                          â”‚
â”‚                    (badge verde "RAG")                 â”‚
â”‚                                                        â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                                        â”‚
â”‚ ğŸ“Š Log de Contexto por InteracciÃ³n                    â”‚
â”‚                                                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”   â”‚
â”‚ â”‚Hora â”‚ Pregunta â”‚Modeloâ”‚ Modo â”‚Inputâ”‚Outputâ”‚Uso%â”‚   â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¤   â”‚
â”‚ â”‚12:35â”‚ que sa...â”‚Flash â”‚ğŸ”RAG â”‚  40 â”‚  453 â”‚0.05â”‚   â”‚
â”‚ â”‚     â”‚          â”‚      â”‚3 chk â”‚     â”‚      â”‚    â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜   â”‚
â”‚                                      ^^^^^^            â”‚
â”‚                                  (verde "RAG")         â”‚
â”‚                                  (NO amarillo "Full")  â”‚
â”‚                                                        â”‚
â”‚ â–¼ Ver detalles completos de cada interacciÃ³n          â”‚
â”‚                                                        â”‚
â”‚ #1 - 12:35:22 PM                                      â”‚
â”‚                                                        â”‚
â”‚ Pregunta: que sabemos de esto? "Lo expuesto hasta..." â”‚
â”‚ Modelo: gemini-2.5-flash                              â”‚
â”‚ System Prompt: Eres un asistente de IA Ãºtil...        â”‚
â”‚                                                        â”‚
â”‚ Fuentes activas:                                      â”‚
â”‚ â€¢ ğŸ” Cir32.pdf (2,023 tokens - RAG)                   â”‚
â”‚       ^^^^^^                                           â”‚
â”‚   (Ã­cono verde "RAG" - NO azul "Full")                â”‚
â”‚                                                        â”‚
â”‚ ğŸ” ConfiguraciÃ³n RAG:                                 â”‚
â”‚   Habilitado: SÃ­                                      â”‚
â”‚   Realmente usado: SÃ­ â† NO "No (fallback)"           â”‚
â”‚   Fallback: No â† Debe decir "No"                     â”‚
â”‚   TopK: 5                                             â”‚
â”‚   Similaridad mÃ­nima: 0.5                             â”‚
â”‚   âœ… RAG Optimizado: 3 chunks relevantes              â”‚
â”‚       Avg Similarity: 76.3%                           â”‚
â”‚       Total Tokens: 1,120                             â”‚
â”‚                                                        â”‚
â”‚ ğŸ“š Referencias utilizadas (3 chunks): â† NUEVA SECCIÃ“Nâ”‚
â”‚                                                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚ â”‚ [1] Cir32.pdf                    85.0% âœ“    â”‚â†Clickâ”‚
â”‚ â”‚     "El documento estÃ¡ analizando una..."    â”‚     â”‚
â”‚ â”‚     Chunk #6 â€¢ 450 tokens                    â”‚     â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚ â”‚ [2] Cir32.pdf                    73.0% âœ“    â”‚â†Clickâ”‚
â”‚ â”‚     "Se establece en el punto 3 que la..."   â”‚     â”‚
â”‚ â”‚     Chunk #9 â€¢ 380 tokens                    â”‚     â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚ â”‚ [3] Cir32.pdf                    68.0% âœ“    â”‚â†Clickâ”‚
â”‚ â”‚     "El punto 4 indica que la Ley NÂ°19..."  â”‚     â”‚
â”‚ â”‚     Chunk #12 â€¢ 290 tokens                   â”‚     â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                        â”‚
â”‚ Respuesta: [ver respuesta completa arriba]           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¨ Color Coding

### Thinking Steps:
- **Pending** (â­•): CÃ­rculo gris, texto gris claro
- **Active** (ğŸ”„): Spinner azul, texto negro bold
- **Complete** (âœ“): Checkmark verde, texto gris

### RAG Mode Badge:
- **ğŸ” RAG**: Verde (`bg-green-100 text-green-700`)
- **âš ï¸ Full**: Amarillo (`bg-yellow-100 text-yellow-700`) - solo si fallback
- **ğŸ“ Full**: Azul (`bg-blue-100 text-blue-700`) - si RAG desactivado

### Similarity Colors:
- **â‰¥80%**: Verde (`bg-green-100 text-green-700`)
- **60-79%**: Amarillo (`bg-yellow-100 text-yellow-700`)
- **<60%**: Naranja (`bg-orange-100 text-orange-700`)

### Reference Badges:
- **Default**: `bg-blue-100 text-blue-700 border-blue-300`
- **Hover**: `bg-blue-200 border-blue-400`
- **Font**: Bold, pequeÃ±o (text-sm)
- **Position**: Superscript (arriba del texto)

---

## ğŸ–±ï¸ Interacciones

### Hover sobre badge [X]:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [1]                 â”‚ â† Cursor: pointer
â”‚ ^^^                 â”‚ â† Background: mÃ¡s claro
â”‚ Border: mÃ¡s oscuro  â”‚
â”‚ Tooltip: "Click..." â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Click en badge [X]:
```
[Badge] â†’ Click â†’ onReferenceClick(reference)
                      â†“
                setSelectedReference(reference)
                      â†“
                ReferencePanel appears
                      â†“
                Backdrop dims screen
                      â†“
                Panel slides in from right
```

### Click en referencia del footer:
```
[Referencia card] â†’ Click â†’ Same as badge click
                           â†“
                     Opens ReferencePanel
```

### Click en referencia del context log:
```
[Referencia en log] â†’ Click â†’ Opens ReferencePanel
                              â†“
                        Shows chunk details
```

---

## âš ï¸ Lo que NO debe aparecer

### âŒ En Console:
```
âŒ "âš ï¸ RAG: No results above similarity threshold, falling back to full documents"
âŒ "âš ï¸ RAG search failed, using full documents"
âŒ "ğŸ“ Including full context from X active sources (full-text mode)"
   (si RAG estÃ¡ activado y hay chunks disponibles)
```

### âŒ En UI:
```
âŒ Modo: âš ï¸ Full (fallback)
        ^^^^^^^^^^^^^^^^
   (si hay chunks disponibles)

âŒ Realmente usado: No (fallback)
                   ^^^^^^^^^^^^^^
   (si hay chunks disponibles)

âŒ âš ï¸ Fallback: RAG no encontrÃ³ chunks relevantes, usÃ³ documentos completos
   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
   (si hay chunks y se hizo retry exitoso)
```

---

## âœ… Lo que SÃ debe aparecer

### âœ… En Console:
```
âœ… "ğŸ” RAG Search starting..."
âœ… "âœ“ Loaded X chunks"
âœ… "âœ“ Found Y similar chunks"
âœ… "âœ… RAG: Using Y relevant chunks (Z tokens)"
âœ… "  Avg similarity: XX.X%"
âœ… "ğŸ“š Built references for message: Y"
âœ… "  [1] Cir32.pdf - 85.0% - Chunk #6"
```

### âœ… En UI - Respuesta:
```
âœ… Badges [1], [2], [3] azules inline
âœ… Footer "ğŸ“š Referencias utilizadas (X)"
âœ… Lista de referencias clickeables
```

### âœ… En UI - Context Log:
```
âœ… Modo: ğŸ” RAG (X chunks) â† Verde
âœ… Habilitado: SÃ­
âœ… Realmente usado: SÃ­ â† Sin "fallback"
âœ… Fallback: No
âœ… SecciÃ³n "ğŸ“š Referencias utilizadas (X chunks)"
âœ… Referencias clickeables
```

---

## ğŸ¯ Quick Verification Steps

1. **Start test:**
   - Open http://localhost:3000/chat
   - Login and select agent M001
   - Verify Cir32.pdf is active (toggle ON)

2. **Send message:**
   ```
   que sabemos de esto? "Lo expuesto hasta ahora lleva a una 
   primera conclusiÃ³n cual es que el caso en consulta debe 
   resolverse teniendo presente la Ley NÂ°19.537"
   ```

3. **Watch progress (should take ~9-12s):**
   - [ ] Pensando... (3s)
   - [ ] Buscando... (3s)
   - [ ] Seleccionando... (3s)
   - [ ] Generando... (streaming)

4. **Check response:**
   - [ ] Has blue badges [1], [2], [3]
   - [ ] Has footer with references
   - [ ] Click badge opens panel
   - [ ] Panel shows chunk details

5. **Check context log:**
   - [ ] Click "Contexto: X%"
   - [ ] Mode shows "ğŸ” RAG (X chunks)" (green)
   - [ ] Expand details
   - [ ] See "ğŸ“š Referencias utilizadas"
   - [ ] Click reference opens panel

6. **Console verification:**
   ```
   âœ… Look for: "âœ… RAG: Using X relevant chunks"
   âœ… Look for: "ğŸ“š Built references for message: X"
   âŒ Should NOT see: "falling back to full documents"
   ```

---

## ğŸ¬ Expected User Experience

### Timeline:
```
00:00 - User sends message
        â†“
00:00 - Sees "Pensando..." with animated dots
        â†“
00:03 - Changes to "Buscando Contexto Relevante..."
        â†“
00:06 - Changes to "Seleccionando Chunks..."
        â†“
00:09 - Changes to "Generando Respuesta..."
        â†“
00:10 - First words of response appear
        â†“
00:12 - Response complete with [1], [2], [3] badges
        â†“
00:13 - User hovers over [1] - sees it's clickable
        â†“
00:14 - User clicks [1] - panel opens from right
        â†“
00:15 - User reads chunk #6 details
        â†“
00:16 - User clicks X to close panel
        â†“
00:17 - User clicks "Contexto: X%" to see log
        â†“
00:18 - User sees "ğŸ” RAG (3 chunks)" - no fallback!
        â†“
00:19 - User expands details
        â†“
00:20 - User sees all 3 references listed
        â†“
00:21 - User clicks reference in log
        â†“
00:22 - Panel opens again with chunk details
        â†“
âœ… User understands exactly what chunks were used!
```

---

## ğŸ’¡ Key Improvements

### Before:
- âŒ Steps showed instantly (no timing)
- âŒ Said "fallback" even when chunks existed
- âŒ No inline references in response
- âŒ No way to see which chunks were used
- âŒ No traceability

### After:
- âœ… Each step shows 3 seconds (visual feedback)
- âœ… Uses chunks when they exist (retry logic)
- âœ… Inline references [1], [2], [3] clickeable
- âœ… Panel shows exact chunk used
- âœ… Footer lists all references
- âœ… Context log tracks everything
- âœ… Complete traceability

---

**Estado:** IMPLEMENTED AND READY TO TEST âœ…

**PrÃ³ximo paso:** Test manually in browser - follow checklist above! ğŸ§ª

