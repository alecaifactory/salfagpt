# Chat State & Analytics Tracking - Fix Completo

## üéØ Problemas Resueltos

### 1. ‚úÖ Chat no cambiaba al seleccionar otro agente
**Problema:** Al crear un agente e interactuar, el chat no se actualizaba al seleccionar otro agente.

**Soluci√≥n:** A√±adido `useEffect` que detecta cambios en `currentConversation` y:
- Limpia mensajes previos
- Carga mensajes del nuevo agente
- Carga contexto activo del agente
- Resetea el input

**Archivo modificado:** `src/components/ChatInterfaceWorking.tsx` (l√≠neas 283-310)

```typescript
// Effect: Handle conversation change - load messages and context
useEffect(() => {
  if (!currentConversation) {
    setMessages([]);
    setContextLogs([]);
    return;
  }

  if (currentConversation.startsWith('temp-')) {
    console.log('‚è≠Ô∏è Conversaci√≥n temporal - no cargando mensajes de Firestore');
    setMessages([]);
    setContextLogs([]);
    return;
  }

  console.log('üîÑ Cambiando a conversaci√≥n:', currentConversation);
  
  // Load messages for this conversation
  loadMessages(currentConversation);
  
  // Load context configuration for this conversation
  loadContextForConversation(currentConversation);
  
  // Reset input
  setInput('');
  
}, [currentConversation]);
```

### 2. ‚úÖ Tracking de Source (localhost vs production)

**Problema:** No hab√≠a forma de distinguir en analytics si los datos ven√≠an de localhost o producci√≥n.

**Soluci√≥n:** A√±adido campo `source` a todas las operaciones de Firestore/BigQuery.

**Archivos modificados:**
- `src/lib/firestore.ts`:
  - Nueva funci√≥n helper: `getEnvironmentSource()`
  - Campo `source` a√±adido a interfaces `Conversation` y `Message`
  - Funci√≥n `createConversation()` ahora incluye `source`
  - Funci√≥n `addMessage()` ahora incluye `source`

```typescript
// Helper function to determine source environment
export function getEnvironmentSource(): 'localhost' | 'production' {
  // Check if running on localhost
  if (typeof window !== 'undefined') {
    return window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
      ? 'localhost' 
      : 'production';
  }
  
  // Server context - check NODE_ENV and other indicators
  if (process.env.NODE_ENV === 'development' || 
      process.env.NODE_ENV === 'dev' ||
      !process.env.K_SERVICE) {  // K_SERVICE is set in Cloud Run
    return 'localhost';
  }
  
  return 'production';
}
```

### 3. üîç Modelo Fundacional en Producci√≥n

**Diagn√≥stico:** El c√≥digo est√° correcto. El problema puede ser:
1. API key no configurada en Cloud Run
2. Variable de entorno mal nombrada
3. L√≠mites de cuota superados

**Verificaci√≥n necesaria:**
```bash
# Verificar variables de entorno en Cloud Run
gcloud run services describe flow-chat \
  --region us-central1 \
  --format='value(spec.template.spec.containers[0].env)'
```

---

## üìä Google Cloud Console - Links Directos

### Firestore Database

#### Ver Colecciones:
```
https://console.cloud.google.com/firestore/databases/-default-/data/panel?project=gen-lang-client-0986191192
```

#### Ver Conversaciones (con campo source):
```
https://console.cloud.google.com/firestore/databases/-default-/data/panel/conversations?project=gen-lang-client-0986191192
```

#### Ver Mensajes (con campo source):
```
https://console.cloud.google.com/firestore/databases/-default-/data/panel/messages?project=gen-lang-client-0986191192
```

### BigQuery Analytics

#### Dataset flow_analytics:
```
https://console.cloud.google.com/bigquery?project=gen-lang-client-0986191192&page=dataset&d=flow_analytics&p=gen-lang-client-0986191192
```

#### Query para ver datos por source:
```sql
-- Conversaciones por source
SELECT 
  source,
  COUNT(*) as total_conversations,
  COUNT(DISTINCT userId) as unique_users
FROM `gen-lang-client-0986191192.flow_analytics.conversations`
GROUP BY source
ORDER BY total_conversations DESC;

-- Mensajes por source
SELECT 
  source,
  role,
  COUNT(*) as total_messages,
  AVG(tokenCount) as avg_tokens
FROM `gen-lang-client-0986191192.flow_analytics.messages`
GROUP BY source, role
ORDER BY total_messages DESC;
```

### Cloud Run Service

#### Ver Service:
```
https://console.cloud.google.com/run/detail/us-central1/flow-chat?project=gen-lang-client-0986191192
```

#### Ver Variables de Entorno:
```
https://console.cloud.google.com/run/detail/us-central1/flow-chat/variables-and-secrets?project=gen-lang-client-0986191192
```

#### Ver Logs:
```
https://console.cloud.google.com/logs/query?project=gen-lang-client-0986191192&query=resource.type%3D%22cloud_run_revision%22%0Aresource.labels.service_name%3D%22flow-chat%22
```

---

## üß™ Testing en Localhost

### 1. Iniciar servidor local
```bash
npm run dev
```

### 2. Abrir navegador
```
http://localhost:3000/chat
```

### 3. Test del cambio de agente
1. ‚úÖ Crear agente 1
2. ‚úÖ Enviar mensaje a agente 1
3. ‚úÖ Crear agente 2
4. ‚úÖ Seleccionar agente 2 (debe limpiar chat)
5. ‚úÖ Enviar mensaje a agente 2
6. ‚úÖ Volver a seleccionar agente 1 (debe mostrar mensaje anterior)

### 4. Verificar en Firestore
```bash
# Ver conversaciones en Firestore
gcloud firestore collections list --project=gen-lang-client-0986191192

# Ver documentos de una conversaci√≥n
gcloud firestore documents list conversations --project=gen-lang-client-0986191192

# Ver datos de un documento espec√≠fico
gcloud firestore documents describe conversations/[CONVERSATION_ID] --project=gen-lang-client-0986191192
```

**Esperado:** Ver campo `source: "localhost"` en los documentos

### 5. Verificar en BigQuery (si est√° configurado)
```sql
SELECT 
  id,
  title,
  source,
  agentModel,
  createdAt
FROM `gen-lang-client-0986191192.flow_analytics.conversations`
WHERE source = 'localhost'
ORDER BY createdAt DESC
LIMIT 10;
```

---

## üîß Arreglar Modelo en Producci√≥n

### Verificar API Key

#### 1. Verificar que existe en Cloud Run
```bash
gcloud run services describe flow-chat \
  --region us-central1 \
  --format='json(spec.template.spec.containers[0].env)' | \
  jq '.spec.template.spec.containers[0].env[] | select(.name | contains("API_KEY"))'
```

#### 2. Si no existe, a√±adir:
```bash
# Obtener tu API key de AI Studio:
# https://aistudio.google.com/app/apikey

# A√±adir a Cloud Run
gcloud run services update flow-chat \
  --region us-central1 \
  --set-env-vars="GOOGLE_AI_API_KEY=TU_API_KEY_AQUI" \
  --project=gen-lang-client-0986191192
```

#### 3. Verificar logs de producci√≥n
```bash
# Ver logs recientes
gcloud logging read \
  "resource.type=cloud_run_revision AND resource.labels.service_name=flow-chat" \
  --limit 50 \
  --format json \
  --project=gen-lang-client-0986191192 | \
  jq -r '.[] | "\(.timestamp) \(.textPayload // .jsonPayload.message)"'
```

**Buscar mensajes como:**
- ‚úÖ `"ü§ñ Gemini AI initialized with model: gemini-2.5-flash"`
- ‚ùå `"‚ö†Ô∏è No Google AI API key found"`
- ‚ùå `"API key not valid"`

---

## üìä Estructura de Datos con Source

### Firestore Collections

#### conversations
```json
{
  "id": "conv_abc123",
  "userId": "user_xyz",
  "title": "Nuevo Agente",
  "agentModel": "gemini-2.5-flash",
  "source": "localhost",  // üëà NUEVO CAMPO
  "createdAt": "2025-10-12T10:00:00Z",
  "updatedAt": "2025-10-12T10:00:00Z",
  "lastMessageAt": "2025-10-12T10:05:00Z",
  "messageCount": 2,
  "contextWindowUsage": 15
}
```

#### messages
```json
{
  "id": "msg_def456",
  "conversationId": "conv_abc123",
  "userId": "user_xyz",
  "role": "user",
  "content": {
    "type": "text",
    "text": "Hola, ¬øc√≥mo est√°s?"
  },
  "source": "localhost",  // üëà NUEVO CAMPO
  "timestamp": "2025-10-12T10:00:00Z",
  "tokenCount": 25
}
```

---

## üîç Troubleshooting

### Problema: Chat sigue sin cambiar al seleccionar agente

**Verificar:**
1. ‚úÖ Abrir DevTools (F12)
2. ‚úÖ Ver Console
3. ‚úÖ Buscar mensaje: `üîÑ Cambiando a conversaci√≥n: [ID]`
4. ‚úÖ Buscar errores relacionados con `loadMessages` o `loadContextForConversation`

**Si no aparece el mensaje:**
```bash
# Verificar que el c√≥digo se despleg√≥
git log --oneline -1
git diff HEAD -- src/components/ChatInterfaceWorking.tsx
```

### Problema: Campo source no aparece en Firestore

**Verificar:**
1. ‚úÖ Limpiar cache del navegador
2. ‚úÖ Crear nueva conversaci√≥n
3. ‚úÖ Verificar en Firestore Console
4. ‚úÖ Si sigue sin aparecer, revisar logs:

```bash
# Ver logs de creaci√≥n de conversaci√≥n
gcloud logging read \
  "resource.type=cloud_run_revision AND textPayload=~'Conversation created from'" \
  --limit 10 \
  --format json \
  --project=gen-lang-client-0986191192
```

### Problema: Modelo no responde en producci√≥n

**Pasos de diagn√≥stico:**

1. **Verificar API Key:**
```bash
gcloud run services describe flow-chat \
  --region us-central1 \
  --format='value(spec.template.spec.containers[0].env)' | \
  grep -i api_key
```

2. **Ver logs de error:**
```bash
gcloud logging read \
  "resource.type=cloud_run_revision AND severity>=ERROR" \
  --limit 20 \
  --project=gen-lang-client-0986191192
```

3. **Probar endpoint directamente:**
```bash
# Obtener URL del servicio
SERVICE_URL=$(gcloud run services describe flow-chat \
  --region us-central1 \
  --format='value(status.url)')

# Test con curl (requiere autenticaci√≥n v√°lida)
curl -X POST "${SERVICE_URL}/api/conversations/[CONV_ID]/messages" \
  -H "Content-Type: application/json" \
  -H "Cookie: flow_session=[YOUR_JWT_TOKEN]" \
  -d '{
    "userId": "user_id",
    "message": "test",
    "model": "gemini-2.5-flash",
    "systemPrompt": "You are helpful"
  }'
```

4. **Verificar cuota de API:**
```
https://aistudio.google.com/app/apikey
```
- Revisar l√≠mites de uso
- Verificar que la key no est√© bloqueada

---

## üìà Analytics Queries √ötiles

### Comparar uso entre localhost y production

```sql
-- Dashboard de uso por environment
WITH stats AS (
  SELECT 
    source,
    COUNT(DISTINCT c.id) as conversations,
    COUNT(m.id) as messages,
    AVG(m.tokenCount) as avg_tokens_per_message,
    SUM(m.tokenCount) as total_tokens
  FROM `gen-lang-client-0986191192.flow_analytics.conversations` c
  LEFT JOIN `gen-lang-client-0986191192.flow_analytics.messages` m
    ON c.id = m.conversationId
  GROUP BY source
)
SELECT 
  source,
  conversations,
  messages,
  ROUND(avg_tokens_per_message, 2) as avg_tokens,
  total_tokens,
  ROUND(messages / conversations, 2) as messages_per_conversation
FROM stats
ORDER BY conversations DESC;
```

### Ver actividad por d√≠a y source

```sql
SELECT 
  DATE(createdAt) as date,
  source,
  COUNT(*) as conversations_created,
  COUNT(DISTINCT userId) as unique_users
FROM `gen-lang-client-0986191192.flow_analytics.conversations`
GROUP BY date, source
ORDER BY date DESC, conversations_created DESC;
```

### Identificar problemas de producci√≥n

```sql
-- Conversaciones sin mensajes (posibles errores)
SELECT 
  c.id,
  c.source,
  c.createdAt,
  c.messageCount
FROM `gen-lang-client-0986191192.flow_analytics.conversations` c
LEFT JOIN `gen-lang-client-0986191192.flow_analytics.messages` m
  ON c.id = m.conversationId
WHERE c.messageCount > 0 AND m.id IS NULL
ORDER BY c.createdAt DESC;
```

---

## üöÄ Deploy a Producci√≥n

### Antes de deployar
```bash
# 1. Verificar cambios
git status

# 2. Commit cambios
git add .
git commit -m "fix: A√±adir cambio de conversaci√≥n y tracking de source"

# 3. Type check
npm run type-check

# 4. Build local
npm run build
```

### Deploy a Cloud Run
```bash
# Set project
gcloud config set project gen-lang-client-0986191192

# Deploy
gcloud run deploy flow-chat \
  --source . \
  --region us-central1 \
  --allow-unauthenticated \
  --set-env-vars="GOOGLE_CLOUD_PROJECT=gen-lang-client-0986191192,NODE_ENV=production"
```

### Verificar despu√©s de deploy
```bash
# 1. Test health check
curl https://flow-chat-[hash]-uc.a.run.app/api/health

# 2. Ver logs de startup
gcloud logging read \
  "resource.type=cloud_run_revision AND textPayload=~'Firestore client initialized'" \
  --limit 5 \
  --project=gen-lang-client-0986191192

# 3. Test chat endpoint (con autenticaci√≥n v√°lida)
```

---

## ‚úÖ Checklist de Verificaci√≥n

### Localhost
- [ ] Chat cambia al seleccionar diferentes agentes
- [ ] Mensajes se cargan correctamente al cambiar de agente
- [ ] Campo `source: "localhost"` aparece en Firestore
- [ ] Consola muestra: `üîÑ Cambiando a conversaci√≥n: [ID]`
- [ ] Consola muestra: `üìù Conversation created from localhost`
- [ ] Consola muestra: `üí¨ Message created from localhost`

### Producci√≥n
- [ ] Chat cambia al seleccionar diferentes agentes
- [ ] Modelo AI responde correctamente
- [ ] Campo `source: "production"` aparece en Firestore
- [ ] Logs muestran: `Conversation created from production`
- [ ] No hay errores de API key en logs
- [ ] Variables de entorno configuradas correctamente

### Analytics
- [ ] BigQuery recibe datos con campo `source`
- [ ] Query de comparaci√≥n localhost vs production funciona
- [ ] Dashboard muestra m√©tricas separadas por source

---

## üìù Logs Importantes a Buscar

### √âxito
```
‚úÖ Firestore client initialized successfully
‚úÖ üîÑ Cambiando a conversaci√≥n: conv_xyz
‚úÖ üìù Conversation created from localhost: conv_abc
‚úÖ üí¨ Message created from localhost: msg_def
‚úÖ ü§ñ Generating response with model: gemini-2.5-flash
```

### Errores
```
‚ùå Error loading messages: [error details]
‚ùå ‚ö†Ô∏è No Google AI API key found
‚ùå Error fetching messages: [details]
‚ùå Failed to send message
```

---

## üéØ Pr√≥ximos Pasos

1. **Verificar en localhost** ‚úÖ
2. **Commit y push cambios** ‚úÖ
3. **Deploy a producci√≥n** ‚è≥
4. **Configurar API key en Cloud Run** ‚è≥
5. **Verificar en producci√≥n** ‚è≥
6. **Monitorear analytics** ‚è≥

---

**√öltima actualizaci√≥n:** 2025-10-12  
**Estado:** ‚úÖ C√≥digo listo para test en localhost  
**Deploy a producci√≥n:** ‚è≥ Pendiente

