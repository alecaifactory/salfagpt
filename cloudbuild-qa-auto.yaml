# Cloud Build Configuration for QA Auto-Deployment
# 
# Trigger: Push to develop branch
# Target: cr-salfagpt-qa service in salfagpt-qa project
# 
# This configuration automatically deploys to QA when develop branch is updated
# Provides fast feedback loop for integrated features
# 
# Setup trigger with:
# gcloud builds triggers create github \
#   --repo-name=salfagpt \
#   --repo-owner=<your-github-org> \
#   --branch-pattern="^develop$" \
#   --build-config=cloudbuild-qa-auto.yaml \
#   --project=salfagpt-qa

substitutions:
  _ENVIRONMENT: 'qa'
  _SERVICE_NAME: 'cr-salfagpt-qa'
  _REGION: 'us-east4'
  _MIN_INSTANCES: '0'
  _MAX_INSTANCES: '5'
  _MEMORY: '2Gi'
  _CPU: '1'

steps:
  # Step 1: Build Docker image
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-image'
    args:
      - 'build'
      - '-t'
      - '${_REGION}-docker.pkg.dev/$PROJECT_ID/salfagpt/${_SERVICE_NAME}:$SHORT_SHA'
      - '-t'
      - '${_REGION}-docker.pkg.dev/$PROJECT_ID/salfagpt/${_SERVICE_NAME}:latest'
      - '-t'
      - '${_REGION}-docker.pkg.dev/$PROJECT_ID/salfagpt/${_SERVICE_NAME}:develop'
      - '--build-arg'
      - 'NODE_ENV=production'
      - '--build-arg'
      - 'ENVIRONMENT_NAME=qa'
      - '.'
    waitFor: ['-']
  
  # Step 2: Push Docker image
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-image'
    args:
      - 'push'
      - '--all-tags'
      - '${_REGION}-docker.pkg.dev/$PROJECT_ID/salfagpt/${_SERVICE_NAME}'
    waitFor: ['build-image']
  
  # Step 3: Deploy to Cloud Run
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy'
    entrypoint: 'gcloud'
    args:
      - 'run'
      - 'deploy'
      - '${_SERVICE_NAME}'
      - '--image=${_REGION}-docker.pkg.dev/$PROJECT_ID/salfagpt/${_SERVICE_NAME}:$SHORT_SHA'
      - '--region=${_REGION}'
      - '--platform=managed'
      - '--allow-unauthenticated'
      - '--min-instances=${_MIN_INSTANCES}'
      - '--max-instances=${_MAX_INSTANCES}'
      - '--memory=${_MEMORY}'
      - '--cpu=${_CPU}'
      - '--timeout=300s'
      - '--concurrency=80'
      # Environment variables
      - '--set-env-vars=NODE_ENV=production,GOOGLE_CLOUD_PROJECT=$PROJECT_ID,ENVIRONMENT_NAME=qa,CHUNK_SIZE=1000,CHUNK_OVERLAP=200,EMBEDDING_BATCH_SIZE=100,TOP_K=5,EMBEDDING_MODEL=textembedding-gecko@003'
      # Secrets from Secret Manager
      - '--set-secrets=GOOGLE_AI_API_KEY=google-ai-api-key:latest,GOOGLE_CLIENT_ID=google-client-id:latest,GOOGLE_CLIENT_SECRET=google-client-secret:latest,JWT_SECRET=jwt-secret:latest'
      # Labels for tracking
      - '--labels=environment=qa,branch=develop,commit=$SHORT_SHA,managed-by=cloud-build'
    waitFor: ['push-image']
  
  # Step 4: Update PUBLIC_BASE_URL
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'update-url'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        SERVICE_URL=$$(gcloud run services describe ${_SERVICE_NAME} \
          --region=${_REGION} \
          --format='value(status.url)')
        
        gcloud run services update ${_SERVICE_NAME} \
          --region=${_REGION} \
          --update-env-vars="PUBLIC_BASE_URL=$$SERVICE_URL,SESSION_COOKIE_NAME=salfagpt_qa_session"
        
        echo "âœ… PUBLIC_BASE_URL set to: $$SERVICE_URL"
    waitFor: ['deploy']
  
  # Step 5: Health check
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'health-check'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        SERVICE_URL=$$(gcloud run services describe ${_SERVICE_NAME} \
          --region=${_REGION} \
          --format='value(status.url)')
        
        echo "ðŸ¥ Health check: $$SERVICE_URL/api/health"
        
        # Wait for service to be ready (max 2 minutes)
        for i in {1..24}; do
          HTTP_CODE=$$(curl -s -o /dev/null -w "%{http_code}" $$SERVICE_URL)
          if [ $$HTTP_CODE -eq 200 ] || [ $$HTTP_CODE -eq 302 ]; then
            echo "âœ… Health check passed! HTTP $$HTTP_CODE"
            exit 0
          fi
          echo "â³ Waiting for service... (attempt $$i/24) HTTP $$HTTP_CODE"
          sleep 5
        done
        
        echo "âš ï¸  Health check timeout (service may still be starting)"
        exit 0
    waitFor: ['update-url']
  
  # Step 6: Record deployment
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'track-deployment'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ðŸ“ QA Auto-Deployment Recorded"
        echo "Branch: develop"
        echo "Commit: $SHORT_SHA"
        echo "Build ID: $BUILD_ID"
        echo "Deployed at: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
        
        # Store deployment metadata in Cloud Storage
        cat > /tmp/deployment.json << EOF
        {
          "environment": "qa",
          "branch": "develop",
          "commit": "$COMMIT_SHA",
          "shortCommit": "$SHORT_SHA",
          "deployedAt": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "buildId": "$BUILD_ID",
          "triggeredBy": "auto-deploy"
        }
        EOF
        
        # Save to Cloud Storage (create bucket first if needed)
        gsutil mb -p $PROJECT_ID gs://${PROJECT_ID}-deployments 2>/dev/null || true
        gsutil cp /tmp/deployment.json gs://${PROJECT_ID}-deployments/qa-latest.json
        gsutil cp /tmp/deployment.json gs://${PROJECT_ID}-deployments/qa-$(date +%Y%m%d-%H%M%S).json
    waitFor: ['health-check']

# Docker images to keep
images:
  - '${_REGION}-docker.pkg.dev/$PROJECT_ID/salfagpt/${_SERVICE_NAME}:$SHORT_SHA'
  - '${_REGION}-docker.pkg.dev/$PROJECT_ID/salfagpt/${_SERVICE_NAME}:latest'
  - '${_REGION}-docker.pkg.dev/$PROJECT_ID/salfagpt/${_SERVICE_NAME}:develop'

# Build configuration
options:
  machineType: 'E2_HIGHCPU_8'
  diskSizeGb: 50
  logging: CLOUD_LOGGING_ONLY

# Total timeout
timeout: '1200s'  # 20 minutes

