# üîß Soluci√≥n: Referencias RAG Correctas con % Similitud - 2025-10-20

## üéØ Problemas Identificados

### Problema 1: AI No Cita Chunks Espec√≠ficos
**Issue:** El AI recibe chunks RAG pero no sabe que debe citarlos con sus √≠ndices.

**Root Cause:** El system prompt no indica al AI qu√© chunks espec√≠ficos recibi√≥ ni c√≥mo citarlos.
Chunk #1
371 tokens
Aqu√≠ est√° el texto completo del documento, incluyendo su estructura y la tabla en formato Markdown: --- DDU 32 **CIRCULAR ORD. N¬∞ 0177** **MAT.:** Ley N¬∞19.537 Copropiedad Inmobiliaria. **COPROPIEDAD INMOBILIARIA; SUBDIVISION TERRENO.** SANTIAGO, 6 de Marzo de 1998 **DE :** JEFE DIVISION DE DESARROLLO URBANO. **A :** SEGUN DISTRIBUCION. 1. La Divisi√≥n de Desarrollo Urbano en cumplimiento al art√≠culo 4¬∫ de la Ley General de Urbanismo y Construcciones ha estimado conveniente transcribir aquellas partes del informe en derecho emitido por la Divisi√≥n Jur√≠dica de este Ministerio, relativo a la posibilidad de subdividir inmuebles acogido a la Ley N¬∫6.071 sobre Propiedad Horizontal. 2. Con fecha 16 de Diciembre de 1997 se public√≥ en el Diario Oficial, la ley N¬∞19.537, sobre Copropiedad Inmobiliaria, que regula un r√©gimen especial de propiedad inmobiliaria, con el objeto de establecer condominios integrados por inmuebles divididos en unidades sobre las cuales se pueda constituir dominio exclusivo a favor de distintos propietarios, manteniendo uno o m√°s bienes en el dominio com√∫n de todos ellos. 3. La ley N¬∫19.537 en el art√≠culo 48 deroga expresamente la ley N¬∫6.071, cuyo texto definitivo se hab√≠a fijado en el Cap√≠tulo V del decreto supremo N¬∞880, del Ministerio de Obras P√∫blicas, de 1963, subsistente hasta esa fecha por expresa disposici√≥n del inciso segundo del art√≠culo 169 del decreto con fuerza de ley N¬∞458, de 1975, Ley General de Urbanismo y Construcciones.

Chunk #2
465 tokens
4. Conforme al art√≠culo 49 de la ley N¬∞19.537, ella se aplica a las comunidades de copropietarios acogidos a la ley N¬∫6.071, de Propiedad Horizontal, con anterioridad a su vigencia, excepto en lo relativo al cambio de destino de las unidades, a la proporci√≥n o porcentaje que a cada propietario corresponde sobre los bienes comunes y en el pago de los gastos comunes y a derechos de uso y goce exclusivo sobre bienes de dominio com√∫n legalmente constituidos, sin perjuicio que por acuerdo un√°nime los copropietarios resuelvan que tambi√©n estas materias quedar√°n regidas por la nueva legislaci√≥n. 5. Lo expuesto hasta ahora lleva a una primera conclusi√≥n cual es que el caso en consulta debe resolverse teniendo presente la Ley N¬∫19.537, desde el momento que la ley N¬∞6.071 hoy en d√≠a se encuentra derogada y la materia en an√°lisis no dice relaci√≥n con las situaciones de excepci√≥n que se han consignado, como quiera que en la especie se trata de subdividir el predio en que se encuentra construido el condominio de manera de segregar del terreno de mayor extensi√≥n un lote en que se encontraba edificada una construcci√≥n desde el momento que se solicit√≥ el permiso municipal para edificar el condominio, oportunidad en que se plante√≥ mantenerla en el predio y destinarla a casa-club del mismo. 6. La ley N¬∞19.537 no contiene entre sus disposiciones una norma que prohiba subdividir el terreno en que se encuentra construido un condominio, como s√≠ la conten√≠a la ley N¬∞6.071 cuyo art√≠culo 60 inciso primero dispon√≠a expresamente que mientras existiera el edificio, ninguno de los propietarios pod√≠a pedir la divisi√≥n del suelo y de los dem√°s bienes comunes, lo que lleva a una segunda conclusi√≥n cual es que no existir√≠a impedimento por esta causa para que los copropietarios pidieran a la Direcci√≥n de Obras Municipales permiso para subdividir el terreno.

Chunk #3
429 tokens
7. La conclusi√≥n anterior no se ve alterada por lo dispuesto en el inciso segundo del art√≠culo 14 de la ley N¬∫19.537, en orden a que los bienes comunes a que se refieren la letras a), b) y c) del n√∫mero 3 del art√≠culo 2¬∫ de dicha ley, entre ellos los terrenos de dominio com√∫n, no pueden dejar de ser comunes mientras mantengan las caracter√≠sticas que determina su clasificaci√≥n en estas categor√≠as, toda vez que la clasificaci√≥n del terreno como bien com√∫n en el caso en informe tuvo su origen en la aplicaci√≥n de la ley N¬∫6.071 que no categorizaba los bienes de dominio com√∫n como lo hace la actual ley N¬∞19.537 de manera que el terreno era siempre un bien com√∫n cuya divisi√≥n, como se ha expresado, estaba siempre prohibida por la ley mientras existiera la edificaci√≥n acogida a la copropiedad. 8. La posibilidad de subdividir el terreno en que se encuentra emplazado el condominio en informe se ve confirmada por otra parte si se considera que tal subdivisi√≥n tendr√° por objeto enajenar el terreno que se segregar√° del resto del terreno com√∫n, circunstancia que hace aplicable a su respecto lo dispuesto en el art√≠culo 14 inciso tercero de la ley N¬∫19.537 que se√±ala que pueden enajenarse, previo acuerdo de la asamblea de copropietarios, los bienes de dominio com√∫n mencionados en las letra a), b) y c), entre ellos el terreno com√∫n, cuando por circunstancias sobrevivientes dejen de tener las caracter√≠sticas se√±aladas en dichas letras, esto es, dejen de ser necesarios para la existencia, seguridad y conservaci√≥n del condominio, no sean de aquellos que permitan a todos y a cada uno de los copropietarios el uso y goce de las unidades de su dominio exclusivo y no colinden con un unidad del condominio.".

Chunk #4
512 tokens
9. A mayor abundamiento debe tenerse presente el art√≠culo 17 de la ley N¬∞19.537 que prescribe que todo lo concerniente a la administraci√≥n del condominio debe ser resuelto por los copropietarios reunidos en asamblea y agrega en el inciso quinto n√∫mero 4 que debe tratarse en sesiones extraordinarias de la asamblea la enajenaci√≥n de bienes de dominio com√∫n, con lo que reconoce una vez m√°s que los bienes de dominio com√∫n pueden ser objeto de enajenaci√≥n. 10. Finalmente debe tambi√©n traerse a colaci√≥n el n√∫mero 6 del inciso quinto del art√≠culo 17 de la ley N¬∞19.537 que reconoce que puede solicitarse a la Direcci√≥n de Obras Municipales que modifique la declaraci√≥n que acogi√≥ el condominio al r√©gimen de copropiedad inmobiliaria, lo que proceder√≠a en el caso en informe, debiendo tratarse la materia en sesi√≥n extraordinaria, conforme a lo prescrito, en el art√≠culo 19 inciso tercero de la ley N¬∞19.537, esto es, con la asistencia de los copropietarios que representen, a lo menos, el 80% de los derechos en el condominio y adoptarse el acuerdo respectivo con el voto favorable de los asistentes que representen, a lo menos, el 75% de los derechos en el condominio. 11. En conclusi√≥n, y de acuerdo a los preceptos legales que se citan como fundamento, en opini√≥n de esta Divisi√≥n ser√≠a legalmente procedente la subdivisi√≥n del terreno en que se encuentra emplazado el condominio a que alude la consulta, tr√°mite que, luego de adoptarse el acuerdo respectivo con los qu√≥rum que se√±ala la ley, conforme a lo prescrito en el art√≠culo 38 de la ley N¬∞19.537 en la pr√°ctica debe materializarse requiriendo de la Direcci√≥n de Obras Municipales que modifique la declaratoria que acogi√≥ el condominio al r√©gimen de copropiedad, de manera de proceder luego a segregar el pa√±o de terreno que interesa del resto del condominio, terreno respecto del cual, conforme a lo prescrito en el art√≠culo 38 inciso segundo de la misma ley se formar√° una comunidad entre los copropietarios que se regir√° por las normas del derecho com√∫n y har√° factible su enajenaci√≥n.‚Äù.

Chunk #5
241 tokens
Saluda atentamente a Ud., **JAIME SILVA ARANCIBIA** Jefe Divisi√≥n Desarrollo Urbano **CIRCULARES VIGENTES DE ESTA SERIE** | 1 | 3 | 4 | 6 | 7 | 9 | 10 | 12 | 14 | 15 | | :-- | :-- | :-- | :-- | :-- | :-- | :-- | :-- | :-- | :-- | | 16 | 17 | 18 | 19 | 20 | 21 | 22 | 23 | 24 | 25 | | 26 | 27 | 28 | 29 | 30 | 31 | | | | | ESE/MBH/cga. **DISTRIBUCION** 1. Sr. Ministro de Vivienda y
**Screenshot Evidence:**
- Se ve "100.0% similar" en lugar del % real
- Referencias show "Chunk #0 ‚Ä¢ 2,023 tokens" pero deber√≠a mostrar el chunk real usado

### Problema 2: Referencias No Clickeables
**Issue:** Los [1], [2], [3] aparecen como texto plano, no como badges azules clickeables.

**Root Cause:** El AI no est√° incluyendo los n√∫meros de referencia inline en su respuesta.

### Problema 3: Inconsistencia en Cantidad de Referencias
**Issue:** Se ven m√∫ltiples [√≠ndices] en el texto pero solo 1 referencia aparece debajo.

**Root Cause:** Solo se muestra la primera referencia, las dem√°s no se procesan.

### Problema 4: Modo Full-Text Cuando Deber√≠a Ser RAG
**Issue:** El log muestra "Full-Text (Completo)" cuando RAG est√° habilitado y chunks existen.

**Root Cause:** La detecci√≥n de modo en el log depende de chunkIndex === -1, pero esto no refleja si RAG fue realmente usado.

---

## ‚úÖ Soluci√≥n Completa

### Cambio 1: Mejorar System Prompt para RAG

**Archivo:** `src/lib/gemini.ts` - funci√≥n `streamAIResponse`

**Cambio:**
Cuando se env√≠an chunks RAG al AI, el system prompt debe:
1. Indicar que se enviaron fragmentos espec√≠ficos (no el documento completo)
2. Pedir al AI que cite cada fragmento por su n√∫mero
3. Explicar el formato esperado de las citas

```typescript
// ANTES (l√≠neas 386-399):
if (userContext) {
  fullUserMessage = `Context:\n${userContext}\n\nUser Message:\n${userMessage}`;
  
  enhancedSystemInstruction = `${systemInstruction}

IMPORTANTE: Cuando uses informaci√≥n de los documentos de contexto:
- Incluye referencias numeradas inline usando el formato [1], [2], etc.
- Coloca la referencia INMEDIATAMENTE despu√©s de la informaci√≥n que uses
- S√© espec√≠fico: cada dato del documento debe tener su referencia

Ejemplo:
"Las construcciones en subterr√°neo deben cumplir con distanciamientos[1]. La DDU 189 establece zonas inexcavables[2]."`;
}

// DESPU√âS (NUEVO):
if (userContext) {
  // Detectar si el contexto contiene chunks RAG numerados
  const isRAGContext = userContext.includes('[Fragmento ') || userContext.includes('Relevancia:');
  
  if (isRAGContext) {
    // Modo RAG: Extraer n√∫meros de fragmentos
    const fragmentMatches = userContext.match(/\[Fragmento (\d+),/g) || [];
    const fragmentNumbers = fragmentMatches.map(m => {
      const match = m.match(/\[Fragmento (\d+),/);
      return match ? match[1] : null;
    }).filter(Boolean);
    
    fullUserMessage = `FRAGMENTOS RELEVANTES DEL CONTEXTO:
${userContext}

PREGUNTA DEL USUARIO:
${userMessage}`;

    enhancedSystemInstruction = `${systemInstruction}

MODO RAG - INSTRUCCIONES CR√çTICAS:
Te he proporcionado ${fragmentNumbers.length} fragmentos espec√≠ficos del documento, numerados como: ${fragmentNumbers.join(', ')}.

DEBES:
1. Citar cada fragmento que uses con su n√∫mero entre corchetes [N]
2. Colocar la cita INMEDIATAMENTE despu√©s del dato que proviene de ese fragmento
3. Si un dato viene de m√∫ltiples fragmentos, cita todos: [1][2]
4. NO inventes informaci√≥n que no est√© en los fragmentos
5. Si la respuesta requiere informaci√≥n que no est√° en los fragmentos, di "No tengo informaci√≥n sobre..."

FORMATO REQUERIDO:
"La Ley N¬∞19.537 derog√≥ expresamente la Ley N¬∞6.071[1]. Esta ley se aplica a comunidades de copropietarios que estaban acogidas a la ley anterior[2]. Las construcciones en subterr√°neo deben cumplir con distanciamientos[3]."

Fragmentos disponibles: ${fragmentNumbers.join(', ')}
SIEMPRE cita el fragmento cuando uses su informaci√≥n.`;
  } else {
    // Modo Full-Text
    fullUserMessage = `Context:\n${userContext}\n\nUser Message:\n${userMessage}`;
    
    enhancedSystemInstruction = `${systemInstruction}

MODO FULL-TEXT:
Tienes acceso a los documentos completos. Usa la informaci√≥n necesaria para responder.
Incluye referencias al documento cuando sea √∫til: "Seg√∫n [nombre del documento], ..."`;
  }
}
```

---

### Cambio 2: Pasar Informaci√≥n de Chunks al Frontend

**Archivo:** `src/pages/api/conversations/[id]/messages-stream.ts`

**Cambio:** Al construir las referencias, incluir el chunk number real desde ragResults:

```typescript
// ANTES (l√≠neas 251-268):
if (ragUsed && ragResults.length > 0) {
  references = ragResults.map((result, index) => ({
    id: index + 1,
    sourceId: result.sourceId,
    sourceName: result.sourceName,
    chunkIndex: result.chunkIndex,
    similarity: result.similarity,
    snippet: result.text.substring(0, 300),
    fullText: result.text,
    // ... metadata
  }));
}

// DESPU√âS (MEJORADO - agregar fragmentNumber):
if (ragUsed && ragResults.length > 0) {
  references = ragResults.map((result, index) => ({
    id: index + 1,
    sourceId: result.sourceId,
    sourceName: result.sourceName,
    chunkIndex: result.chunkIndex, // Original chunk index in document
    fragmentNumber: result.chunkIndex, // Same as chunkIndex for now
    similarity: result.similarity, // Real similarity score (0-1)
    snippet: result.text.substring(0, 300),
    fullText: result.text,
    metadata: {
      startChar: result.metadata.startChar,
      endChar: result.metadata.endChar,
      tokenCount: result.metadata.tokenCount,
      startPage: result.metadata.startPage,
      endPage: result.metadata.endPage,
      isRAGChunk: true, // NEW: Explicitly mark as RAG chunk
    }
  }));
  
  console.log('üìö Built RAG references:');
  references.forEach(ref => {
    console.log(`  [${ref.id}] Fragmento ${ref.chunkIndex} de ${ref.sourceName} - ${(ref.similarity * 100).toFixed(1)}% similar`);
  });
}
```

---

### Cambio 3: Enviar Mapping de Fragmentos al Cliente

**Archivo:** `src/pages/api/conversations/[id]/messages-stream.ts`

**Nuevo:** Despu√©s de enviar los chunks seleccionados, enviar tambi√©n un mapping de ID ‚Üí Fragmento:

```typescript
// DESPU√âS de l√≠nea 188 (env√≠o de chunks):
if (ragUsed && ragResults.length > 0) {
  const chunkData = `data: ${JSON.stringify({ 
    type: 'chunks',
    chunks: ragStats.sources.map((s: any) => ({
      sourceId: s.id,
      sourceName: s.name,
      chunkCount: s.chunkCount,
      tokens: s.tokens
    }))
  })}\n\n`;
  controller.enqueue(encoder.encode(chunkData));
  
  // NUEVO: Enviar mapping de referencias para que el frontend sepa qu√© esperar
  const fragmentMapping = ragResults.map((result, index) => ({
    refId: index + 1,
    fragmentNumber: result.chunkIndex,
    sourceName: result.sourceName,
    similarity: result.similarity,
  }));
  
  const mappingData = `data: ${JSON.stringify({ 
    type: 'fragmentMapping',
    mapping: fragmentMapping
  })}\n\n`;
  controller.enqueue(encoder.encode(mappingData));
}
```

---

### Cambio 4: Recibir y Almacenar Fragment Mapping en Frontend

**Archivo:** `src/components/ChatInterfaceWorking.tsx`

**Cambio:** En el streaming loop, capturar el fragmentMapping:

```typescript
// DENTRO del while loop de streaming (despu√©s de l√≠nea 1049):
else if (data.type === 'chunks') {
  // Store chunk information for later display
  console.log('üìä Chunks seleccionados:', data.chunks);
} 
// NUEVO:
else if (data.type === 'fragmentMapping') {
  // Store expected fragment citations
  console.log('üó∫Ô∏è Fragment mapping received:', data.mapping);
  // data.mapping = [{ refId: 1, fragmentNumber: 3, sourceName: 'Cir32.pdf', similarity: 0.89 }, ...]
  
  // Store in a ref or state for validation later
  fragmentMappingRef.current = data.mapping;
}
else if (data.type === 'chunk') {
  // ... existing code
}
```

---

### Cambio 5: Validar Citas del AI vs Fragmentos Enviados

**Archivo:** `src/components/ChatInterfaceWorking.tsx`

**Nuevo:** Al terminar el streaming, validar que el AI cit√≥ los fragmentos correctos:

```typescript
else if (data.type === 'complete') {
  // ... c√≥digo existente para marcar mensaje como completo
  
  // NUEVO: Validar citas si tenemos fragment mapping
  if (fragmentMappingRef.current && fragmentMappingRef.current.length > 0) {
    const expectedCitations = fragmentMappingRef.current.map((m: any) => `[${m.refId}]`);
    const foundCitations = [];
    
    for (const citation of expectedCitations) {
      if (accumulatedContent.includes(citation)) {
        foundCitations.push(citation);
      }
    }
    
    console.log('üìã Citation validation:');
    console.log(`  Expected: ${expectedCitations.join(', ')}`);
    console.log(`  Found: ${foundCitations.join(', ')}`);
    console.log(`  Coverage: ${foundCitations.length}/${expectedCitations.length} (${(foundCitations.length / expectedCitations.length * 100).toFixed(0)}%)`);
    
    if (foundCitations.length === 0) {
      console.warn('‚ö†Ô∏è AI did not include any references - this may indicate the prompt was not followed');
    }
  }
}
```

---

### Cambio 6: Mejorar Detecci√≥n de Modo en Context Log

**Archivo:** `src/components/ChatInterfaceWorking.tsx`

**Cambio:** Al crear el context log, usar ragConfiguration.actuallyUsed para determinar el modo:

```typescript
// L√≠nea ~1140 - al guardar context log:
contextSources: activeContextSources.map(source => ({
  name: source.name,
  tokens: source.ragEnabled && ragWasUsed 
    ? ragStatsFromCompletion?.sources?.find((s: any) => s.id === source.id)?.tokens || 2500
    : Math.ceil((source.extractedData?.length || 0) / 4),
  // NUEVO: Mode basado en si RAG fue realmente usado
  mode: ragWasUsed && source.ragEnabled ? 'rag' : 'full-text'
})),

// NUEVO: Agregar flag ragWasUsed del completion event
const ragWasUsed = data.ragConfiguration?.actuallyUsed || false;
const ragStatsFromCompletion = data.ragConfiguration?.stats;
```

---

## üß™ Testing Plan

### Test 1: Verificar RAG Realmente Busca Chunks

**Pasos:**
1. Abrir agente con PDF indexado (Cir32.pdf con 5 chunks)
2. Hacer pregunta espec√≠fica: "¬øQu√© dice sobre la Ley 19.537?"
3. Verificar en console backend:
   ```
   ‚úÖ RAG: Using 3 relevant chunks (1,234 tokens)
     Avg similarity: 78.5%
   ```
4. Verificar NO aparezca:
   ```
   ‚ö†Ô∏è Falling back to full documents
   ```

**Expected:** Console muestra chunks seleccionados con % de similitud real

---

### Test 2: Verificar AI Cita Fragmentos

**Pasos:**
1. Leer la respuesta del AI
2. Buscar n√∫meros entre corchetes: [1], [2], [3]
3. Verificar que son badges azules clickeables (no texto negro)

**Expected:**
- ‚úÖ [1], [2], [3] son badges azules con hover effect
- ‚úÖ Click abre ReferencePanel con chunk details
- ‚úÖ % de similitud mostrado es el real (ej: 78.5%, no 100%)

---

### Test 3: Verificar Context Log Muestra Modo Correcto

**Pasos:**
1. Abrir "Desglose del Contexto"
2. Ver tabla de "Log de Contexto por Interacci√≥n"
3. Verificar columna "Modo"

**Expected:**
- ‚úÖ Muestra "üîç RAG" cuando RAG fue usado
- ‚úÖ Muestra "5 chunks" debajo del badge
- ‚úÖ NO muestra "üìù Full" cuando RAG est√° activo

---

### Test 4: Verificar Todas las Referencias Son Clickeables

**Pasos:**
1. Contar cu√°ntos [N] aparecen en la respuesta del AI
2. Verificar que todos sean clickeables
3. Click en cada uno
4. Verificar abre ReferencePanel con info correcta

**Expected:**
- ‚úÖ Cada [N] en texto ‚Üí badge azul clickeable
- ‚úÖ ReferencePanel muestra chunk espec√≠fico
- ‚úÖ % similitud es el real del RAG search

---

## üìã Checklist de Implementaci√≥n

### Backend Changes
- [ ] `src/lib/gemini.ts` - Mejorar system prompt para RAG mode
- [ ] `src/lib/gemini.ts` - Detectar si context es RAG y ajustar instrucciones
- [ ] `src/pages/api/conversations/[id]/messages-stream.ts` - Enviar fragmentMapping al frontend
- [ ] `src/pages/api/conversations/[id]/messages-stream.ts` - Marcar referencias con isRAGChunk: true

### Frontend Changes
- [ ] `src/components/ChatInterfaceWorking.tsx` - Agregar fragmentMappingRef
- [ ] `src/components/ChatInterfaceWorking.tsx` - Capturar fragmentMapping event
- [ ] `src/components/ChatInterfaceWorking.tsx` - Validar citas del AI
- [ ] `src/components/ChatInterfaceWorking.tsx` - Usar ragConfiguration.actuallyUsed para mode en logs

### Component Updates
- [ ] `src/components/MessageRenderer.tsx` - Verificar procesa m√∫ltiples referencias
- [ ] `src/components/ReferencePanel.tsx` - Verificar muestra % similitud correcto

### Testing
- [ ] Test 1: RAG realmente busca chunks
- [ ] Test 2: AI cita fragmentos inline
- [ ] Test 3: Context log muestra modo correcto
- [ ] Test 4: Todas las referencias son clickeables

---

## üéØ Resultado Esperado

### Antes (Actual - INCORRECTO):
```
Respuesta del AI:
"La Ley N¬∞19.537 derog√≥ la Ley N¬∞6.071. Esta ley se aplica a comunidades..."

Referencias debajo:
[1] Cir32.pdf - 100.0% similar - Chunk #0 - 2,023 tokens
    Full-Text (Completo)
```

### Despu√©s (Esperado - CORRECTO):
```
Respuesta del AI:
"La Ley N¬∞19.537 derog√≥ expresamente la Ley N¬∞6.071[1]. Esta ley se aplica a las 
comunidades de copropietarios que estaban acogidas a la ley anterior[2]. Las construcciones 
en subterr√°neo deben cumplir con distanciamientos[3]."

Referencias debajo (todas clickeables):
[1] Cir32.pdf - 89.2% similar - Fragmento 3 - 512 tokens
    üîç RAG Chunk
    
[2] Cir32.pdf - 76.5% similar - Fragmento 1 - 487 tokens
    üîç RAG Chunk
    
[3] Cir32.pdf - 68.3% similar - Fragmento 4 - 523 tokens
    üîç RAG Chunk
```

**Context Log:**
```
Modo: üîç RAG
      3 chunks
```

---

## üîë Key Insights

### Insight 1: El AI Necesita Saber Qu√© Fragmentos Recibi√≥
Sin esta informaci√≥n, el AI no puede citar correctamente.

**Soluci√≥n:** System prompt expl√≠cito que lista los n√∫meros de fragmento disponibles.

### Insight 2: Referencias Deben Crearse del RAG Output Real
No podemos crear referencias gen√©ricas despu√©s. Deben reflejar el RAG search actual.

**Soluci√≥n:** Usar ragResults directamente, con chunkIndex y similarity reales.

### Insight 3: Frontend Necesita Validar Citas
Para debugging y QA, debemos verificar que el AI sigui√≥ las instrucciones.

**Soluci√≥n:** Fragment mapping permite comparar lo enviado vs lo citado.

---

## üìö Referencias

- `RAG_FLUJO_COMPLETO_2025-10-20.md` - Flujo general de RAG
- `SOLUCION_COMPLETA_REFERENCIAS_2025-10-20.md` - Referencias clickeables
- `src/lib/rag-search.ts` - Vector search implementation
- `src/lib/embeddings.ts` - Embedding generation

---

**Status:** üìù Documentado - Listo para implementar
**Next Steps:** Implementar cambios 1-6 y ejecutar tests 1-4

