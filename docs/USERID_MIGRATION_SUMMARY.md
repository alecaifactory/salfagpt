# User ID Migration - Current State Summary

**Date:** 2025-11-15  
**Generated By:** Automated verification scripts  
**Status:** üîç Analysis Complete - Ready for Migration

---

## üìä Current State

### Collections Requiring Migration

| Collection | Documents | Numeric IDs | Hash IDs | Priority | Estimated Time |
|------------|-----------|-------------|----------|----------|----------------|
| **context_sources** | 885 | 885 | 0 | ‚ùå P0 CRITICAL | 5-10 min |
| **message_feedback** | 42 | 37 | 5 | ‚ö†Ô∏è P1 HIGH | 1 min |
| **feedback_tickets** | 69 | 62 | 7 | ‚ö†Ô∏è P1 HIGH | 1 min |
| **agent_prompt_versions** | 27 | 27 | 0 | ‚ö†Ô∏è P1 HIGH | 1 min |
| **TOTAL** | **1,023** | **1,011** | **12** | | **~15-20 min** |

### Collections Already Clean

| Collection | Documents | Status |
|------------|-----------|--------|
| **document_chunks** | 1,000+ | ‚úÖ All hash format |
| **conversations** | 160+ | ‚úÖ All hash format |
| **users** | 50+ | ‚úÖ All hash format |
| **messages** | 1,000+ | ‚úÖ All hash format |

---

## üéØ Migration Impact

### Critical Features Fixed (P0)
**Agent Context Loading:**
- **Before:** Shows "0 documentos" even when 885 documents exist
- **After:** Shows correct count, loads all assigned documents
- **Affected Users:** All users (37 mapped users)
- **Affected Agents:** All 160 agents

**RAG Search:**
- **Before:** Uses googleUserId workaround
- **After:** Clean queries with hash userId
- **Performance:** No change (already working with workaround)

---

### High Priority Features (P1)
**User Feedback System:**
- **Documents:** 37 feedback items, 62 tickets
- **Impact:** Users can view all their feedback/tickets correctly
- **Test:** View "Mi Feedback" page after migration

**Agent Prompt Versioning:**
- **Documents:** 27 prompt versions
- **Impact:** Prompt history loads correctly for all agents
- **Test:** Open agent prompt editor, view history

---

## üó∫Ô∏è User ID Mapping Table

### Primary User (Main Account - 885 documents)
| Google OAuth ID | Hash ID | Email | Documents |
|-----------------|---------|-------|-----------|
| `114671162830729001607` | `usr_uhwqffaqag1wrryd82tw` | alec@getaifactory.com | 885 |

### Other Users (0 documents currently)
37 additional users mapped, no documents uploaded yet.

**Note:** All 885 context_sources belong to the primary user (alec@getaifactory.com).

---

## üöÄ Recommended Execution Order

### Step 1: Immediate Fix (Today)
```bash
# 1. Verify current state
npm run verify:userid-formats

# 2. Backup (CRITICAL)
./scripts/create-complete-backup.sh --project=salfagpt

# 3. Migrate context_sources (P0 - Fixes agent context)
npm run migrate:userid -- --collection=context_sources --dry-run
npm run migrate:userid -- --collection=context_sources --execute

# 4. Test
# Open agent context modal - should show documents now

# 5. Migrate agent_prompt_versions (P1 - Related to agents)
npm run migrate:userid -- --collection=agent_prompt_versions --dry-run
npm run migrate:userid -- --collection=agent_prompt_versions --execute
```

**Duration:** 15-20 minutes  
**Downtime:** Zero (additive migration)  
**Risk:** Low (backup exists, additive changes)

---

### Step 2: User Feedback (This Week)
```bash
# Migrate feedback collections
npm run migrate:userid -- --collection=message_feedback --execute
npm run migrate:userid -- --collection=feedback_tickets --execute

# Test feedback page
```

**Duration:** 5 minutes  
**Risk:** Low (small collections)

---

### Step 3: Code Cleanup (Next Week)
After all collections migrated and tested:

1. Remove googleUserId workarounds from code
2. Add validation to prevent numeric userId writes
3. Update documentation
4. Deploy to production

---

## üìã Quick Commands Reference

### Discovery
```bash
npm run discover:userid-mappings  # Generate mapping file
npm run verify:userid-formats      # Audit all collections
```

### Migration
```bash
# Always dry-run first
npm run migrate:userid -- --collection=<name> --dry-run

# Execute when ready
npm run migrate:userid -- --collection=<name> --execute
```

### Verification
```bash
# After each migration
npm run verify:userid-formats

# Test specific features
# - Open agent context modal
# - Send RAG search query
# - View feedback page
```

---

## ‚ö†Ô∏è Important Notes

### Why This Happened
- User accounts migrated to hash format in October 2025
- Context sources remained with numeric Google OAuth ID
- Migration was incomplete, causing queries to fail

### Prevention for Future
- **Add validation:** Prevent numeric userId writes
- **Pre-commit hook:** Detect userId format issues
- **Documentation:** Update all rules with hash-only standard
- **Testing:** Include userId format in test suite

---

## üéâ Success Criteria

Migration is successful when:
- [ ] All 885 context_sources have hash userId
- [ ] All 27 agent_prompt_versions have hash userId
- [ ] All 37 message_feedback have hash userId
- [ ] All 62 feedback_tickets have hash userId
- [ ] Verification script shows 100% hash format
- [ ] Agent context modal loads documents correctly
- [ ] RAG search works without googleUserId workaround
- [ ] User feedback page shows all items
- [ ] No user complaints
- [ ] Production deployed successfully

---

**Ready to execute when you approve! ‚úÖ**

**Estimated total time:** 20-30 minutes  
**Estimated risk:** LOW (with backup)  
**Estimated impact:** HIGH (fixes major bug)

