# Sistema de Feedback - Flow Platform

**Created:** 2025-10-29  
**Status:** ‚úÖ Implemented  
**Version:** 1.0.0

---

## üéØ Objetivo

Implementar un sistema completo de feedback que permite a usuarios y expertos calificar respuestas del agente, crear tickets autom√°ticamente para el backlog, y gestionar mejoras priorizadas del sistema.

---

## üë• Tipos de Usuario

### 1. **Usuarios Expertos** (Admin, Expert, SuperAdmin)

**Interfaz:** Notas color violeta (estilo Stella)

**Capacidades:**
- ‚úÖ Calificaci√≥n detallada: Inaceptable / Aceptable / Sobresaliente
- ‚úÖ NPS Score (0-10)
- ‚úÖ CSAT Score (1-5)
- ‚úÖ Notas de evaluaci√≥n detalladas
- ‚úÖ Capturas de pantalla con anotaciones
- ‚úÖ An√°lisis AI de capturas (Gemini 2.5 Flash)
- ‚úÖ Generaci√≥n autom√°tica de tickets

**Ponderaci√≥n:** 70% en c√°lculo de calidad global

### 2. **Usuarios Est√°ndar** (User)

**Interfaz:** Notas color violeta-amarillo (gradiente)

**Capacidades:**
- ‚úÖ Calificaci√≥n r√°pida: 0-5 estrellas (CSAT)
- ‚úÖ Comentario opcional
- ‚úÖ Capturas de pantalla con anotaciones
- ‚úÖ An√°lisis AI de capturas
- ‚úÖ Generaci√≥n autom√°tica de tickets

**Ponderaci√≥n:** 30% en c√°lculo de calidad global

---

## üé® UI Components

### Feedback Buttons (En cada mensaje del agente)

**Ubicaci√≥n:** Debajo de cada mensaje asistente, despu√©s del contenido

```tsx
{/* Feedback Buttons - Only for non-streaming assistant messages */}
<div className="mt-3 pt-3 border-t border-slate-100">
  <span>¬øTe fue √∫til esta respuesta?</span>
  
  {/* Expert Button (purple) - Only for admin/expert/superadmin */}
  {['admin', 'expert', 'superadmin'].includes(userRole) && (
    <button className="bg-purple-100 text-purple-700">
      <Award /> Experto
    </button>
  )}
  
  {/* User Button (violet-yellow gradient) - For all users */}
  <button className="bg-gradient-to-r from-violet-100 to-yellow-100">
    <Star /> Calificar
  </button>
</div>
```

### Expert Feedback Panel

**Componente:** `ExpertFeedbackPanel.tsx`

**Elementos:**
1. **Header:** Gradiente purple, icono Award
2. **Calificaci√≥n General:** 3 opciones (Inaceptable/Aceptable/Sobresaliente)
3. **NPS Score:** 0-10 scale
4. **CSAT Score:** 1-5 scale
5. **Notas de Evaluaci√≥n:** Textarea para an√°lisis detallado
6. **Capturas:** Bot√≥n "Capturar Pantalla" con anotaciones
7. **Footer:** Botones Cancelar/Enviar Feedback

**Colores:**
- Inaceptable: Rojo (red-500)
- Aceptable: Amarillo (yellow-500)
- Sobresaliente: Morado (purple-500)

### User Feedback Panel

**Componente:** `UserFeedbackPanel.tsx`

**Elementos:**
1. **Header:** Gradiente violet-yellow
2. **Star Rating:** 0-5 estrellas interactivas
3. **Comentario:** Textarea opcional
4. **Capturas:** Bot√≥n "Capturar" con anotaciones
5. **Footer:** Botones Cancelar/Enviar

**Colores:**
- 0-2 estrellas: Rojo (red-500)
- 3 estrellas: Amarillo (yellow-500)
- 4-5 estrellas: Violeta (violet-500)

### Screenshot Annotator

**Componente:** `ScreenshotAnnotator.tsx`

**Herramientas:**
1. **C√≠rculo:** Click y arrastra para dibujar
2. **Rect√°ngulo:** Click y arrastra
3. **Flecha:** Inicio ‚Üí Fin
4. **Texto:** Click para posicionar, input para escribir

**Colores disponibles:**
- Purple (#9333ea) - Default
- Yellow (#eab308)
- Red (#ef4444)
- Blue (#3b82f6)
- Green (#10b981)

**Acciones:**
- Deshacer √∫ltima anotaci√≥n
- Limpiar todo
- Confirmar captura

---

## üóÑÔ∏è Data Schema

### Collection: `message_feedback`

```typescript
interface MessageFeedback {
  id: string;
  messageId: string;
  conversationId: string;
  userId: string;
  userEmail: string;
  userRole: string;
  
  feedbackType: 'expert' | 'user';
  
  // Expert feedback
  expertRating?: 'inaceptable' | 'aceptable' | 'sobresaliente';
  expertNotes?: string;
  npsScore?: number; // 0-10
  csatScore?: number; // 1-5
  
  // User feedback
  userStars?: 0 | 1 | 2 | 3 | 4 | 5;
  userComment?: string;
  
  // Screenshots
  screenshots?: AnnotatedScreenshot[];
  screenshotAnalysis?: string; // AI analysis
  
  timestamp: Date;
  source: 'localhost' | 'production';
  
  // Ticket generation
  ticketId?: string;
  ticketCreatedAt?: Date;
}
```

**Indexes Required:**
```
- userId ASC, timestamp DESC
- messageId ASC
- conversationId ASC, timestamp DESC
- feedbackType ASC, timestamp DESC
```

### Collection: `feedback_tickets`

```typescript
interface FeedbackTicket {
  id: string;
  feedbackId: string;
  messageId: string;
  conversationId: string;
  
  // Ticket info
  title: string; // AI-generated
  description: string; // AI-generated
  category: TicketCategory;
  priority: TicketPriority;
  status: TicketStatus;
  
  // Assignment
  assignedTo?: string;
  assignedAt?: Date;
  
  // Reporter
  reportedBy: string;
  reportedByEmail: string;
  reportedByRole: string;
  
  // Original feedback
  originalFeedback: {
    type: 'expert' | 'user';
    rating: ExpertRating | UserRating;
    comment?: string;
    screenshots?: AnnotatedScreenshot[];
    screenshotAnalysis?: string;
  };
  
  // AI analysis
  aiAnalysis?: {
    summary: string;
    suggestedCategory: TicketCategory;
    suggestedPriority: TicketPriority;
    actionableItems: string[];
    technicalDetails?: string;
    affectedComponents?: string[];
  };
  
  // Metrics
  userImpact: 'low' | 'medium' | 'high' | 'critical';
  estimatedEffort: 'xs' | 's' | 'm' | 'l' | 'xl';
  
  // Timestamps
  createdAt: Date;
  updatedAt: Date;
  resolvedAt?: Date;
  source: 'localhost' | 'production';
  
  // Roadmap
  sprintAssigned?: string;
  roadmapQuarter?: string;
  releaseVersion?: string;
}
```

**Indexes Required:**
```
- status ASC, priority ASC, createdAt DESC
- reportedBy ASC, createdAt DESC
- priority ASC, createdAt DESC
- category ASC, createdAt DESC
```

---

## üì° API Endpoints

### POST /api/feedback/submit

**Purpose:** Submit feedback (Expert or User)

**Request:**
```json
{
  "messageId": "msg-123",
  "conversationId": "conv-456",
  "userId": "user-789",
  "userEmail": "user@example.com",
  "userRole": "expert",
  "feedbackType": "expert",
  "expertRating": "sobresaliente",
  "expertNotes": "Excelente respuesta...",
  "npsScore": 9,
  "csatScore": 5,
  "screenshots": [...]
}
```

**Response:**
```json
{
  "success": true,
  "feedbackId": "feedback-abc",
  "ticketId": "ticket-xyz",
  "message": "Feedback recibido exitosamente"
}
```

**Auth:** Required  
**Ownership:** Verified (session.id === userId)

### GET /api/feedback/tickets

**Purpose:** List all feedback tickets (Admin/Expert only)

**Query Params:**
- `userId` (required)
- `status` (optional): Filter by status
- `priority` (optional): Filter by priority
- `category` (optional): Filter by category

**Response:**
```json
{
  "tickets": [
    {
      "id": "ticket-123",
      "title": "Mejorar respuesta en consultas t√©cnicas",
      "priority": "high",
      "status": "new",
      ...
    }
  ]
}
```

**Auth:** Admin/Expert only

### PUT /api/feedback/tickets/[id]

**Purpose:** Update ticket (status, priority, assignment)

**Request:**
```json
{
  "status": "in-progress",
  "priority": "critical",
  "assignedTo": "dev-user-id",
  "sprintAssigned": "Sprint 42",
  "roadmapQuarter": "Q1 2025"
}
```

**Auth:** Admin/Expert only

### DELETE /api/feedback/tickets/[id]

**Purpose:** Delete ticket

**Auth:** Admin only

---

## ü§ñ AI Integration (Gemini 2.5 Flash)

### Screenshot Analysis

**Function:** `analyzeScreenshotWithGemini()`

**Input:**
- Array of `AnnotatedScreenshot`
- Feedback type (expert/user)
- Rating received

**Output:**
```
An√°lisis estructurado identificando:
1. Problemas se√±alados
2. Patrones comunes
3. √Åreas de interfaz mencionadas
4. Gravedad del problema
5. Contexto t√©cnico
```

**Model:** `gemini-2.5-flash`  
**Temperature:** 0.3 (structured analysis)  
**Max Tokens:** 1000

### Ticket Generation

**Function:** `createTicketFromFeedback()`

**Input:**
- Feedback ID
- Feedback data (rating, notes, screenshots, analysis)

**Output (AI-generated):**
- Title (conciso, accionable)
- Description (detallada)
- Category (bug, feature-request, etc.)
- Priority (critical, high, medium, low)
- User Impact (critical, high, medium, low)
- Estimated Effort (xs, s, m, l, xl)
- Actionable Items (3-5 acciones)
- Affected Components (m√≥dulos)

**Model:** `gemini-2.5-flash`  
**Temperature:** 0.2 (muy estructurado)  
**Max Tokens:** 1500

**Prompt Template:**
```
Analiza este feedback de usuario y genera un ticket estructurado.

Tipo: {feedbackType}
Calificaci√≥n: {rating}
Notas: {notes}
An√°lisis de capturas: {screenshotAnalysis}

Genera JSON con: title, description, category, priority, 
userImpact, estimatedEffort, actionableItems, affectedComponents
```

---

## üé® Design System

### Color Themes

**Expert Feedback (Purple):**
```css
Primary: purple-600 (#9333ea)
Background: purple-50
Border: purple-200
Hover: purple-700
```

**User Feedback (Violet-Yellow Gradient):**
```css
Primary: gradient from violet-600 to yellow-600
Background: gradient from violet-50 to yellow-50
Border: violet-200
Text: gradient from violet-700 to yellow-700
```

**Ratings:**
```css
Inaceptable/1-2 stars: red-500
Aceptable/3 stars: yellow-500
Sobresaliente/4-5 stars: purple-500/violet-500
```

### Typography

**Expert Panel:**
- Title: text-xl font-bold text-purple-900
- Labels: text-sm font-semibold text-purple-900
- Helper text: text-xs font-normal text-purple-600

**User Panel:**
- Title: text-xl font-bold gradient
- Labels: text-sm font-semibold gradient
- Helper text: text-xs text-violet-600

---

## üìä Metrics & Analytics

### Per-Agent Quality Score

```typescript
function calculateWeightedQuality(
  expertRatings: { inaceptable, aceptable, sobresaliente },
  userStarsAverage: number,
  expertWeight: 0.7, // 70% experts
  userWeight: 0.3    // 30% users
): number {
  // Expert score: 0-100 scale
  expertScore = (
    inaceptable * 0 + 
    aceptable * 50 + 
    sobresaliente * 100
  ) / total;
  
  // User score: 0-100 scale
  userScore = (userStarsAverage / 5) * 100;
  
  // Weighted average
  return expertScore * 0.7 + userScore * 0.3;
}
```

### Ticket Categories

```typescript
type TicketCategory = 
  | 'bug'                // üêõ Errores
  | 'feature-request'    // ‚ú® Nuevas features
  | 'ui-improvement'     // üé® Mejoras UI
  | 'performance'        // ‚ö° Optimizaci√≥n
  | 'security'           // üîí Seguridad
  | 'content-quality'    // üìù Calidad contenido
  | 'agent-behavior'     // ü§ñ Comportamiento agente
  | 'context-accuracy'   // üéØ Precisi√≥n contexto
  | 'other';             // üìå Otros
```

### Ticket Priorities

```typescript
type TicketPriority = 
  | 'critical' // P0: Blocker, fix inmediato
  | 'high'     // P1: Importante, siguiente sprint
  | 'medium'   // P2: Deber√≠a arreglarse, 2-3 sprints
  | 'low';     // P3: Nice to have, backlog
```

### Ticket Statuses

```typescript
type TicketStatus =
  | 'new'          // üÜï Reci√©n creado
  | 'triaged'      // üëÅÔ∏è Revisado por equipo
  | 'prioritized'  // üìä Agregado a roadmap
  | 'in-progress'  // üî® En desarrollo
  | 'in-review'    // üëÄ Code review
  | 'testing'      // üß™ QA testing
  | 'done'         // ‚úÖ Shipped
  | 'wont-fix'     // üö´ No se har√°
  | 'duplicate';   // üìã Duplicado
```

---

## üîÑ User Flow

### Expert Feedback Flow

```
1. Usuario experto ve respuesta del agente
   ‚Üì
2. Click en bot√≥n "Experto" (purple)
   ‚Üì
3. Modal se abre con opciones:
   - Seleccionar: Inaceptable/Aceptable/Sobresaliente
   - NPS: 0-10
   - CSAT: 1-5
   - Notas detalladas
   - [Opcional] Capturar pantalla
   ‚Üì
4. [Si captura] Screenshot Annotator abre
   - Dibuja c√≠rculos, rect√°ngulos, flechas
   - A√±ade texto explicativo
   - Confirma captura
   ‚Üì
5. Click "Enviar Feedback"
   ‚Üì
6. Backend procesa:
   - Guarda feedback en Firestore
   - Analiza capturas con Gemini 2.5 Flash
   - Genera ticket con AI
   - Asigna prioridad autom√°tica
   ‚Üì
7. Success: "Feedback enviado. Ticket creado: ticket-xyz"
   ‚Üì
8. Ticket aparece en Backlog de SuperAdmin
```

### User Feedback Flow

```
1. Usuario est√°ndar ve respuesta del agente
   ‚Üì
2. Click en bot√≥n "Calificar" (violet-yellow)
   ‚Üì
3. Modal se abre con:
   - Estrellas 0-5 (hover preview)
   - Comentario opcional
   - [Opcional] Capturar pantalla
   ‚Üì
4. [Si captura] Screenshot Annotator
   ‚Üì
5. Click "Enviar"
   ‚Üì
6. Backend procesa (igual que expert)
   ‚Üì
7. Success: Ticket creado
```

---

## üéØ Screenshot Annotation System

### Supported Shapes

**Circle:**
```typescript
{
  type: 'circle',
  x: number,      // Center X
  y: number,      // Center Y
  radius: number, // Radius in pixels
  color: string   // Hex color
}
```

**Rectangle:**
```typescript
{
  type: 'rectangle',
  x: number,      // Top-left X
  y: number,      // Top-left Y
  width: number,  // Width
  height: number, // Height
  color: string
}
```

**Arrow:**
```typescript
{
  type: 'arrow',
  x: number,      // Start X
  y: number,      // Start Y
  endX: number,   // End X
  endY: number,   // End Y
  color: string
}
```

**Text:**
```typescript
{
  type: 'text',
  x: number,      // Position X
  y: number,      // Position Y
  text: string,   // Text content
  color: string
}
```

### Canvas Implementation

**Technology:** HTML5 Canvas API

**Features:**
- Real-time drawing preview
- Multi-color support
- Undo last annotation
- Clear all annotations
- Export as PNG with annotations

**Drawing Process:**
1. User selects tool
2. User selects color
3. `mousedown` ‚Üí Start drawing
4. `mousemove` ‚Üí Update preview
5. `mouseup` ‚Üí Save annotation
6. Redraw canvas with all annotations

---

## üöÄ Backlog Management (SuperAdmin)

### Feedback Backlog Dashboard

**Componente:** `FeedbackBacklogDashboard.tsx`

**Access:** User menu ‚Üí "Backlog de Feedback" (SuperAdmin only)

**Features:**

#### Stats Cards
- Total tickets
- Nuevos (blue)
- En progreso (yellow)
- Completados (green)
- Cr√≠ticos (red)

#### Filters
- **Search:** Text search in titles
- **Status:** All, New, Triaged, In Progress, etc.
- **Priority:** All, P0, P1, P2, P3
- **Category:** All, Bug, Feature, UI, etc.

#### Sorting
- By Priority (default)
- By Date
- By Impact

#### Ticket Cards
**Collapsed View:**
- Title
- Status badge
- Priority badge
- Category badge
- Feedback type badge
- Impact/Effort indicators
- Date & Reporter

**Expanded View:**
- Full description
- Original feedback (rating, comment)
- AI analysis (summary, actionable items)
- Screenshots (if any)
- Actions: Update status, Update priority

### Ticket Management Actions

**Update Status:**
- Dropdown in expanded card
- Auto-updates `updatedAt`
- If set to "done", sets `resolvedAt`

**Update Priority:**
- Dropdown in expanded card
- Immediate update to Firestore

**Assign to Sprint/Roadmap:**
- Input fields for:
  - `sprintAssigned`
  - `roadmapQuarter`
  - `releaseVersion`

---

## üîê Permissions

### Expert Feedback
**Roles:** `admin`, `expert`, `superadmin`  
**Button Visible:** Yes  
**Can Submit:** Yes  
**Weight in Quality:** 70%

### User Feedback
**Roles:** All users  
**Button Visible:** Yes  
**Can Submit:** Yes  
**Weight in Quality:** 30%

### Backlog Access
**Roles:** `admin`, `expert`, `superadmin`  
**Menu Visible:** Yes (in user menu)  
**Can View Tickets:** Yes  
**Can Update Tickets:** Yes  
**Can Delete Tickets:** Admin only

---

## üß™ Testing Checklist

### Manual Testing

**As Expert:**
- [ ] Send message to agent
- [ ] See "Experto" button (purple)
- [ ] Click button, modal opens
- [ ] Select rating (Inaceptable/Aceptable/Sobresaliente)
- [ ] Enter NPS (0-10)
- [ ] Enter CSAT (1-5)
- [ ] Write notes
- [ ] Capture screenshot
- [ ] Draw circle, rectangle, arrow
- [ ] Add text annotation
- [ ] Submit feedback
- [ ] Verify success message
- [ ] Check Firestore: `message_feedback` collection
- [ ] Check Firestore: `feedback_tickets` collection
- [ ] Open Backlog, see new ticket

**As User:**
- [ ] Send message to agent
- [ ] See "Calificar" button (violet-yellow)
- [ ] Click button, modal opens
- [ ] Select stars (0-5)
- [ ] Hover shows labels
- [ ] Write comment
- [ ] Capture screenshot
- [ ] Submit feedback
- [ ] Verify success
- [ ] Check Firestore collections

**As SuperAdmin:**
- [ ] Open user menu
- [ ] See "Backlog de Feedback"
- [ ] Click, dashboard opens
- [ ] See stats cards
- [ ] Use filters (status, priority, category)
- [ ] Search tickets
- [ ] Sort by priority/date/impact
- [ ] Expand ticket
- [ ] See full details
- [ ] View screenshots
- [ ] Update status
- [ ] Update priority
- [ ] Close dashboard

---

## üé® Visual Examples

### Expert Feedback Panel
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üëë Feedback Experto              [X] ‚îÇ
‚îÇ Evaluaci√≥n de calidad profesional      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                        ‚îÇ
‚îÇ Calificaci√≥n General *                 ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îÇ
‚îÇ ‚îÇ   ‚ùå   ‚îÇ ‚îÇ   ‚úîÔ∏è   ‚îÇ ‚îÇ   ‚≠ê   ‚îÇ      ‚îÇ
‚îÇ ‚îÇInacep. ‚îÇ ‚îÇAceptab.‚îÇ ‚îÇSobres. ‚îÇ      ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îÇ
‚îÇ                                        ‚îÇ
‚îÇ NPS Score (0-10)                       ‚îÇ
‚îÇ [0][1][2][3][4][5][6][7][8][9][10]    ‚îÇ
‚îÇ                                        ‚îÇ
‚îÇ CSAT Score (1-5)                       ‚îÇ
‚îÇ [ 1 ][ 2 ][ 3 ][ 4 ][ 5 ]             ‚îÇ
‚îÇ                                        ‚îÇ
‚îÇ Notas de Evaluaci√≥n                    ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ An√°lisis detallado...              ‚îÇ ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                        ‚îÇ
‚îÇ üì∑ Capturas (Opcional)                ‚îÇ
‚îÇ [Capturar Pantalla]                    ‚îÇ
‚îÇ                                        ‚îÇ
‚îÇ           [Cancelar] [Enviar Feedback] ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### User Feedback Panel
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ‚≠ê Tu Opini√≥n Importa            [X] ‚îÇ
‚îÇ Ay√∫danos a mejorar                     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                        ‚îÇ
‚îÇ ¬øQu√© te pareci√≥ esta respuesta? *      ‚îÇ
‚îÇ                                        ‚îÇ
‚îÇ    ‚òÖ  ‚òÖ  ‚òÖ  ‚òÖ  ‚òÖ                       ‚îÇ
‚îÇ  (Hover para labels)                   ‚îÇ
‚îÇ                                        ‚îÇ
‚îÇ Comentario (Opcional)                  ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ Cu√©ntanos m√°s...                   ‚îÇ ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                        ‚îÇ
‚îÇ üì∑ Capturas (Opcional)                ‚îÇ
‚îÇ [Capturar]                             ‚îÇ
‚îÇ                                        ‚îÇ
‚îÇ    Gracias por ayudarnos a mejorar     ‚îÇ
‚îÇ           [Cancelar] [Enviar]          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Screenshot Annotator
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Anotar Captura        [Tools] [Colors] [‚úì][X]‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                ‚îÇ
‚îÇ              [Canvas con screenshot]           ‚îÇ
‚îÇ     (Anotaciones dibujadas en tiempo real)     ‚îÇ
‚îÇ                                                ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ ‚óã C√≠rculo  ‚ñ° Rect√°ngulo  ‚Üí Flecha  T Texto   ‚îÇ
‚îÇ           Click y arrastra / Click para texto  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üöÄ Deployment Checklist

### Firestore Indexes

**Deploy these indexes:**
```bash
# message_feedback
gcloud firestore indexes composite create \
  --collection-group=message_feedback \
  --field-config field-path=userId,order=ascending \
  --field-config field-path=timestamp,order=descending

# feedback_tickets  
gcloud firestore indexes composite create \
  --collection-group=feedback_tickets \
  --field-config field-path=status,order=ascending \
  --field-config field-path=priority,order=ascending \
  --field-config field-path=createdAt,order=descending
```

### Environment Variables

**Required:**
- `GOOGLE_AI_API_KEY` - For Gemini screenshot analysis
- `GOOGLE_CLOUD_PROJECT` - For Firestore

### Testing

- [ ] Type check: `npm run type-check`
- [ ] Build: `npm run build`
- [ ] Test Expert feedback flow
- [ ] Test User feedback flow
- [ ] Test Screenshot annotator
- [ ] Test Backlog dashboard
- [ ] Verify Firestore collections created
- [ ] Verify tickets generated correctly

---

## üìö Files Created

### Types
- ‚úÖ `src/types/feedback.ts` - Complete type definitions

### Components
- ‚úÖ `src/components/ExpertFeedbackPanel.tsx` - Expert feedback UI
- ‚úÖ `src/components/UserFeedbackPanel.tsx` - User feedback UI
- ‚úÖ `src/components/ScreenshotAnnotator.tsx` - Screenshot tool
- ‚úÖ `src/components/FeedbackBacklogDashboard.tsx` - Backlog management

### Services
- ‚úÖ `src/lib/feedback-service.ts` - AI analysis & ticket generation

### API Routes
- ‚úÖ `src/pages/api/feedback/submit.ts` - Submit feedback
- ‚úÖ `src/pages/api/feedback/tickets.ts` - List tickets
- ‚úÖ `src/pages/api/feedback/tickets/[id].ts` - Update/Delete tickets

### Integration
- ‚úÖ `src/components/ChatInterfaceWorking.tsx` - Integrated feedback buttons

### Documentation
- ‚úÖ `.cursor/rules/data.mdc` - Updated with new collections
- ‚úÖ `docs/features/FEEDBACK_SYSTEM_2025-10-29.md` - This file

---

## üéì Key Decisions

### 1. Two Feedback Types with Different Weights

**Why:** Expert feedback carries more weight due to domain expertise, but user feedback is still valuable for UX improvements.

**Implementation:** Weighted quality calculation (70% expert, 30% user)

### 2. Automatic Ticket Generation

**Why:** Every feedback creates actionable work item, ensuring nothing is lost.

**Implementation:** AI analyzes feedback and creates structured ticket with category, priority, effort estimate.

### 3. Screenshot Annotations

**Why:** Visual feedback is often clearer than text descriptions.

**Implementation:** HTML5 Canvas with drawing tools, analyzed by Gemini for context.

### 4. Gemini 2.5 Flash for Analysis

**Why:** Fast, cost-effective, sufficient for structured analysis.

**Model:** `gemini-2.5-flash`  
**Use Cases:** Screenshot analysis, Ticket generation

### 5. Separate Feedback & Ticket Collections

**Why:** Feedback is raw user input, Tickets are processed work items.

**Benefit:** Can have multiple feedbacks per ticket, or ticket from multiple sources.

---

## üîÆ Future Enhancements

### Short-term
- [ ] Notification badge on menu item (new tickets count)
- [ ] Email notifications for critical feedback
- [ ] Bulk ticket actions (assign multiple, update status)
- [ ] Feedback trends chart per agent

### Medium-term
- [ ] Roadmap integration (drag tickets to quarters)
- [ ] Sprint planning view
- [ ] Ticket comments/discussion
- [ ] Feedback analytics dashboard

### Long-term
- [ ] A/B testing based on feedback
- [ ] ML model to predict priority
- [ ] Automatic categorization improvement
- [ ] Integration with external tools (Jira, Linear)

---

## ‚úÖ Success Criteria

A properly implemented feedback system should achieve:

### Functionality
- ‚úÖ Both expert and user can submit feedback
- ‚úÖ Feedback persists to Firestore
- ‚úÖ Screenshots captured with annotations
- ‚úÖ AI analyzes screenshots and generates tickets
- ‚úÖ Tickets appear in backlog
- ‚úÖ SuperAdmin can manage tickets

### UX
- ‚úÖ Buttons visible only for assistant messages
- ‚úÖ Different visual themes for expert/user
- ‚úÖ Smooth modal interactions
- ‚úÖ Intuitive screenshot annotation
- ‚úÖ Clear success/error feedback

### Data Quality
- ‚úÖ All feedback has required fields
- ‚úÖ AI-generated tickets are actionable
- ‚úÖ Priority reflects feedback severity
- ‚úÖ Categories are accurate

### Performance
- ‚úÖ Feedback submission < 2s
- ‚úÖ Screenshot analysis < 5s
- ‚úÖ Ticket generation < 3s
- ‚úÖ Backlog loads < 1s (100 tickets)

---

**Status:** ‚úÖ Implemented  
**Tested:** Pending manual testing  
**Backward Compatible:** Yes  
**Breaking Changes:** None  

---

**Next Steps:**
1. Deploy Firestore indexes
2. Manual testing with both user types
3. Verify AI analysis quality
4. Monitor ticket generation accuracy
5. Gather feedback on feedback system (meta!)

