# üèóÔ∏è Modelo de Compartici√≥n por Dominio - Arquitectura Definitiva

**Fecha:** 2025-10-21  
**Estado:** üìã DISE√ëO APROBADO  
**Pr√≥ximo:** Implementaci√≥n

---

## üéØ Modelo de Compartici√≥n Definido

### Regla de Oro
> **"Agentes son privados por usuario. Todo lo dem√°s es compartido por dominio."**

---

## üì¶ Recursos por Tipo

### 1. AGENTES (Privados por Usuario)

**Modelo:**
```typescript
Agent/Conversation {
  id: string;
  userId: string;        // Due√±o/creador
  domain: string;        // Dominio del creador
  isAgent: true;
  visibility: 'private'; // Por defecto
  
  // Compartici√≥n opcional
  sharedWith: ShareTarget[];
}

ShareTarget {
  type: 'user' | 'group';
  id: string;           // userId o groupId
  domain: string;       // MUST match agent.domain
  accessLevel: 'view' | 'edit' | 'admin';
  sharedAt: Date;
  sharedBy: string;     // userId del que comparti√≥
}
```

**Reglas:**
- ‚úÖ Creado por usuario individual
- ‚úÖ Privado por defecto (solo creador lo ve)
- ‚úÖ Puede compartirse con usuarios del MISMO dominio
- ‚úÖ Puede compartirse con grupos del MISMO dominio
- ‚ùå NO puede compartirse con otro dominio
- ‚ùå Admin NO puede forzar compartici√≥n cross-domain

**Flujo de Compartici√≥n:**
```
1. Usuario crea agente ‚Üí private
2. Usuario abre configuraci√≥n de agente
3. Click "Compartir"
4. Modal muestra:
   - Usuarios del mismo dominio
   - Grupos del mismo dominio
5. Usuario selecciona destinatarios
6. Selecciona nivel de acceso (view/edit/admin)
7. Click "Compartir"
   ‚Üí sharedWith actualizado
   ‚Üí Usuarios/grupos reciben acceso
```

---

### 2. CONTEXTOS / FUENTES DE CONTEXTO (Compartidos por Dominio)

**Modelo:**
```typescript
ContextSource {
  id: string;
  userId: string;        // Creador original (para auditor√≠a)
  domain: string;        // Dominio al que pertenece
  visibility: 'domain';  // Visible para todo el dominio
  
  // Compartici√≥n adicional (opcional)
  sharedWith?: ShareTarget[];
  
  // Permisos
  permissions: {
    canView: 'all_domain' | 'specific';    // Por defecto: all_domain
    canEdit: 'creator' | 'group' | 'all_domain';
    canDelete: 'creator' | 'admin';
    canShare: 'creator' | 'admin';
  };
}
```

**Reglas:**
- ‚úÖ Creado por usuario pero pertenece al dominio
- ‚úÖ Visible para TODOS los usuarios del dominio
- ‚úÖ Puede compartirse con usuarios espec√≠ficos (mismo dominio)
- ‚úÖ Puede compartirse con grupos (mismo dominio)
- ‚ùå NO cross-domain sharing
- ‚úÖ Permisos configurables (qui√©n puede editar/eliminar)

**Filtrado:**
```typescript
// Obtener contextos del dominio del usuario
async function getContextSources(userId: string) {
  const user = await getUser(userId);
  const userDomain = getDomainFromEmail(user.email);
  
  // Todos los contextos del dominio
  const snapshot = await firestore
    .collection('context_sources')
    .where('domain', '==', userDomain)
    .orderBy('addedAt', 'desc')
    .get();
  
  return snapshot.docs.map(doc => doc.data());
}
```

---

### 3. CONVERSACIONES (Compartidas por Dominio)

**Modelo:**
```typescript
Conversation {
  id: string;
  userId: string;        // Creador
  domain: string;        // Dominio
  isAgent: false;        // Es conversaci√≥n, no agente
  agentId?: string;      // Agente asociado (si aplica)
  visibility: 'domain';  // Todos en dominio
  
  // Compartici√≥n adicional
  sharedWith?: ShareTarget[];
}
```

**Reglas:**
- ‚úÖ Visible para todos en el dominio
- ‚úÖ Compartici√≥n adicional opcional
- ‚ùå No cross-domain

---

### 4. CONFIGURACIONES (Por Dominio)

**Modelo:**
```typescript
DomainConfiguration {
  id: string;            // domainId
  domain: string;
  
  // Configuraciones globales del dominio
  defaultModel: 'gemini-2.5-flash' | 'gemini-2.5-pro';
  defaultSystemPrompt: string;
  allowedModels: string[];
  
  // Features habilitadas
  features: {
    canCreateAgents: boolean;
    canUploadContext: boolean;
    canShareAgents: boolean;
    maxAgentsPerUser: number;
    maxContextSources: number;
  };
}

UserConfiguration {
  id: string;
  userId: string;
  domain: string;
  
  // Override personal (opcional)
  preferredModel?: string;
  customSystemPrompt?: string;
}
```

**Jerarqu√≠a:**
```
Usuario usa: User Config ‚Üí Domain Config ‚Üí System Default
```

---

## üë• Sistema de Grupos

### Modelo de Grupos

**Colecci√≥n: `groups`**
```typescript
Group {
  id: string;
  name: string;          // ej: "Equipo de Ventas"
  domain: string;        // ej: "getaifactory.com"
  description?: string;
  
  // Miembros
  members: string[];     // userIds del mismo dominio
  
  // Permisos del grupo
  permissions: {
    canCreateAgents: boolean;
    canUploadContext: boolean;
    canValidateContext: boolean;
    // ...m√°s permisos
  };
  
  // Metadata
  createdBy: string;     // Admin que cre√≥ el grupo
  createdAt: Date;
  updatedAt: Date;
}
```

**Reglas de Grupos:**
- ‚úÖ Creados por admin
- ‚úÖ Solo usuarios del MISMO dominio pueden ser miembros
- ‚úÖ Grupos NO pueden tener miembros cross-domain
- ‚úÖ Un usuario puede estar en m√∫ltiples grupos
- ‚úÖ Permisos de grupo se suman a permisos de usuario

---

### Uso de Grupos en Compartici√≥n

**Ejemplo: Compartir Agente con Grupo**
```typescript
// Admin crea grupo
Group {
  id: "grupo-ventas-001",
  name: "Equipo de Ventas",
  domain: "getaifactory.com",
  members: [
    "usuario1@getaifactory.com",
    "usuario2@getaifactory.com",
    "usuario3@getaifactory.com"
  ]
}

// Usuario comparte agente con grupo
Agent {
  id: "agente-001",
  userId: "alec@getaifactory.com",
  domain: "getaifactory.com",
  sharedWith: [
    {
      type: 'group',
      id: 'grupo-ventas-001',
      domain: 'getaifactory.com',
      accessLevel: 'view'
    }
  ]
}

// Resultado:
// - usuario1, usuario2, usuario3 pueden VER el agente
// - Solo pueden ver (no editar)
// - Agente sigue siendo del creador original
```

---

## üîí Validaciones de Seguridad

### Validaci√≥n 1: Compartici√≥n Solo Dentro del Dominio

```typescript
async function shareAgent(
  agentId: string,
  targetUserId: string,
  shareLevel: 'view' | 'edit' | 'admin'
) {
  // 1. Get agent
  const agent = await getAgent(agentId);
  
  // 2. Get target user
  const targetUser = await getUser(targetUserId);
  
  // 3. CRITICAL: Verify same domain
  const targetDomain = getDomainFromEmail(targetUser.email);
  
  if (agent.domain !== targetDomain) {
    throw new Error('Cannot share outside of domain');
  }
  
  // 4. Add to sharedWith
  await updateAgent(agentId, {
    sharedWith: [
      ...agent.sharedWith,
      {
        type: 'user',
        id: targetUserId,
        domain: targetDomain,
        accessLevel: shareLevel,
        sharedAt: new Date(),
        sharedBy: currentUser.id,
      }
    ]
  });
}
```

---

### Validaci√≥n 2: Grupos Solo Dentro del Dominio

```typescript
async function createGroup(
  name: string,
  domain: string,
  memberEmails: string[]
) {
  // Verify all members are from same domain
  for (const email of memberEmails) {
    const memberDomain = getDomainFromEmail(email);
    
    if (memberDomain !== domain) {
      throw new Error(`Cannot add ${email} - different domain (${memberDomain} vs ${domain})`);
    }
  }
  
  // Create group
  const group = await firestore.collection('groups').add({
    name,
    domain,
    members: memberEmails,
    createdAt: new Date(),
  });
  
  return group;
}
```

---

## üìä Matriz de Recursos

| Recurso | Filtrado Por | Compartici√≥n | Cross-Domain |
|---------|--------------|--------------|--------------|
| **Agentes** | userId | Usuario/Grupo en mismo dominio | ‚ùå NO |
| **Contextos** | domain | Usuario/Grupo en mismo dominio | ‚ùå NO |
| **Conversaciones** | domain | Usuario/Grupo en mismo dominio | ‚ùå NO |
| **Configuraciones** | domain | N/A (herencia) | ‚ùå NO |
| **Grupos** | domain | N/A (asignaci√≥n directa) | ‚ùå NO |

---

## üîÑ Flujos de Datos

### Flujo 1: Usuario Crea Agente

```
1. Usuario A (alec@getaifactory.com) crea agente
   ‚Üì
2. Agente creado con:
   - userId: alec@getaifactory.com
   - domain: getaifactory.com
   - visibility: private
   - sharedWith: []
   ‚Üì
3. Solo Usuario A lo ve inicialmente
   ‚Üì
4. Usuario A puede compartir con:
   - Usuario B (hello@getaifactory.com) ‚úÖ mismo dominio
   - Grupo "Ventas" (getaifactory.com) ‚úÖ mismo dominio
   - Usuario C (user@salfacloud.cl) ‚ùå diferente dominio
```

---

### Flujo 2: Usuario Sube Contexto

```
1. Usuario A (alec@getaifactory.com) sube PDF
   ‚Üì
2. Contexto creado con:
   - userId: alec@getaifactory.com (creador)
   - domain: getaifactory.com
   - visibility: domain
   ‚Üì
3. TODOS en getaifactory.com lo ven autom√°ticamente:
   - Usuario A ‚úÖ
   - Usuario B (hello@getaifactory.com) ‚úÖ
   - Usuario C de otro dominio ‚ùå
```

---

### Flujo 3: Admin Crea Grupo

```
1. Admin crea grupo "Equipo Marketing"
   ‚Üì
2. Grupo creado con:
   - name: "Equipo Marketing"
   - domain: getaifactory.com
   - members: [user1@getaifactory.com, user2@getaifactory.com]
   ‚Üì
3. Admin intenta agregar user@salfacloud.cl
   ‚Üì
4. Sistema valida: ‚ùå Dominio diferente
   ‚Üì
5. Error: "Cannot add user from different domain"
```

---

## üóÑÔ∏è Cambios en Schema de Firestore

### Colecciones a Modificar

#### 1. `conversations`
```typescript
// ANTES
{
  userId: string;  // Filtrado actual
}

// DESPU√âS
{
  userId: string;       // Creador (para agentes privados)
  domain: string;       // Dominio del creador
  isAgent: boolean;     // true = privado, false = dominio
  
  // Para agentes
  sharedWith?: ShareTarget[];
}
```

#### 2. `context_sources`
```typescript
// ANTES
{
  userId: string;
}

// DESPU√âS
{
  userId: string;       // Creador original (auditor√≠a)
  domain: string;       // Dominio (filtrado principal)
  visibility: 'domain'; // Todos en dominio lo ven
  
  // Compartici√≥n adicional (opcional)
  sharedWith?: ShareTarget[];
  
  permissions: {
    canView: 'all_domain' | 'specific';
    canEdit: 'creator' | 'admin' | 'group';
    canDelete: 'creator' | 'admin';
  };
}
```

#### 3. `messages`
```typescript
// ANTES
{
  conversationId: string;
  userId: string;
}

// DESPU√âS
{
  conversationId: string;
  userId: string;
  domain: string;  // Heredado de conversaci√≥n
}
```

#### 4. `groups` (NUEVA)
```typescript
Group {
  id: string;
  name: string;
  domain: string;           // üîí CRITICAL: Solo un dominio
  description?: string;
  
  members: string[];        // userIds (MUST be same domain)
  
  permissions: {
    canCreateAgents: boolean;
    canUploadContext: boolean;
    canValidateContext: boolean;
    canShareAgents: boolean;
  };
  
  createdBy: string;
  createdAt: Date;
  updatedAt: Date;
}
```

#### 5. `agent_shares` (NUEVA)
```typescript
AgentShare {
  id: string;
  agentId: string;
  ownerId: string;          // Creador del agente
  ownerDomain: string;      // Dominio del creador
  
  sharedWith: ShareTarget[];
  
  createdAt: Date;
  updatedAt: Date;
  expiresAt?: Date;         // Compartici√≥n temporal
}
```

---

## üîç Queries Modificados

### ANTES (Filtrado por userId)

```typescript
// Conversaciones
.where('userId', '==', userId)

// Contextos
.where('userId', '==', userId)

// Mensajes
.where('conversationId', '==', conversationId)
```

### DESPU√âS (Filtrado por domain para recursos compartidos)

```typescript
// AGENTES (privados) - Filtrado por userId + shared
async function getAgentsForUser(userId: string) {
  const user = await getUser(userId);
  const userDomain = getDomainFromEmail(user.email);
  
  // 1. Agentes propios
  const ownAgents = await firestore
    .collection('conversations')
    .where('userId', '==', userId)
    .where('isAgent', '==', true)
    .get();
  
  // 2. Agentes compartidos con el usuario
  const sharedDirect = await firestore
    .collection('conversations')
    .where('isAgent', '==', true)
    .where('sharedWith', 'array-contains', {
      type: 'user',
      id: userId,
      domain: userDomain
    })
    .get();
  
  // 3. Agentes compartidos con grupos del usuario
  const userGroups = await getUserGroups(userId);
  const sharedViaGroups = []; // Query por cada grupo
  
  // Merge all
  return [...ownAgents.docs, ...sharedDirect.docs, ...sharedViaGroups];
}

// CONTEXTOS (compartidos) - Filtrado por domain
async function getContextSources(userId: string) {
  const user = await getUser(userId);
  const userDomain = getDomainFromEmail(user.email);
  
  // Todos los contextos del dominio
  const snapshot = await firestore
    .collection('context_sources')
    .where('domain', '==', userDomain)
    .orderBy('addedAt', 'desc')
    .get();
  
  return snapshot.docs.map(doc => doc.data());
}

// CONVERSACIONES (compartidas) - Filtrado por domain
async function getConversations(userId: string) {
  const user = await getUser(userId);
  const userDomain = getDomainFromEmail(user.email);
  
  // Todas las conversaciones del dominio (no agentes)
  const snapshot = await firestore
    .collection('conversations')
    .where('domain', '==', userDomain)
    .where('isAgent', '==', false) // Excluir agentes
    .orderBy('lastMessageAt', 'desc')
    .get();
  
  return snapshot.docs.map(doc => doc.data());
}
```

---

## üö® Validaciones de Seguridad

### Validaci√≥n 1: Compartici√≥n Solo Dentro de Dominio

```typescript
function validateShareTarget(
  ownerDomain: string,
  targetEmail: string
): boolean {
  const targetDomain = getDomainFromEmail(targetEmail);
  
  if (ownerDomain !== targetDomain) {
    throw new Error(
      `Cannot share: ${targetEmail} is from ${targetDomain}, ` +
      `but resource is from ${ownerDomain}`
    );
  }
  
  return true;
}
```

---

### Validaci√≥n 2: Grupos Solo del Mismo Dominio

```typescript
function validateGroupMembers(
  groupDomain: string,
  memberEmails: string[]
): boolean {
  for (const email of memberEmails) {
    const memberDomain = getDomainFromEmail(email);
    
    if (memberDomain !== groupDomain) {
      throw new Error(
        `Cannot add ${email}: member domain (${memberDomain}) ` +
        `does not match group domain (${groupDomain})`
      );
    }
  }
  
  return true;
}
```

---

### Validaci√≥n 3: Admin No Puede Forzar Cross-Domain

```typescript
async function shareAgentAsAdmin(
  adminId: string,
  agentId: string,
  targetUserId: string
) {
  // Get admin and agent
  const admin = await getUser(adminId);
  const agent = await getAgent(agentId);
  const targetUser = await getUser(targetUserId);
  
  // Extract domains
  const agentDomain = agent.domain;
  const targetDomain = getDomainFromEmail(targetUser.email);
  
  // üîí CRITICAL: Even admins cannot share cross-domain
  if (agentDomain !== targetDomain) {
    throw new Error(
      'Admin cannot share cross-domain. ' +
      `Agent domain: ${agentDomain}, Target domain: ${targetDomain}`
    );
  }
  
  // Share within domain
  await shareAgent(agentId, targetUserId, 'view');
}
```

---

## üìã Plan de Implementaci√≥n

### Fase 1: Migraci√≥n de Schema (Additive)

**Paso 1:** Agregar campo `domain` a colecciones existentes
```typescript
// Script de migraci√≥n
async function addDomainToExistingDocuments() {
  // Para cada conversaci√≥n
  const conversations = await firestore.collection('conversations').get();
  for (const doc of conversations.docs) {
    const data = doc.data();
    const user = await getUser(data.userId);
    const domain = getDomainFromEmail(user.email);
    
    await doc.ref.update({
      domain,
      isAgent: data.isAgent ?? true, // Default: es agente
    });
  }
  
  // Para cada context_source
  const sources = await firestore.collection('context_sources').get();
  for (const doc of sources.docs) {
    const data = doc.data();
    const user = await getUser(data.userId);
    const domain = getDomainFromEmail(user.email);
    
    await doc.ref.update({
      domain,
      visibility: 'domain',
    });
  }
}
```

---

### Fase 2: Implementar Grupos

**Paso 1:** Crear colecci√≥n `groups`
**Paso 2:** Crear API endpoints de grupos
**Paso 3:** Crear UI de gesti√≥n de grupos (admin)

---

### Fase 3: Implementar Compartici√≥n de Agentes

**Paso 1:** Agregar `sharedWith` a agentes
**Paso 2:** Crear UI de compartici√≥n
**Paso 3:** Modificar queries para incluir agentes compartidos

---

### Fase 4: Modificar Queries de Contextos/Conversaciones

**Paso 1:** Cambiar filtrado de `userId` a `domain`
**Paso 2:** Actualizar UI para mostrar "recursos del dominio"
**Paso 3:** Testing exhaustivo

---

## ‚ö†Ô∏è Consideraciones de Migraci√≥n

### Usuarios Existentes

**Datos actuales:**
- Conversaciones: filtradas por userId
- Contextos: filtrados por userId
- Cada usuario ve SOLO sus datos

**Despu√©s de migraci√≥n:**
- Conversaciones: filtradas por domain (todos en dominio las ven)
- Contextos: filtrados por domain (todos en dominio los ven)
- Agentes: filtrados por userId + compartici√≥n

**Impacto:**
- ‚ö†Ô∏è Usuarios del mismo dominio ver√°n datos de otros usuarios
- ‚ö†Ô∏è Posible confusi√≥n si no se comunica bien
- ‚úÖ Pero es el comportamiento deseado (compartici√≥n por dominio)

---

## üéØ Ejemplo Completo

### Escenario: getaifactory.com con 3 usuarios

**Usuarios:**
- Alec (alec@getaifactory.com) - Admin
- Hello (hello@getaifactory.com) - User  
- Test (test@getaifactory.com) - User

---

**Alec crea:**
- Agente "Marketing Bot" (privado)
- Contexto "Producto X" (dominio)
- Conversaci√≥n "Plan Q1" (dominio)

**Estado inicial:**
```
Agentes:
‚îú‚îÄ Marketing Bot (Alec) 
‚îÇ  ‚îî‚îÄ Solo Alec lo ve ‚úÖ

Contextos del dominio:
‚îú‚îÄ Producto X (por Alec)
‚îÇ  ‚îî‚îÄ Alec, Hello, Test lo ven ‚úÖ

Conversaciones del dominio:
‚îú‚îÄ Plan Q1 (por Alec)
‚îÇ  ‚îî‚îÄ Alec, Hello, Test la ven ‚úÖ
```

---

**Alec comparte "Marketing Bot" con Hello:**
```
Agentes:
‚îú‚îÄ Marketing Bot (Alec)
‚îÇ  ‚îú‚îÄ Alec lo ve ‚úÖ
‚îÇ  ‚îú‚îÄ Hello lo ve ‚úÖ (compartido)
‚îÇ  ‚îî‚îÄ Test NO lo ve ‚ùå
```

---

**Admin crea Grupo "Marketing Team" con [Hello, Test]:**
```
Grupos:
‚îî‚îÄ Marketing Team (getaifactory.com)
   ‚îî‚îÄ members: [Hello, Test]
```

---

**Alec comparte "Marketing Bot" con grupo "Marketing Team":**
```
Agentes:
‚îú‚îÄ Marketing Bot (Alec)
‚îÇ  ‚îú‚îÄ Alec lo ve ‚úÖ (due√±o)
‚îÇ  ‚îú‚îÄ Hello lo ve ‚úÖ (grupo)
‚îÇ  ‚îî‚îÄ Test lo ve ‚úÖ (grupo)
```

---

**Usuario de otro dominio:**
```
Usuario D (user@salfacloud.cl):
‚îú‚îÄ NO ve Marketing Bot ‚ùå
‚îú‚îÄ NO ve Producto X ‚ùå
‚îú‚îÄ NO ve Plan Q1 ‚ùå
‚îî‚îÄ Ve solo recursos de salfacloud.cl
```

---

## ‚úÖ Confirmaci√≥n del Modelo

**Este es el modelo correcto seg√∫n tu descripci√≥n:**

### Por Usuario (Privado)
- ‚úÖ **Agentes** - Privados por defecto, compartici√≥n opcional

### Por Dominio (Compartido)
- ‚úÖ **Contextos** - Todos en dominio los ven
- ‚úÖ **Fuentes de Contexto** - Todos en dominio las ven  
- ‚úÖ **Conversaciones** - Todos en dominio las ven
- ‚úÖ **Configuraciones** - Por dominio

### Compartici√≥n
- ‚úÖ Solo dentro del mismo dominio
- ‚úÖ Por usuario espec√≠fico
- ‚úÖ Por grupo (admin crea grupos)
- ‚ùå NO cross-domain (ni usuario ni admin)

---

## üöÄ ¬øProcedo con la Implementaci√≥n?

**Confirma si este modelo es correcto:**

1. ‚úÖ Agentes privados por usuario (con compartici√≥n intra-dominio)
2. ‚úÖ Contextos/Conversaciones compartidos por dominio autom√°ticamente
3. ‚úÖ Grupos por dominio (admin crea, asigna usuarios)
4. ‚úÖ Compartici√≥n solo intra-dominio (nunca cross-domain)
5. ‚úÖ Admin NO puede compartir fuera del dominio

**Si es correcto, procedo a implementar todas las fases descritas arriba.**

