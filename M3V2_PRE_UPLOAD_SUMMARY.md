# üìä M3-v2 Upload - Pre-Execution Summary

**Date:** November 25, 2025  
**Agent:** GOP GPT (M3-v2)  
**Agent ID:** `vStojK73ZKbjNsEnqANJ`

---

## üìã **CURRENT STATE BEFORE UPLOAD**

### Agent M3-v2 Information
- **Name:** GOP GPT (M3-v2)
- **Owner:** usr_uhwqffaqag1wrryd82tw (alec@getaifactory.com)
- **Current Documents:** **1 document**

### Current Document List

| # | Document Name | Doc ID | RAG | Chunks |
|---|---------------|--------|-----|--------|
| 1 | GOP-P-PF-3.PROCESO PANEL FINANCIERO PROYECTOS AFECTOS-(V.1) (1).PDF | 1EnH6gTnM6a33W4aUeNp | Yes | 3 |

**Summary:**
- Total: 1 document
- RAG enabled: 1
- Total chunks: 3

---

## üì• **NEW DOCUMENTS TO UPLOAD**

### Upload Queue Location
```
/Users/alec/salfagpt/upload-queue/M3-v2-20251125/
```

### Document Count
**Total PDFs found:** **62 files**

### Document Breakdown by Category

#### 1. Primera carga de documentacion (30 files)

**Planificaci√≥n Inicial (1):**
- GOP-D-PI-1.PLANIFICACION INICIAL DE OBRA-(V.1) (1).PDF

**Plan de Calidad y Operaci√≥n (20):**
- Calidad y Operaci√≥n de Obra (13)
  - 6.5 MAQ-LOG-CBO-P-001 GESTION DE BODEGAS DE OBRAS REV.07.PDF
  - CONTRATACION DE SUBCONTRATISTAS.PDF
  - GOP-P-PCO-2.1.ANEXO RESUMEN REVISIONES MITO-(V.0).PDF
  - GOP-P-PCO-2.1.DETECCION DE HALLAZGOS Y NO CONFORMIDADES-(V.5).PDF
  - GOP-P-PCO-2.1.EVALUACION SUBCONTRATOS-(V.0).PDF
  - GOP-P-PCO-2.1.INSTRUCTIVO CALCULO DE STOCK CRITICO-(V.0).PDF
  - GOP-P-PCO-2.1.INSTRUCTIVO MODULADOR DE BODEGAS-(V.0).PDF
  - GOP-P-PCO-2.1.MATRIZ DE OBJETIVOS DE CONTROL DE OBRA-(V.0).PDF
  - GOP-P-PCO-2.1.PROCEDIMIENTO DE GESTION DE CONSTRUCCION EN OBRA-(V.2).PDF
  - GOP-P-PCO-2.1.PROCEDIMIENTO ENTREGA OBRA A POST VENTA-(V.0).PDF
  - GOP-P-PCO-2.1.PROCEDIMIENTO INICIO DE OBRAS DE EDIFICACION-(V.0).PDF
  - RESUMEN Y PREGUNTAS.docx.pdf

- Control Materiales y Ensayos (3)
  - GOP-P-PCO-2.2.PROCEDIMIENTO ELABORACION Y CONTROL CH-(V.0).PDF
  - GOP-P-PCO-2.2.TRAZABILIDAD, CERTIFICADOS Y ENSAYOS-(V.4)(1).PDF
  - GOP-P-PCO-2.2.TRAZABILIDAD, CERTIFICADOS Y ENSAYOS-(V.4).PDF

- Control de Documentos (1)
  - GOP-R-PCO-2.4.MINUTA_DE_REUNION-(V.0).DOCX.pdf

- Control Porter√≠a (1)
  - GOP-P-PCO-2.5.RESPONSABILIDADES EN PORTERIA-(V.0).PDF

- Root files (2)
  - GOP-D-PCO-2.PLAN DE CALIDAD Y OPERACION-(V.1).PDF
  - GOP-P-PCO-2.ELABORACION DE DOCUMENTOS-(V.0).PDF

**Panel Financiero (6):**
- 3.1 Anexos (4)
  - GOP-P-PF-3.1.ANEXO 1 MANO DE OBRA-(V.0).PDF
  - GOP-P-PF-3.1.ANEXO 2 MANO DE OBRA-(V.0).PDF
  - GOP-P-PF-3.1.ANEXO 3 EQUIPOS-(V.0).PDF
  - GOP-P-PF-3.1.ANEXO 4 EQUIPOS-(V.0).PDF

- Root (2)
  - GOP-P-PF-3.PROCESO PANEL FINANCIERO PROYECTOS AFECTOS-(V.1) (1).PDF ‚≠ê **MATCHES EXISTING**
  - GOP-P-PF-3.PROCESO PANEL FINANCIERO PROYECTOS EXENTOS-(V.1) (1).PDF

**Entorno Vecino (1):**
- GOP-P-EV-4.ENTORNO VECINOS Y RELACIONAMIENTO COMUNITARIO-(V.4).PDF

**Control de Etapa (1):**
- GOP-P-CE-5.PROCEDIMIENTO CONTROL DE ETAPA DS49-(V.0).PDF

**Duplicates (2):**
- GOP-D-PCO-2.PLAN DE CALIDAD Y OPERACION-(V.1).PDF (duplicate)
- GOP-P-PCO-2.ELABORACION DE DOCUMENTOS-(V.0).PDF (duplicate)

#### 2. Segunda carga de documentacion 19-11 (32 files)

**Planificaci√≥n Inicial (1):**
- GOP-D-PI-1.PLANIFICACION INICIAL DE OBRA-(V.2).pdf ‚≠ê **VERSION UPDATE (V.1‚ÜíV.2)**

**Plan de Calidad y Operaci√≥n (18):**
- Calidad y Operaci√≥n de Obra (9)
  - 6.5 MAQ-LOG-CBO-P-001 Gesti√≥n de Bodegas de Obras Rev.07.pdf
  - CONTRATACION DE SUBCONTRATISTAS.pdf
  - GOP-P-PCO-2.1.ANEXO RESUMEN REVISIONES MITO-(V.0).pdf
  - GOP-P-PCO-2.1.EVALUACION SUBCONTRATOS-(V.0).pdf
  - GOP-P-PCO-2.1.INSTRUCTIVO CALCULO DE STOCK CRITICO-(V.0).pdf
  - GOP-P-PCO-2.1.INSTRUCTIVO MODULADOR DE BODEGAS-(V.0).pdf
  - GOP-P-PCO-2.1.MATRIZ DE OBJETIVOS DE CONTROL DE OBRA-(V.0).pdf
  - GOP-P-PCO-2.1.MATRIZ DE RIESGOS Y OPORTUNIDADES.pdf ‚≠ê **NEW DOCUMENT**
  - GOP-P-PCO-2.1.PROCEDIMIENTO ENTREGA OBRA A POST VENTA-(V.0).pdf

- Control Materiales y Ensayos (2)
  - GOP-P-PCO-2.2.PROCEDIMIENTO ELABORACION Y CONTROL CH-(V.0).pdf
  - GOP-P-PCO-2.2.TRAZABILIDAD, CERTIFICADOS Y ENSAYOS-(V.4).pdf

- Control Porter√≠a (1)
  - GOP-P-PCO-2.5.RESPONSABILIDADES EN PORTERIA-(V.0).PDF

- **Pol√≠ticas Calidad (5)** ‚≠ê **NEW SECTION**
  - GOP-P-PCO-2.6.BRISAS DE BATUCO-(V.1).pdf
  - GOP-P-PCO-2.6.GEOMAR V-(V.1).pdf
  - GOP-P-PCO-2.6.NOVAL-(V.1).pdf
  - GOP-P-PCO-2.6.NOVATEC EDIFICIOS-(V.1).pdf
  - GOP-P-PCO-2.6.NOVATEC-(V.1).pdf

- Root (1)
  - GOP-D-PCO-2.PLAN DE CALIDAD Y OPERACION-(V.1).pdf

**Panel Financiero (8):**
- Root extra (1)
  - 20240222-BODEGA NEWS! NUEVO Paso a Paso MAQ-LOG-CBO-PP-019 MANEJO DE STOCK CR√çTICO-PEP NIVEL 4 (1).pdf ‚≠ê **NEW**

- 3.1 Anexos (4)
  - GOP-P-PF-3.1.ANEXO 1 MANO DE OBRA-(V.0).pdf
  - GOP-P-PF-3.1.ANEXO 2 MANO DE OBRA-(V.0).pdf
  - GOP-P-PF-3.1.ANEXO 3 EQUIPOS-(V.0).pdf
  - GOP-P-PF-3.1.ANEXO 4 EQUIPOS-(V.0).pdf

- Root (2)
  - GOP-D-PF-3.PROCESO PANEL FINANCIERO PROYECTOS AFECTOS-(V.1).pdf
  - GOP-D-PF-3.PROCESO PANEL FINANCIERO PROYECTOS EXENTOS-(V.1).pdf

**Entorno Vecino (2):**
- GOP-P-EV-4.ENTORNO VECINOS Y RELACIONAMIENTO COMUNITARIO-(V.4).pdf
- Presentacion Manual Relacionamiento Comunitario 2024 13-08.pdf ‚≠ê **NEW**

**Control de Etapa (1):**
- GOP-P-CE-5.PROCEDIMIENTO CONTROL DE ETAPA DS49-(V.0).pdf

**AFE Log√≠stica (1)** ‚≠ê **NEW CATEGORY**
- AFE Log y adm de bodega Rev 5.2.pdf

**Root files (2):**
- GOP-P-PCO-2.1.INSTRUCTIVO MODULADOR DE BODEGAS-(V.0) (2) (1) (1).pdf
- MAQ-LOG-CBO-PP-019 Manejo de Stock Cr√≠tico-PEP Nivel 4.pdf

---

## üîç **DOCUMENT ANALYSIS**

### Documents That Will Update Existing

**1 document match detected:**

| Existing Document | New Version | Action |
|-------------------|-------------|--------|
| GOP-P-PF-3.PROCESO PANEL FINANCIERO PROYECTOS AFECTOS-(V.1) (1).PDF | GOP-P-PF-3.PROCESO PANEL FINANCIERO PROYECTOS AFECTOS-(V.1) (1).PDF (Primera)<br>GOP-D-PF-3.PROCESO PANEL FINANCIERO PROYECTOS AFECTOS-(V.1).pdf (Segunda) | Keep all versions with different tags |

**Note:** The upload script uses `--skip-existing` flag, so if filename exactly matches, it will be skipped. Since filenames vary slightly (GOP-P vs GOP-D, .PDF vs .pdf), all versions will be uploaded.

### Truly New Documents

**New document categories:**
- Section 2.6: Pol√≠ticas Calidad (5 documents) ‚≠ê
- Section 6: AFE Log√≠stica (1 document) ‚≠ê
- GOP-P-PCO-2.1.MATRIZ DE RIESGOS Y OPORTUNIDADES.pdf ‚≠ê
- Presentacion Manual Relacionamiento Comunitario 2024 13-08.pdf ‚≠ê
- 20240222-BODEGA NEWS! NUEVO Paso a Paso... ‚≠ê

**Estimated truly new:** ~9 documents  
**Duplicates/versions:** ~53 documents

---

## üìç **EXPECTED FINAL STATE AFTER UPLOAD**

### Documents Assigned to M3-v2

| Metric | Before | After | Change |
|--------|--------|-------|--------|
| **Total Documents** | 1 | 63 | **+62 (+6,200%)** |
| **RAG-Enabled** | 1 | 63 | +62 |
| **Total Chunks** | 3 | ~313-623 | **+310-620 (+10,333%)** |
| **Embeddings** | 3 | ~313-623 | +310-620 |

### Infrastructure Distribution

**GCS Storage (us-east4):**
- Bucket: `salfagpt-context-documents`
- Path pattern: `usr_uhwqffaqag1wrryd82tw/vStojK73ZKbjNsEnqANJ/*.pdf`
- Expected files: 62 new PDFs

**Firestore (us-central1):**
- Collection: `context_sources`
- New documents: 62
- Collection: `document_chunks`
- New chunks: ~310-620

**BigQuery (us-east4):**
- Dataset: `flow_analytics_east4` ‚úÖ (optimized region)
- Table: `document_embeddings`
- New rows: ~310-620
- Vector index: COSINE similarity

---

## üéØ **UPLOAD PIPELINE VERIFICATION**

### System Configuration

‚úÖ **Project:** salfagpt  
‚úÖ **GCS Region:** us-east4 (Cloud Storage bucket)  
‚úÖ **Firestore Region:** us-central1 (metadata)  
‚úÖ **BigQuery Region:** us-east4 (`flow_analytics_east4` dataset exists)  
‚úÖ **Cloud Run Region:** us-east4 (production app)

### Pipeline Steps Confirmed

For each of 62 PDFs, the system will:

**1. Upload to GCS**
```
Location: gs://salfagpt-context-documents/usr_uhwqffaqag1wrryd82tw/vStojK73ZKbjNsEnqANJ/{filename}
Region: us-east4
```

**2. Extract with Gemini**
```
Model: gemini-2.5-flash (cost-effective)
API: Google AI Studio API
Output: Full text extraction
```

**3. Save to Firestore**
```
Project: salfagpt
Collection: context_sources
Region: us-central1
Fields:
  - userId: usr_uhwqffaqag1wrryd82tw
  - assignedToAgents: ['vStojK73ZKbjNsEnqANJ']
  - tags: ['M3-v2-20251125']
  - extractedData: [full text]
  - originalFileUrl: [GCS path]
  - ragEnabled: true
  - status: 'active'
```

**4. Chunk Text**
```
Strategy: Semantic chunking by paragraphs
Chunk size: ~1000 tokens
Collection: document_chunks
Region: us-central1 (Firestore)
```

**5. Generate Embeddings**
```
Model: text-embedding-004
Dimensions: 768
API: Google AI Studio Embedding API
Collection: document_chunks (stores embedding array)
```

**6. Index in BigQuery**
```
Project: salfagpt
Dataset: flow_analytics_east4 (or flow_rag_optimized)
Table: document_embeddings (or document_chunks_vectorized)
Region: us-east4
Vector Index: COSINE similarity
```

**7. Activate in Agent**
```
Update: conversations/{agentId}
Field: activeContextSourceIds (append new source IDs)
Result: All documents available for chat
```

---

## ‚öôÔ∏è **CONFIGURATION CHECK**

### Current BigQuery Configuration

Based on codebase analysis, the system can use either:

**Option A: flow_analytics_east4.document_embeddings**
- Dataset: `flow_analytics_east4`
- Table: `document_embeddings`
- Region: ‚úÖ us-east4
- Used by: `bigquery-optimized.ts`, `bigquery-agent-search.ts` (with env flag)

**Option B: flow_rag_optimized.document_chunks_vectorized**
- Dataset: `flow_rag_optimized`
- Table: `document_chunks_vectorized`
- Region: ‚ö†Ô∏è us-central1 (not optimal)
- Used by: `bigquery-vector-search.ts`

### Active Configuration

The CLI upload command uses:
```typescript
// cli/lib/embeddings.ts line 332
const { syncChunksBatchToBigQuery } = await import('../../src/lib/bigquery-vector-search.js');
```

This imports from `bigquery-vector-search.ts` which uses:
- **Dataset:** `flow_rag_optimized`
- **Region:** us-central1 ‚ö†Ô∏è

### ‚ö†Ô∏è **ISSUE IDENTIFIED**

The current CLI uses `flow_rag_optimized` in **us-central1**, but the optimal configuration is `flow_analytics_east4` in **us-east4** (same region as Cloud Run).

**Impact:**
- Additional cross-region latency (~100-200ms per query)
- Works fine, just not optimal

**Recommendation:**
- For now: Proceed with upload (system works fine)
- Future: Update CLI to use `flow_analytics_east4` for optimal performance

---

## üí∞ **COST ESTIMATE**

### Per Document Average
- **Gemini Extraction:** ~$0.001-0.005 (Flash model, depends on size)
- **Embeddings:** ~$0.0001-0.0005 per chunk (~5-10 chunks)
- **Total per doc:** ~$0.0015-0.0055

### Total for 62 Documents
| Item | Estimated Cost |
|------|---------------|
| Gemini Extraction (62 docs) | $0.062 - $0.310 |
| Embeddings (~310-620 chunks) | $0.006 - $0.031 |
| **Total** | **$0.068 - $0.341** |

**Storage costs:**
- GCS: ~$0.02/GB/month (negligible for PDFs)
- BigQuery: First 10GB free
- Firestore: First 1GB free

**Expected total cost:** **< $0.50**

---

## ‚è±Ô∏è **TIME ESTIMATE**

### Per Document Processing Time
- Upload to GCS: ~2-5s
- Gemini extraction: ~10-30s (varies by PDF size/complexity)
- Firestore save: ~1-2s
- Chunking: ~2-5s
- Embedding generation: ~1-2s per chunk (batch optimized)
- BigQuery sync: ~1-2s
- **Total per doc:** ~30-60s

### Total for 62 Documents
- **Sequential:** 31-62 minutes
- **With rate limiting delays:** 40-70 minutes
- **Expected:** ~50 minutes

---

## ‚úÖ **WHAT NEEDS TO HAPPEN**

### Infrastructure Verification (Pre-Upload)

- [x] GCloud authentication working
- [x] Project set to `salfagpt`
- [x] GCS bucket exists: `salfagpt-context-documents`
- [x] Firestore accessible
- [x] BigQuery dataset exists (either option works)
- [x] Upload folder exists with 62 PDFs
- [x] Agent exists and is accessible

### Upload Execution

- [ ] Run upload script: `./upload-m3v2-docs.sh`
- [ ] Monitor progress (40-70 minutes)
- [ ] Verify no errors during upload
- [ ] All 62 files processed successfully

### Post-Upload Verification

- [ ] Check Firestore: 63 documents total (1 existing + 62 new)
- [ ] Check BigQuery: ~313-623 new chunk rows
- [ ] Check GCS: 62 PDF files in bucket
- [ ] Check agent activeContextSourceIds: All new docs included
- [ ] Test RAG search: Returns relevant results
- [ ] Test in UI: All documents visible in M3-v2 agent
- [ ] Test in CLI: Query returns good responses

---

## üöÄ **EXECUTION COMMAND**

To execute the upload:

```bash
./upload-m3v2-docs.sh
```

This will:
1. Verify prerequisites
2. Show configuration
3. Ask for confirmation
4. Execute upload
5. Show summary
6. Provide verification commands

**Alternative (direct command):**
```bash
npx tsx cli/commands/upload.ts \
  --folder=/Users/alec/salfagpt/upload-queue/M3-v2-20251125 \
  --tag=M3-v2-20251125 \
  --agent=vStojK73ZKbjNsEnqANJ \
  --user=usr_uhwqffaqag1wrryd82tw \
  --email=alec@getaifactory.com \
  --model=gemini-2.5-flash \
  --skip-existing
```

---

## üìä **EXPECTED OUTCOME SUMMARY**

### Before Upload
```
M3-v2 Agent:
  Documents: 1
  Chunks: 3
  Coverage: Panel Financiero only
```

### After Upload
```
M3-v2 Agent:
  Documents: 63 (+62)
  Chunks: ~313-623 (+310-620)
  Coverage: 
    ‚úÖ Planificaci√≥n Inicial
    ‚úÖ Plan de Calidad y Operaci√≥n
    ‚úÖ Control Materiales y Ensayos
    ‚úÖ Control de Documentos
    ‚úÖ Control Porter√≠a
    ‚úÖ Pol√≠ticas Calidad (NEW)
    ‚úÖ Panel Financiero
    ‚úÖ Entorno Vecino
    ‚úÖ Control de Etapa
    ‚úÖ AFE Log√≠stica (NEW)
```

### Agent Capabilities After Upload

The GOP GPT (M3-v2) agent will be able to answer questions about:
- ‚úÖ Initial planning procedures
- ‚úÖ Quality and operations management
- ‚úÖ Materials control and testing
- ‚úÖ Document control
- ‚úÖ Site gate control
- ‚úÖ Quality policies for different projects
- ‚úÖ Financial panel processes (both exempt and affected)
- ‚úÖ Community relations
- ‚úÖ Stage control (DS49)
- ‚úÖ Logistics and warehouse administration

---

## üîÑ **ROLLBACK PLAN**

If issues arise during or after upload:

### Immediate Rollback
```bash
# Delete all documents with tag M3-v2-20251125
npx tsx -e "
import { firestore } from './src/lib/firestore.js';
const snapshot = await firestore.collection('context_sources')
  .where('tags', 'array-contains', 'M3-v2-20251125')
  .get();
console.log(\`Found \${snapshot.size} documents to delete\`);
const batch = firestore.batch();
snapshot.docs.forEach(doc => batch.delete(doc.ref));
await batch.commit();
console.log('Deleted');
process.exit(0);
"
```

### Selective Removal
Remove specific problematic documents by ID if needed.

---

## üìã **VERIFICATION CHECKLIST**

After upload completes, verify:

### Firestore
- [ ] 63 total documents in `context_sources` for this agent
- [ ] All have `assignedToAgents: ['vStojK73ZKbjNsEnqANJ']`
- [ ] All have `ragEnabled: true`
- [ ] All have tag `'M3-v2-20251125'`
- [ ] Metadata complete (extraction info, GCS URLs, etc.)

### BigQuery
- [ ] ~310-620 new rows in embeddings table
- [ ] All rows have `user_id: 'usr_uhwqffaqag1wrryd82tw'`
- [ ] All embeddings are 768-dimensional arrays
- [ ] Text preview populated
- [ ] Full text populated

### GCS
- [ ] 62 PDF files in bucket
- [ ] Path structure: `usr_uhwqffaqag1wrryd82tw/vStojK73ZKbjNsEnqANJ/*.pdf`
- [ ] All files accessible
- [ ] Metadata tags correct

### Agent Functionality
- [ ] Agent `activeContextSourceIds` updated
- [ ] Test query returns relevant chunks
- [ ] RAG search latency < 2s
- [ ] UI shows all 63 documents
- [ ] All documents toggleable in UI
- [ ] Chat responses reference new documents

---

## üéØ **SUCCESS CRITERIA**

Upload is considered successful when:

1. ‚úÖ All 62 PDFs uploaded (0 failures)
2. ‚úÖ All extractions successful
3. ‚úÖ All documents have RAG enabled
4. ‚úÖ Total chunks: 310-620 range
5. ‚úÖ All embeddings in BigQuery
6. ‚úÖ Total cost < $0.50
7. ‚úÖ Completion time < 90 minutes
8. ‚úÖ Test query returns relevant results
9. ‚úÖ UI shows all documents correctly
10. ‚úÖ No errors in logs

---

**Ready for execution:** ‚úÖ  
**Prerequisites met:** ‚úÖ  
**Command:** `./upload-m3v2-docs.sh`

**‚è∞ Estimated completion:** 50-60 minutes from start  
**üí∞ Estimated cost:** $0.10-0.30


