---
import ChatInterface from '../components/ChatInterface.tsx';
import { verifyJWT } from '../lib/auth';
import '../styles/global.css';

// Check authentication
const cookies = Astro.cookies;
const token = cookies.get('flow_session')?.value;

// For development: allow test user without authentication
const isDevelopment = import.meta.env.DEV;
let userId: string;

if (isDevelopment && !token) {
  // Development mode: use test user
  userId = 'test-user-dev-123';
  console.log('ðŸ”§ Development mode: Using test user ID:', userId);
} else if (!token) {
  // Production: require authentication, preserve current URL
  return Astro.redirect('/auth/login?redirect=/chat');
} else {
  // Verify token
  try {
    const decoded = verifyJWT(token);
    userId = decoded.sub || decoded.id;
  } catch (error) {
    // Token invalid, redirect to login with current URL
    return Astro.redirect('/auth/login?redirect=/chat');
  }
}
---

<!DOCTYPE html>
<html lang="en" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat - Flow</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  </head>
  <body class="h-full m-0 p-0">
    <ChatInterface client:only="react" userId={userId} />
  </body>
</html>
