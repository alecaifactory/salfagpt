---
import ChatInterface from '../components/ChatInterface';
import { verifyJWT } from '../lib/auth';

// Check authentication
const cookies = Astro.cookies;
const token = cookies.get('auth_token')?.value;

// For development: allow test user without authentication
const isDevelopment = import.meta.env.DEV;
let userId: string;

if (isDevelopment && !token) {
  // Development mode: use test user
  userId = 'test-user-dev-123';
  console.log('ðŸ”§ Development mode: Using test user ID:', userId);
} else if (!token) {
  // Production: require authentication
  return Astro.redirect('/auth/login');
} else {
  // Verify token
  try {
    const decoded = verifyJWT(token);
    userId = decoded.sub || decoded.id;
  } catch (error) {
    return Astro.redirect('/auth/login');
  }
}
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat - SalfaGPT</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  </head>
  <body>
    <ChatInterface client:only="react" userId={userId} />
  </body>
</html>

<style is:global>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  html,
  body {
    height: 100%;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell,
      'Open Sans', 'Helvetica Neue', sans-serif;
  }

  /* Custom scrollbar */
  ::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }

  ::-webkit-scrollbar-track {
    background: #f1f5f9;
  }

  ::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 4px;
  }

  ::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
  }

  /* Animation delays for loading dots */
  .delay-100 {
    animation-delay: 0.1s;
  }

  .delay-200 {
    animation-delay: 0.2s;
  }
</style>
