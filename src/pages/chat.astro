---
import ChatInterfaceWorking from '../components/ChatInterfaceWorking.tsx';
import ChatContainerV2 from '../components/chat-v2/ChatContainer.tsx';
import { verifyJWT } from '../lib/auth';
import { isUserDomainEnabled, getDomainFromEmail } from '../lib/domains';
import '../styles/global.css';

// Prevent caching to avoid serving stale HTML with old CSS references
Astro.response.headers.set('Cache-Control', 'no-cache, no-store, must-revalidate');
Astro.response.headers.set('Pragma', 'no-cache');
Astro.response.headers.set('Expires', '0');

// ‚úÖ FEATURE FLAG: Toggle Chat V2
const USE_CHAT_V2 = false; // Reverted to V1B (Optimized V1) - V2 needs 157 features ported

// üîí SECURITY: Always require authentication
const cookies = Astro.cookies;
const token = cookies.get('flow_session')?.value;

// Log authentication attempt
console.log('üîê Authentication check:', {
  hasToken: !!token,
  timestamp: new Date().toISOString(),
  path: '/chat'
});

// No token = redirect to login
if (!token) {
  console.warn('‚ö†Ô∏è Unauthorized access attempt to /chat - no token');
  return Astro.redirect('/auth/login?error=unauthorized&redirect=/chat');
}

// Verify token
let userId: string;
let userEmail: string;
let userName: string;

let userRole: string;

try {
  const decoded = verifyJWT(token);
  
  if (!decoded) {
    console.warn('‚ö†Ô∏è Invalid JWT token');
    return Astro.redirect('/auth/login?error=session_expired&redirect=/chat');
  }
  
  // ‚úÖ CRITICAL FIX: ALWAYS use hashed ID (decoded.id) for consistency
  // Data in Firestore is stored with hashed IDs (usr_xxx format)
  // Keep googleUserId in JWT for reference but use hashed ID for all queries
  userId = decoded.id; // ALWAYS use hashed ID
  userEmail = decoded.email || 'usuario@flow.ai';
  userName = decoded.name || decoded.email?.split('@')[0] || 'Usuario';
  userRole = decoded.role || 'user'; // ‚úÖ Extract role from JWT
  
  console.log('üîç DEBUG userId selection:', {
    hashedId: decoded.id,
    googleUserId: decoded.googleUserId,
    selected: userId,
    email: userEmail
  });
  
  // Log successful authentication
  console.log('‚úÖ User authenticated:', {
    userId: userId.substring(0, 8) + '...',
    email: userEmail,
    role: userRole,
    timestamp: new Date().toISOString()
  });
  
  // üîí CRITICAL Security: Verify domain is still enabled
  // (In case domain was disabled after user logged in)
  const isDomainEnabled = await isUserDomainEnabled(userEmail);
  
  if (!isDomainEnabled) {
    const userDomain = getDomainFromEmail(userEmail);
    console.warn('üö® Access denied - domain disabled for active session:', {
      email: userEmail,
      domain: userDomain,
      timestamp: new Date().toISOString(),
    });
    
    // Clear session and redirect to login with error
    cookies.delete('flow_session', { path: '/' });
    return Astro.redirect(`/auth/login?error=domain_disabled&domain=${encodeURIComponent(userDomain)}`);
  }
  
  console.log('‚úÖ Domain access verified for active session:', {
    email: userEmail,
    domain: getDomainFromEmail(userEmail),
  });
} catch (error) {
  // Token invalid or expired
  console.error('‚ùå JWT verification failed:', error instanceof Error ? error.message : 'Unknown error');
  return Astro.redirect('/auth/login?error=session_expired&redirect=/chat');
}
---

<!DOCTYPE html>
<html lang="es" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" content="notranslate" />
    <link rel="stylesheet" href="/_tailwind-compiled.css" />
    <title>Chat - Flow</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    
    <!-- üöÄ Cache Busting: Force browser to reload JavaScript on changes -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    
    <!-- DIAGNOSTIC: Log ALL errors to find root cause -->
    <script is:inline>
      // Enhanced error logging for debugging
      const originalError = console.error;
      const originalWarn = console.warn;
      
      console.error = function(...args) {
        console.log('üîç CONSOLE.ERROR CAPTURED:', args);
        originalError.apply(console, args);
      };
      
      console.warn = function(...args) {
        console.log('‚ö†Ô∏è CONSOLE.WARN CAPTURED:', args);
        originalWarn.apply(console, args);
      };
      
      console.log('‚úÖ Enhanced error logging active');
    </script>
    
    <!-- Theme initialization script - runs BEFORE page renders to prevent FOUC -->
    <script is:inline>
      (function() {
        // Try to load theme from localStorage first (instant)
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
        
        // Then load from Firestore and update if different
        // This happens async after initial render
        const userId = '${userId}'; // Template literal with Astro variable
        if (userId && userId !== '\${userId}') {
          fetch(`/api/user-settings?userId=${userId}`)
            .then(r => r.ok ? r.json() : null)
            .then(data => {
              if (data && data.theme) {
                const firestoreTheme = data.theme;
                // Only update if different from localStorage
                if (savedTheme !== firestoreTheme) {
                  localStorage.setItem('theme', firestoreTheme);
                  if (firestoreTheme === 'dark') {
                    document.documentElement.classList.add('dark');
                  } else {
                    document.documentElement.classList.remove('dark');
                  }
                }
              }
            })
            .catch(() => {
              // Fallback to light on error
              if (!savedTheme) {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('theme', 'light');
              }
            });
        }
      })();
    </script>
    
    <!-- üöÄ Performance Monitoring -->
    <script src="/performance-monitor.js" is:inline></script>
  </head>
  <body class="h-full m-0 p-0">
    <!-- üöÄ VERSION-BASED SESSION REFRESH: Check server version and refresh session on deployment -->
    <script is:inline>
      (async function checkVersionAndRefreshSession() {
        try {
          // 1. Get current server version
          const response = await fetch('/api/version');
          if (!response.ok) {
            console.warn('‚ö†Ô∏è Could not check server version');
            return;
          }
          
          const serverInfo = await response.json();
          const serverBuildId = serverInfo.buildId; // e.g., "0.1.0-a1b2c3d"
          const cachedBuildId = localStorage.getItem('app_build_id');
          
          // 2. Check if version changed
          if (cachedBuildId && cachedBuildId !== serverBuildId) {
            console.log('üîÑ NEW VERSION DEPLOYED - Refreshing session...');
            console.log('   Old build:', cachedBuildId);
            console.log('   New build:', serverBuildId);
            
            // 3. Refresh session cookie before reload
            console.log('   üìù Step 1/2: Refreshing session cookie...');
            const refreshResponse = await fetch('/api/auth/refresh-session', {
              method: 'POST',
              credentials: 'include', // Include cookies
            });
            
            if (refreshResponse.ok) {
              const refreshData = await refreshResponse.json();
              console.log('   ‚úÖ Session refreshed:', refreshData);
              
              // Log if role changed during refresh
              if (refreshData.roleChanged) {
                console.log('   üé≠ Role updated:', refreshData.oldRole, '‚Üí', refreshData.newRole);
              }
            } else {
              console.warn('   ‚ö†Ô∏è Session refresh failed, continuing with cache clear...');
            }
            
            // 4. Update cached version
            localStorage.setItem('app_build_id', serverBuildId);
            
            // 5. Force hard reload to get fresh JavaScript
            console.log('   üöÄ Step 2/2: Forcing hard reload...');
            console.log('   This ensures you get the latest code and features.');
            
            // Small delay to ensure cookie is set
            setTimeout(() => {
              location.reload(true);
            }, 500);
            
          } else if (!cachedBuildId) {
            // First time - just cache the version
            console.log('üì¶ First load - caching build ID:', serverBuildId);
            localStorage.setItem('app_build_id', serverBuildId);
          } else {
            // Same version - no action needed
            console.log('‚úÖ Running latest version:', serverBuildId);
          }
          
        } catch (error) {
          console.error('‚ùå Version check failed:', error);
          // Don't block app if version check fails
        }
      })();
    </script>
    
    <!-- CHAT V2: Fully Functional - Complete Rebuild -->
    {USE_CHAT_V2 ? (
      <ChatContainerV2
        client:only="react"
        userId={userId}
        userEmail={userEmail}
        userName={userName}
        userRole={userRole}
      />
    ) : (
      <ChatInterfaceWorking 
        client:only="react"
        userId={userId}
        userEmail={userEmail}
        userName={userName}
        userRole={userRole}
      />
    )}
  </body>
</html>
