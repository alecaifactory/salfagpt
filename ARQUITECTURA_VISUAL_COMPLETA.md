# ğŸ—ï¸ Arquitectura Visual Completa - SALFAGPT RAG System

**Proyecto:** salfagpt  
**RegiÃ³n:** us-east4  
**Fecha:** 24 noviembre 2025

---

## ğŸ“Š **DIAGRAMA ASCII COMPLETO:**

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                        SALFAGPT RAG ARCHITECTURE                             â•‘
â•‘                         (us-east4 OPTIMIZED)                                 â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STAGE 1: LOCAL UPLOAD QUEUE                                                  â”‚
â”‚ Location: /Users/alec/salfagpt/upload-queue/                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ“ S001-20251118/ (74 files)          â†’ S1-v2 (GestiÃ³n Bodegas)
   â”œâ”€ MAQ-LOG-CBO-I-001.pdf
   â”œâ”€ MAQ-LOG-CT-P-001.pdf
   â””â”€ Paso a Paso *.pdf

ğŸ“ S002-20251118/ (101 files)         â†’ S2-v2 (Maqsa Mantenimiento) âœ… DEMO
   â”œâ”€ DocumentaciÃ³n/
   â”‚   â”œâ”€ CAMION PLUMA/ (77 PDFs)
   â”‚   â”‚   â”œâ”€ Hiab/ (38 manuales)
   â”‚   â”‚   â”œâ”€ Scania/ (7 manuales)
   â”‚   â”‚   â”œâ”€ International/ (5 manuales)
   â”‚   â”‚   â”œâ”€ Volvo/ (30 manuales)
   â”‚   â”‚   â””â”€ Ford, Iveco, Palfinger...
   â”‚   â””â”€ Segunda Carga/ (9 PDFs)
   â””â”€ Excel/Word (3 archivos)

ğŸ“ M001-20251118/ (633 files)         â†’ M1-v2 (Legal Territorial)
   â””â”€ Documentos legales

ğŸ“ M003-20251119/ (77 files)          â†’ M3-v2 (GOP GPT)
   â””â”€ Documentos operacionales

         â”‚
         â”‚ CLI Upload / Web Upload
         â†“

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STAGE 2: EXTRACTION & STORAGE                                                â”‚
â”‚ Service: Gemini 2.5 Flash / File API                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   SIZE ROUTING      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€ < 10 MB â†’ Gemini Inline Data (rÃ¡pido)
         â”œâ”€ 10-50 MB â†’ Gemini File API REST
         â””â”€ > 50 MB â†’ PDF Split + File API

         â†“
         
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FIRESTORE (Global Multi-Region)                            â”‚
â”‚  Project: salfagpt                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  ğŸ“„ context_sources (2,482 docs)                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ {                                                     â”‚ â”‚
â”‚  â”‚   id: "060V7irmRJvwRNXgkQTJ",                         â”‚ â”‚
â”‚  â”‚   name: "Manual Camion Retarder.pdf",                 â”‚ â”‚
â”‚  â”‚   userId: "usr_uhwqffaqag1wrryd82tw",                 â”‚ â”‚
â”‚  â”‚   type: "pdf",                                        â”‚ â”‚
â”‚  â”‚   extractedData: "texto completo..." (500KB max),     â”‚ â”‚
â”‚  â”‚   metadata: {                                         â”‚ â”‚
â”‚  â”‚     storagePath: "gs://...-east4/...",               â”‚ â”‚
â”‚  â”‚     originalFileSize: 4536000,                       â”‚ â”‚
â”‚  â”‚     model: "gemini-2.5-flash",                       â”‚ â”‚
â”‚  â”‚     charactersExtracted: 4536                        â”‚ â”‚
â”‚  â”‚   }                                                   â”‚ â”‚
â”‚  â”‚ }                                                     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                             â”‚
â”‚  ğŸ¤– conversations (4 agents)                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ S2-v2: {                                              â”‚ â”‚
â”‚  â”‚   id: "1lgr33ywq5qed67sqCYi",                         â”‚ â”‚
â”‚  â”‚   title: "Maqsa Mantenimiento (S2-v2)",               â”‚ â”‚
â”‚  â”‚   userId: "usr_uhwqffaqag1wrryd82tw",                 â”‚ â”‚
â”‚  â”‚   activeContextSourceIds: [467 IDs],                  â”‚ â”‚
â”‚  â”‚   agentPrompt: "Eres el Asistente..."                 â”‚ â”‚
â”‚  â”‚ }                                                     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                             â”‚
â”‚  ğŸ”— agent_sources (6,564 assignments)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ {                                                     â”‚ â”‚
â”‚  â”‚   agentId: "1lgr33ywq5qed67sqCYi",                    â”‚ â”‚
â”‚  â”‚   sourceId: "060V7irmRJvwRNXgkQTJ",                   â”‚ â”‚
â”‚  â”‚   userId: "usr_uhwqffaqag1wrryd82tw"                  â”‚ â”‚
â”‚  â”‚ }                                                     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                             â”‚
â”‚  ğŸ‘¤ users (Access Control)                                  â”‚
â”‚  â””â”€ usr_uhwqffaqag1wrryd82tw: { role: "admin" }            â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                              â”‚
           â”‚ PDF Storage                  â”‚ Metadata/Assignments
           â†“                              â†“

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CLOUD STORAGE (us-east4) âš¡        â”‚   â”‚  STAGE 3: CHUNKING              â”‚
â”‚  Bucket: ...-east4                  â”‚   â”‚  Process: Backend               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚   â”‚                                 â”‚
â”‚ usr_uhwqffaqag1wrryd82tw/           â”‚   â”‚ extractedData                   â”‚
â”‚ â”œâ”€ iQmdg3bMSJ1AdqqlFpye/           â”‚   â”‚   â†“                             â”‚
â”‚ â”‚  â”œâ”€ MAQ-LOG-CBO-I-001.pdf        â”‚   â”‚ Split: 500 tokens, 50 overlap   â”‚
â”‚ â”‚  â”œâ”€ MAQ-LOG-CT-P-001.pdf         â”‚   â”‚   â†“                             â”‚
â”‚ â”‚  â””â”€ ... (74 files)               â”‚   â”‚ Chunks: [                       â”‚
â”‚ â”‚                                   â”‚   â”‚   { text, index, pos },         â”‚
â”‚ â”œâ”€ 1lgr33ywq5qed67sqCYi/           â”‚   â”‚   ...                           â”‚
â”‚ â”‚  â”œâ”€ Manual Scania P450.pdf  â†â”€â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â†’ ~40 chunks/doc               â”‚
â”‚ â”‚  â”œâ”€ Manual Hiab 422.pdf          â”‚   â”‚ ]                               â”‚
â”‚ â”‚  â””â”€ ... (305 files)              â”‚   â”‚                                 â”‚
â”‚ â”‚                                   â”‚   â”‚ Average: 40 chunks/doc          â”‚
â”‚ â”œâ”€ EgXezLcu4O3IUqFUJhUZ/           â”‚   â”‚                                 â”‚
â”‚ â”‚  â””â”€ ... (~400 files)             â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ â””â”€ vStojK73ZKbjNsEnqANJ/                           â”‚
â”‚    â””â”€ ... (~50 files)                              â”‚
â”‚                                                     â†“
â”‚ Total: 823 archivos (1.66 GiB)          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Region: us-east4 âš¡                     â”‚  STAGE 4: EMBEDDING              â”‚
â”‚                                          â”‚  Model: text-embedding-004       â”‚
â”‚ ğŸ“¦ ORIGINAL PDF FILES                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                  â”‚
                                           â”‚ For each chunk:                  â”‚
                                           â”‚   â†“                              â”‚
                                           â”‚ Gemini API                       â”‚
                                           â”‚   â†“                              â”‚
                                           â”‚ Vector: 768 floats FIJO          â”‚
                                           â”‚ [0.123, -0.456, ...]             â”‚
                                           â”‚   â†“                              â”‚
                                           â”‚ Cost: $0.00001/chunk             â”‚
                                           â”‚                                  â”‚
                                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                        â”‚
                                                        â†“

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STAGE 5: BIGQUERY VECTOR STORE (us-east4) âš¡âš¡âš¡                             â”‚
â”‚  Dataset: flow_analytics_east4                                               â”‚
â”‚  Table: document_embeddings                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Schema:                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ chunk_id     STRING                                                    â”‚ â”‚
â”‚  â”‚ source_id    STRING       â† Links to Firestore context_sources        â”‚ â”‚
â”‚  â”‚ user_id      STRING       â† Access control                            â”‚ â”‚
â”‚  â”‚ chunk_index  INTEGER      â† Position in document                      â”‚ â”‚
â”‚  â”‚ text_preview STRING       â† First 500 chars                           â”‚ â”‚
â”‚  â”‚ full_text    STRING       â† Complete chunk text                       â”‚ â”‚
â”‚  â”‚ embedding    FLOAT64[768] â† âš¡ FIXED LENGTH for IVF index            â”‚ â”‚
â”‚  â”‚ metadata     JSON         â† { source_name, token_count, positions }   â”‚ â”‚
â”‚  â”‚ created_at   TIMESTAMP    â† Partitioning key                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                              â”‚
â”‚  Data:                                                                       â”‚
â”‚  â”œâ”€ 61,564 chunks total                                                     â”‚
â”‚  â”œâ”€ 2,366 sources                                                           â”‚
â”‚  â”œâ”€ S2-v2: ~20,100 chunks (filtrados)                                       â”‚
â”‚  â””â”€ All embeddings: 768 dims âœ…                                             â”‚
â”‚                                                                              â”‚
â”‚  Optimizations:                                                              â”‚
â”‚  âœ… Vector Index: IVF (1000 lists)                                          â”‚
â”‚  âœ… Distance: COSINE similarity                                             â”‚
â”‚  âœ… Location: us-east4 (same as Cloud Run)                                  â”‚
â”‚                                                                              â”‚
â”‚  Performance:                                                                â”‚
â”‚  âš¡ Search: 200-300ms (with IVF index)                                      â”‚
â”‚  âš¡ vs 600ms without index                                                  â”‚
â”‚  âš¡ vs 60s without agent filtering                                          â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â”‚ Vector Search
                             â†“

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STAGE 6: RAG SEARCH & RETRIEVAL                                             â”‚
â”‚  Location: Cloud Run (us-east4)                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  User Query: "Â¿Aceite hidrÃ¡ulico Scania P450?"                              â”‚
â”‚       â†“                                                                      â”‚
â”‚  1. Generate query embedding (768 dims)                  [~1s]              â”‚
â”‚       â†“                                                                      â”‚
â”‚  2. Get agent sources (S2-v2: 467 IDs)                   [cached, ~0ms]     â”‚
â”‚       â†“                                                                      â”‚
â”‚  3. BigQuery Vector Search:                              [~300ms] âš¡        â”‚
â”‚     ```sql                                                                   â”‚
â”‚     WITH similarities AS (                                                   â”‚
â”‚       SELECT                                                                 â”‚
â”‚         chunk_id, source_id, full_text,                                     â”‚
â”‚         -- Cosine similarity (IVF accelerated)                              â”‚
â”‚         COSINE_DISTANCE(embedding, @queryEmbedding) AS similarity           â”‚
â”‚       FROM `salfagpt.flow_analytics_east4.document_embeddings`              â”‚
â”‚       WHERE user_id = 'usr_uhwqffaqag1wrryd82tw'                            â”‚
â”‚         AND source_id IN UNNEST(@s2v2_467_sources)  â† Filtro agente        â”‚
â”‚     )                                                                        â”‚
â”‚     SELECT * FROM similarities                                              â”‚
â”‚     WHERE similarity >= 0.25                                                â”‚
â”‚     ORDER BY similarity DESC                                                â”‚
â”‚     LIMIT 8                                                                 â”‚
â”‚     ```                                                                      â”‚
â”‚       â†“                                                                      â”‚
â”‚  4. Top 8 chunks (76-84% similarity)                     [~0ms]             â”‚
â”‚       â†“                                                                      â”‚
â”‚  5. Format as context for Gemini                         [~0ms]             â”‚
â”‚     Context: "                                                              â”‚
â”‚       [1] Manual Mantenimiento Scania - Chunk 38:                           â”‚
â”‚       'CarrocerÃ­a Scania...aceite hidrÃ¡ulico...'                            â”‚
â”‚                                                                              â”‚
â”‚       [2] Manual Mantenimiento Scania - Chunk 11:                           â”‚
â”‚       'tiempo de funcionamiento...'                                         â”‚
â”‚     "                                                                        â”‚
â”‚       â†“                                                                      â”‚
â”‚  6. Gemini generates answer                              [~500ms]           â”‚
â”‚       â†“                                                                      â”‚
â”‚  7. Response with references                             [~0ms]             â”‚
â”‚     "El cambio de aceite hidrÃ¡ulico debe realizarse cada                    â”‚
â”‚      2000 horas segÃºn el Manual de Mantenimiento Scania [1]..."             â”‚
â”‚       â†“                                                                      â”‚
â”‚  TOTAL TIME: ~1.8s â†’ <1s with optimizations âš¡âš¡                            â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â”‚ User clicks reference [1]
                                â†“

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STAGE 7: DOCUMENT VIEWER                                                    â”‚
â”‚  API: GET /api/context-sources/[sourceId]/file                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  1. Load source from Firestore                           [~50ms]            â”‚
â”‚       â†“                                                                      â”‚
â”‚  2. Check storagePath                                                        â”‚
â”‚       â†“                                                                      â”‚
â”‚  IF has storagePath:                                                         â”‚
â”‚    â”œâ”€ Download from GCS east4                            [~150ms] âš¡        â”‚
â”‚    â”œâ”€ Stream PDF to browser                                                â”‚
â”‚    â””â”€ Open in modal with PDF viewer                                        â”‚
â”‚  ELSE:                                                                       â”‚
â”‚    â”œâ”€ Generate HTML from extractedData                   [~10ms]           â”‚
â”‚    â”œâ”€ Wrap in template                                                      â”‚
â”‚    â””â”€ Open in modal with HTML viewer                                        â”‚
â”‚       â†“                                                                      â”‚
â”‚  TOTAL TIME: ~200ms âš¡                                                      â”‚
â”‚                                                                              â”‚
â”‚  Features:                                                                   â”‚
â”‚  âœ… PDF native viewer                                                       â”‚
â”‚  âœ… Annotations (questions, highlights)                                     â”‚
â”‚  âœ… Share via Gmail                                                         â”‚
â”‚  âœ… Download PDF                                                            â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                          DATA FLOW SUMMARY                                    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Local File â†’ Extract â†’ Firestore â†’ GCS â†’ Chunk â†’ Embed â†’ BigQuery â†’ Search â†’ View
   (PDF)      (Text)   (Metadata)  (PDF)  (500t)  (768d)  (Index)   (RAG)   (Modal)
    885        2,482      2,482     823   61,564  61,564   IVF     <300ms   <200ms
```

---

## ğŸ—ºï¸ **DECISIONES DE ARQUITECTURA (Timeline):**

### **Octubre 2025 - v1.0:**
```
Decision: Usar Firestore para todo
RazÃ³n: Simplicidad inicial
Problema: BÃºsqueda lenta (120s)
```

### **14 Nov 2025 - v2.0:**
```
Decision: Migrar chunks a BigQuery
RazÃ³n: BÃºsqueda vectorial nativa en SQL
Mejora: 120s â†’ 10s (12x)
Problema: AÃºn lento sin Ã­ndice
```

### **20 Nov 2025 - v2.5:**
```
Decision: Filtrar por agente
RazÃ³n: Buscar solo chunks relevantes
Mejora: 10s â†’ 600ms (16x)
Problema: Cross-region latency
```

### **24 Nov 2025 - v3.0:**
```
Decision 1: Migrar a us-east4
RazÃ³n: Misma regiÃ³n que Cloud Run
Mejora: 600ms â†’ 300ms (2x)

Decision 2: Normalizar embeddings a 768
RazÃ³n: Permitir vector index IVF
Mejora: 300ms â†’ 200ms (1.5x)

Decision 3: Vector Index IVF
RazÃ³n: Acelerar bÃºsqueda con Ã­ndice
Mejora Final: 120s â†’ 200ms (600x) âš¡âš¡âš¡
```

---

## ğŸ“‹ **PRÃ“XIMOS PASOS PROPUESTOS:**

### **OptimizaciÃ³n Adicional:**
1. Clustering en tabla (user_id, source_id)
2. Partitioning por fecha
3. Cache de embeddings frecuentes
4. Warm-up queries para mantener Ã­ndice

### **Monitoreo:**
1. Dashboard de latencia por agente
2. Tracking de similarity promedio
3. Error rate por tipo de bÃºsqueda
4. Costos BigQuery por dÃ­a

### **Mejoras UX:**
1. Preview de chunk en hover
2. Highlight de texto relevante en PDF
3. NavegaciÃ³n entre referencias
4. History de bÃºsquedas

---

**ARQUITECTURA DOCUMENTADA COMPLETAMENTE** âœ…




